<html>

<head>
  <base target="_top">
  <meta charset="utf-8">

  <script src="GitHubAdapter.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>myDoc Clinic App</title>
  <style>
    :root {
      /* Corporate Blue preserved */
      --primary: #2370b8;
      --primary-dark: #1a5a96;
      --primary-light: #e0eefb;

      /* Modern Neutral Palette */
      --white: #ffffff;
      --bg-light: #f1f5f9;
      /* Slate-50/100ish - Cooler grey */
      --text-dark: #1e293b;
      /* Slate-800 - Softer black */
      --text-light: #64748b;
      /* Slate-500 */
      --border-color: #e2e8f0;
      /* Slate-200 */

      /* Functional Colors */
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #f59e0b;

      /* Depth & Effects */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius: 12px;
      /* Slightly softer corners */
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      font-family: 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--bg-light);
      color: var(--text-dark);
      font-size: 14px;
      line-height: 1.5;
    }

    /* --- Layout --- */
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      margin-left: 260px;
      /* Wider sidebar */
    }

    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: var(--white);
      padding: 0 1.5rem;
      height: 64px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
      z-index: 100;
      position: sticky;
      top: 0;
    }

    header h1 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: 0.025em;
    }

    .nav-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      display: none;
    }


    main {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
      background: var(--bg-light);
      margin-left: 0;
    }

    /* --- Navigation --- */
    .sidebar {
      position: fixed;
      left: 0;
      top: 64px;
      width: 260px;
      height: calc(100vh - 64px);
      background: linear-gradient(180deg, #2370b8 0%, #1557b0 100%);
      /* Brand Blue Gradient */
      /* border-right: 1px solid var(--border-color); Removed border */
      overflow-y: auto;
      z-index: 90;
      padding-top: 1rem;
      transition: transform 0.3s ease;
      box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      /* Added shadow */
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 0.85rem 1.5rem;
      color: rgba(255, 255, 255, 0.85);
      /* White text */
      text-decoration: none;
      cursor: pointer;
      border-left: none;
      /* Removed border-left style */
      transition: all 0.2s ease;
      font-weight: 500;
      margin: 4px 12px;
      /* Added horizontal margin */
      border-radius: 8px;
      /* Rounded corners */
    }

    .nav-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
      transform: translateX(2px);
    }

    .nav-item.active {
      background-color: white;
      color: #2370b8;
      /* Blue text */
      font-weight: 700;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* --- Components --- */
    .card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 255, 255, 0.5);
      transition: var(--transition);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .card h3,
    .card h4 {
      margin-top: 0;
      color: var(--text-dark);
      font-weight: 600;
      margin-bottom: 1.25rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.65rem 1.25rem;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: var(--transition);
      width: 100%;
      letter-spacing: 0.01em;
    }

    .btn-auto {
      width: auto;
    }

    table .btn {
      width: auto;
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }

    .btn-full {
      width: 100%;
    }

    .btn-primary {
      background-color: var(--primary);
      color: var(--white);
      box-shadow: 0 4px 6px -1px rgba(35, 112, 184, 0.4);
    }

    .btn-primary:hover {
      background-color: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 6px 8px -1px rgba(35, 112, 184, 0.5);
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-dark);
      font-weight: 500;
      font-size: 0.9rem;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem 1rem;
      background-color: #f8fafc;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      font-size: 0.95rem;
      color: var(--text-dark);
      transition: var(--transition);
    }

    .form-control:focus {
      background-color: var(--white);
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(35, 112, 184, 0.15);
    }

    select.form-control {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      appearance: none;
      padding-right: 2.5rem;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }

    .table-responsive {
      overflow-x: auto;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
    }

    table {
      width: 100%;
      border-collapse: separate;
      /* For radius */
      border-spacing: 0;
      margin-top: 0;
    }

    th,
    td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    th {
      background-color: #f8fafc;
      font-weight: 600;
      color: var(--text-light);
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      position: sticky;
      top: 0;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr:nth-child(even) {
      background-color: #fafbfc;
    }

    tbody tr:hover {
      background-color: #f1f5f9;
    }

    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
      margin: 10px auto;
      display: none;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .view {
      display: none;
      animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .view.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }


    /* Mobile Optimization */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        width: 80%;
        max-width: 280px;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .nav-toggle {
        display: block;
      }

      .grid-2 {
        grid-template-columns: 1fr;
      }

      .app-container {
        margin-left: 0;
      }

      main {
        margin-left: 0;
        padding: 0.75rem;
      }

      header h1 {
        font-size: 1rem;
      }

      #user-display {
        font-size: 0.7rem;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      /* Make tables scrollable on mobile */
      .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      table {
        font-size: 0.85rem;
      }

      th,
      td {
        padding: 0.5rem;
        white-space: nowrap;
      }

      /* Larger touch targets for buttons */
      .btn {
        padding: 0.85rem 1.25rem;
        font-size: 1rem;
        min-height: 44px;
        /* iOS recommended touch target */
      }

      .btn-primary {
        width: 100%;
      }

      /* Form inputs larger for mobile */
      .form-control {
        padding: 0.85rem;
        font-size: 16px;
        /* Prevents zoom on iOS */
        min-height: 44px;
      }

      select.form-control {
        font-size: 16px;
      }

      /* Card spacing */
      .card {
        padding: 1rem;
        margin-bottom: 1rem;
      }

      /* Sidebar logo smaller on mobile */
      .sidebar img {
        width: 80px !important;
      }

      /* Navigation items larger touch targets */
      .nav-item {
        padding: 1rem 1.25rem;
        font-size: 0.95rem;
      }

      /* Dashboard buttons stack on mobile */
      #dashboard button {
        margin-bottom: 0.5rem;
      }

      /* Receipt modal full screen on mobile */
      #receipt-modal {
        padding: 0;
      }

      #receipt-content {
        width: 100%;
        min-height: 100vh;
        border-radius: 0;
        padding: 15mm;
      }

      /* Statistics cards stack better */
      #reports .card {
        min-height: auto;
      }

      /* Finance tables more compact */
      #finance-pending-table th,
      #finance-pending-table td {
        font-size: 0.8rem;
        padding: 0.4rem;
      }

      /* Debtors table compact */
      #debtors-table th,
      #debtors-table td {
        font-size: 0.75rem;
        padding: 0.35rem;
      }
    }

    /* Extra small devices (phones in portrait) */
    @media (max-width: 480px) {
      header {
        padding: 0.75rem;
      }

      header h1 {
        font-size: 0.9rem;
      }

      #user-display {
        display: none;
        /* Hide on very small screens */
      }

      .card h3 {
        font-size: 1.1rem;
      }

      /* Stack form groups on very small screens */
      .grid-2 {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }

      /* Smaller buttons on tiny screens */
      .btn {
        font-size: 0.9rem;
        padding: 0.75rem 1rem;
      }

      /* Compact tables */
      table {
        font-size: 0.75rem;
      }

      th,
      td {
        padding: 0.35rem;
      }
    }

    /* Landscape mode optimization */
    @media (max-width: 768px) and (orientation: landscape) {
      main {
        padding: 0.5rem;
      }

      .card {
        padding: 0.75rem;
      }
    }

    /* Touch-friendly improvements for all screen sizes */
    * {
      -webkit-tap-highlight-color: rgba(35, 112, 184, 0.2);
    }

    button,
    a,
    input,
    select,
    textarea {
      touch-action: manipulation;
      /* Prevents double-tap zoom */
    }

    /* Smooth scrolling for mobile */
    html {
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }

    /* Prevent text selection on buttons */
    button,
    .btn {
      -webkit-user-select: none;
      user-select: none;
    }

    /* myDoc Branding Logo Styling */
    .mydoc-branding-logo {
      width: 100%;
      height: 60px;
      object-fit: cover;
      object-position: center;
      margin: 0 auto;
      border-radius: 12px;
      opacity: 0.9;
      filter: brightness(1.1) drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .mydoc-branding-logo:hover {
      opacity: 1;
      filter: brightness(1.2) drop-shadow(0 4px 12px rgba(0, 0, 0, 0.4));
      transform: scale(1.02);
    }



    /* ICD-11 Autocomplete */
    .autocomplete-wrapper {
      position: relative;
    }

    .autocomplete-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 300px;
      overflow-y: auto;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      z-index: 9999;
      display: none;
    }

    .autocomplete-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .autocomplete-item:hover {
      background: #f0f7ff;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-code {
      font-weight: bold;
      color: #2370b8;
      font-size: 0.9rem;
    }

    .autocomplete-desc {
      color: #333;
      margin-top: 2px;
    }

    .autocomplete-category {
      font-size: 0.75rem;
      color: #999;
      margin-top: 2px;
    }

    .autocomplete-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 300px;
      overflow-y: auto;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      display: none;
    }

    .autocomplete-no-results {
      padding: 10px;
      color: #999;
      text-align: center;
    }

    /* ===== PREMIUM DASHBOARD STYLES ===== */

    /* Statistics Cards */
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
      color: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
    }

    .stat-label {
      font-size: 0.85rem;
      opacity: 0.9;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
      line-height: 1;
    }

    /* Collection Cards */
    .collection-card {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      padding: 1rem 1.25rem;
      border-radius: 10px;
      text-align: center;
      color: white;
      box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .collection-card:hover {
      transform: translateY(-3px);
    }

    .collection-card.total {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .collection-label {
      font-size: 0.8rem;
      opacity: 0.9;
      margin-bottom: 0.3rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .collection-value {
      font-size: 1.5rem;
      font-weight: bold;
    }

    /* Queue Cards */
    .queue-card {
      position: relative;
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      overflow: hidden;
      border-left: 5px solid #22c55e;
    }

    .queue-card:hover {
      box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }

    .queue-card[data-status="normal"] {
      border-left-color: #22c55e;
    }

    .queue-card[data-status="concerning"] {
      border-left-color: #eab308;
    }

    .queue-card[data-status="high-risk"] {
      border-left-color: #f97316;
    }

    .queue-card[data-status="critical"] {
      border-left-color: #ef4444;
    }

    .queue-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .queue-icon {
      font-size: 1.5rem;
    }

    .queue-name {
      font-weight: 600;
      color: #1e293b;
      font-size: 0.95rem;
    }

    .queue-count {
      font-size: 3rem;
      font-weight: bold;
      color: #1e293b;
      text-align: center;
      margin: 0.5rem 0;
      transition: transform 0.3s ease;
    }

    .queue-status {
      text-align: center;
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #22c55e;
    }

    .queue-card[data-status="concerning"] .queue-status {
      color: #eab308;
    }

    .queue-card[data-status="high-risk"] .queue-status {
      color: #f97316;
    }

    .queue-card[data-status="critical"] .queue-status {
      color: #ef4444;
    }

    /* Pulse Animation - Spreading from Center */
    .queue-pulse {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #22c55e;
      animation: pulse 2s infinite;
    }

    .queue-card[data-status="concerning"] .queue-pulse {
      background: #eab308;
    }

    .queue-card[data-status="high-risk"] .queue-pulse {
      background: #f97316;
    }

    .queue-card[data-status="critical"] .queue-pulse {
      background: #ef4444;
      animation: pulse-critical 1s infinite;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
      }

      50% {
        opacity: 0.8;
        transform: scale(1);
        box-shadow: 0 0 0 6px rgba(34, 197, 94, 0);
      }

      100% {
        opacity: 1;
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
      }
    }

    @keyframes pulse-critical {
      0% {
        opacity: 1;
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.9);
      }

      50% {
        opacity: 0.7;
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
      }

      100% {
        opacity: 1;
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
      }
    }

    /* Dashboard Grid Layouts */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .queue-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .stat-value {
        font-size: 2rem;
      }

      .queue-count {
        font-size: 2.5rem;
      }

      .collection-value {
        font-size: 1.2rem;
      }
    }

    /* Blinking animation for live icon */
    @keyframes blink {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.3;
      }
    }

    .live-icon-blink {
      animation: blink 1.5s ease-in-out infinite;
      display: inline-block;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>

  <!-- Mobile Sidebar Overlay -->
  <div id="sidebar-overlay"
    style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:85;"
    onclick="toggleSidebar()"></div>









  <!-- Logout Screen Container -->
  <div id="logout-message"
    style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background: linear-gradient(135deg, #2370b8 0%, #1a5a96 100%); z-index:9999; align-items:center; justify-content:center;">
  </div>


  <!-- Logout Confirmation Modal -->
  <div id="logout-confirm-modal"
    style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center;">
    <div
      style="background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 400px; width: 90%; padding: 30px; text-align: center; animation: slideUp 0.3s ease-out;">
      <div style="font-size: 48px; margin-bottom: 15px;">üö™</div>
      <h3 style="color: #2370b8; font-size: 22px; font-weight: 700; margin-bottom: 10px;">Logout Confirmation</h3>
      <p style="color: #666; font-size: 15px; margin-bottom: 25px;">Are you sure you want to log out of Makele Digital
        Clinic?</p>

      <div style="display: flex; gap: 10px;">
        <button onclick="cancelLogout()"
          style="flex: 1; background: #eee; color: #333; border: none; border-radius: 8px; padding: 12px 20px; font-size: 15px; font-weight: 600; cursor: pointer;">
          Cancel
        </button>
        <button onclick="confirmLogout()"
          style="flex: 1; background: #dc3545; color: white; border: none; border-radius: 8px; padding: 12px 20px; font-size: 15px; font-weight: 600; cursor: pointer;">
          Logout
        </button>
      </div>
    </div>
  </div>


  <!-- Custom Alert Modal -->
  <div id="custom-alert-modal"
    style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:10001; align-items:center; justify-content:center;">
    <div
      style="background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 450px; width: 90%; padding: 30px; text-align: center; animation: slideUp 0.3s ease-out;">
      <div id="alert-icon" style="font-size: 48px; margin-bottom: 15px;">‚ÑπÔ∏è</div>
      <h3 id="alert-title" style="color: #2370b8; font-size: 20px; font-weight: 700; margin-bottom: 10px;">Notice</h3>
      <p id="alert-message" style="color: #666; font-size: 15px; margin-bottom: 25px; line-height: 1.5;"></p>
      <button onclick="closeAlert()"
        style="width: 100%; background: #2370b8; color: white; border: none; border-radius: 8px; padding: 12px 20px; font-size: 15px; font-weight: 600; cursor: pointer;">
        OK
      </button>
    </div>
  </div>

  <!-- Custom Confirm Modal -->
  <div id="custom-confirm-modal"
    style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:10001; align-items:center; justify-content:center;">
    <div
      style="background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 450px; width: 90%; padding: 30px; text-align: center; animation: slideUp 0.3s ease-out;">
      <div id="confirm-icon" style="font-size: 48px; margin-bottom: 15px;">‚ùì</div>
      <h3 id="confirm-title" style="color: #2370b8; font-size: 20px; font-weight: 700; margin-bottom: 10px;">Confirm
        Action</h3>
      <p id="confirm-message" style="color: #666; font-size: 15px; margin-bottom: 25px; line-height: 1.5;"></p>
      <div style="display: flex; gap: 10px;">
        <button onclick="closeConfirm(false)"
          style="flex: 1; background: #eee; color: #333; border: none; border-radius: 8px; padding: 12px 20px; font-size: 15px; font-weight: 600; cursor: pointer;">
          Cancel
        </button>
        <button onclick="closeConfirm(true)"
          style="flex: 1; background: #2370b8; color: white; border: none; border-radius: 8px; padding: 12px 20px; font-size: 15px; font-weight: 600; cursor: pointer;">
          Confirm
        </button>
      </div>
    </div>
  </div>




  <div class="app-container">
    <header>
      <button class="nav-toggle" onclick="toggleSidebar()">‚ò∞</button>
      <h1>myDoc</h1>
      <div id="user-display" style="font-size: 0.9rem;"></div>
    </header>

    <nav class="sidebar" id="sidebar">
      <div style="text-align: center; padding: 1.5rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <img src="https://lh3.googleusercontent.com/d/12Ef6QK7k4iXtyzOtzaFA1BwEcHb6cDgc" alt="Makele Digital Clinic"
          style="width: 100px; height: auto; margin: 0 auto 10px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
        <div style="font-weight: bold; font-size: 1.1rem; color: white;">Makele Digital Clinic</div>
        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7); margin-top: 5px;"></div>
      </div>

      <a class="nav-item active" href="#" onclick="navigate('dashboard'); return false;">üè† Dashboard</a>
      <a class="nav-item" href="#" onclick="navigate('registration'); return false;">üìù Registration</a>
      <a class="nav-item" href="#" onclick="navigate('triage'); return false;">ü©∫ Triage</a>
      <a class="nav-item" href="#" onclick="navigate('diagnosis'); return false;">üíä Diagnosis & Treatment</a>
      <a class="nav-item" href="#" onclick="navigate('patient-history'); return false;">üìã Patient History</a>
      <a class="nav-item" href="#" onclick="navigate('lab'); return false;">üî¨ Laboratory</a>
      <a class="nav-item" href="#" onclick="navigate('lab-inventory'); return false;">üì¶ Lab Inventory</a>
      <a class="nav-item" href="#" onclick="navigate('finance'); return false;">üí∞ Finance</a>
      <a class="nav-item" href="#" onclick="navigate('family-planning'); return false;">üë∂ Family Planning</a>

      <a class="nav-item" href="#" onclick="navigate('reports'); return false;">üìä Reports</a>

      <!-- Logout Link moved here -->
      <a class="nav-item" onclick="logout()"
        style="color: rgba(255, 200, 200, 0.9); border-top: 1px solid rgba(255,255,255,0.1); margin-top: 1rem;">üö™
        Logout</a>

      <div style="margin-top: auto; padding: 1rem;">
        <!-- myDoc Branding Logo -->
        <div
          style="text-align: center; padding: 1rem 0.5rem 0.5rem; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 0.5rem;">
          <img src="https://lh3.googleusercontent.com/d/1X-xSSEghTPQoyb2pNKiXCN9Yer3I_hJf"
            alt="myDoc - Smart Healthcare Solutions" class="mydoc-branding-logo">
        </div>
      </div>

    </nav>






    <main>
      <!-- Dashboard View -->
      <div id="dashboard" class="view active">
        <h2>Welcome to myDoc</h2>
        <div class="card">
          <p>Select a module from the menu to begin.</p>
          <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
            <button onclick="navigate('registration')" class="btn btn-primary">Registration</button>
            <button onclick="navigate('triage')" class="btn btn-primary">Triage</button>
            <button onclick="navigate('diagnosis')" class="btn btn-primary">Diagnosis</button>
            <button onclick="navigate('lab')" class="btn btn-primary">Lab</button>
            <button onclick="navigate('finance')" class="btn btn-primary">Finance</button>
            <button onclick="navigate('family-planning')" class="btn btn-primary">Family Planning</button>
            <button onclick="navigate('reports')" class="btn btn-primary">Reports</button>
          </div>
          <div id="user-info" style="margin-top: 1rem; font-size: 0.9rem; color: #666;"></div>
        </div>

        <!-- Today's Statistics -->
        <div class="card" style="margin-top: 1.5rem;">
          <h3 style="margin-bottom: 1rem;">üìä Today's Statistics</h3>

          <div class="stats-grid" style="margin-bottom: 1.5rem;">
            <!-- Patient Counts -->
            <div class="stat-card">
              <div class="stat-label">Registered</div>
              <div class="stat-value" id="stat-registered">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Triaged</div>
              <div class="stat-value" id="stat-triaged">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Consulted</div>
              <div class="stat-value" id="stat-consulted">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Billed</div>
              <div class="stat-value" id="stat-billed">0</div>
            </div>
          </div>

          <!-- Collections Breakdown -->
          <h4 style="margin-bottom: 0.75rem; color: #2370b8;">üí∞ Today's Collections</h4>
          <div class="stats-grid">
            <div class="collection-card">
              <div class="collection-label">Drugs</div>
              <div class="collection-value" id="collection-drugs">KES 0</div>
            </div>
            <div class="collection-card">
              <div class="collection-label">Lab Tests</div>
              <div class="collection-value" id="collection-labs">KES 0</div>
            </div>
            <div class="collection-card">
              <div class="collection-label">Consultations</div>
              <div class="collection-value" id="collection-consults">KES 0</div>
            </div>
            <div class="collection-card total">
              <div class="collection-label">Total</div>
              <div class="collection-value" id="collection-total">KES 0</div>
            </div>
          </div>
        </div>

        <!-- Live Queue Monitoring -->
        <div class="card" style="margin-top: 1.5rem;">
          <h3 style="margin: 0 0 1rem 0;">
            <span class="live-icon-blink">üî¥</span>
            <span> Live Queue Monitoring:</span>
            <span id="live-datetime"
              style="font-size: 0.75em; color: #666; font-weight: 600; margin-left: 1rem;">Loading...</span>
          </h3>

          <div class="queue-grid">

            <!-- Triage Queue -->
            <div class="queue-card" id="queue-triage" data-count="0" data-status="normal">
              <div class="queue-header">
                <span class="queue-icon">ü©∫</span>
                <span class="queue-name">Triage</span>
              </div>
              <div class="queue-count">0</div>
              <div class="queue-status">Normal</div>
              <div class="queue-pulse"></div>
            </div>

            <!-- Pending Lab Results -->
            <div class="queue-card" id="queue-lab-results" data-count="0" data-status="normal">
              <div class="queue-header">
                <span class="queue-icon">üî¨</span>
                <span class="queue-name">Pending Lab Results</span>
              </div>
              <div class="queue-count">0</div>
              <div class="queue-status">Normal</div>
              <div class="queue-pulse"></div>
            </div>

            <!-- Pending Billing -->
            <div class="queue-card" id="queue-billing" data-count="0" data-status="normal">
              <div class="queue-header">
                <span class="queue-icon">üí∞</span>
                <span class="queue-name">Pending Billing</span>
              </div>
              <div class="queue-count">0</div>
              <div class="queue-status">Normal</div>
              <div class="queue-pulse"></div>
            </div>

            <!-- Pending FP Service -->
            <div class="queue-card" id="queue-fp" data-count="0" data-status="normal">
              <div class="queue-header">
                <span class="queue-icon">üë∂</span>
                <span class="queue-name">Pending FP Service</span>
              </div>
              <div class="queue-count">0</div>
              <div class="queue-status">Normal</div>
              <div class="queue-pulse"></div>
            </div>

            <!-- Waiting Consultation -->
            <div class="queue-card" id="queue-consultation" data-count="0" data-status="normal">
              <div class="queue-header">
                <span class="queue-icon">üíä</span>
                <span class="queue-name">Waiting Consultation</span>
              </div>
              <div class="queue-count">0</div>
              <div class="queue-status">Normal</div>
              <div class="queue-pulse"></div>
            </div>

            <!-- Pending Lab Orders -->
            <div class="queue-card" id="queue-lab-orders" data-count="0" data-status="normal">
              <div class="queue-header">
                <span class="queue-icon">üß™</span>
                <span class="queue-name">Pending Lab Orders</span>
              </div>
              <div class="queue-count">0</div>
              <div class="queue-status">Normal</div>
              <div class="queue-pulse"></div>
            </div>

          </div>
        </div>
      </div>

      <!-- Registration View -->
      <div id="registration" class="view">
        <h2>Patient Registration</h2>
        <!-- New Patient Form -->
        <div class="card">
          <h3>New Patient</h3>
          <form id="reg-form" onsubmit="handleRegistration(event)">


            <div class="grid-2">
              <div class="form-group"><label>First Name *</label><input type="text" name="first_name"
                  class="form-control" required></div>
              <div class="form-group"><label>Last Name *</label><input type="text" name="last_name" class="form-control"
                  required></div>
            </div>
            <div class="grid-2">
              <div class="form-group"><label>Middle Name</label><input type="text" name="middle_name"
                  class="form-control"></div>
              <div class="form-group"><label>Date of Birth *</label><input type="date" name="date_of_birth"
                  class="form-control" required></div>
            </div>
            <div class="grid-2">
              <div class="form-group"><label>Gender *</label>
                <select name="gender" class="form-control" required>
                  <option value="">Select...</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="form-group"><label>Phone Number *</label><input type="tel" name="phone_number"
                  class="form-control" placeholder="07XXXXXXXX" required></div>
            </div>
            <div class="grid-2">
              <div class="form-group"><label>National ID</label><input type="text" name="national_id"
                  class="form-control"></div>
              <div class="form-group"><label>SHA No</label><input type="text" name="NHIF_no" class="form-control">
              </div>
            </div>
            <div class="grid-2">
              <div class="form-group">
                <label>County *</label>
                <select name="county" id="county-select" class="form-control" required onchange="updateSubCounties()">
                  <option value="">Select County...</option>
                  <option value="Machakos">Machakos</option>
                  <option value="Kitui">Kitui</option>
                  <option value="Makueni">Makueni</option>
                </select>
              </div>
              <div class="form-group">
                <label>Sub-County *</label>
                <select name="sub_county" id="subcounty-select" class="form-control" required>
                  <option value="">Select County First...</option>
                </select>
              </div>
            </div>
            <div class="grid-2">
              <div class="form-group"><label>Disability Status</label>
                <select name="disability_status" class="form-control">
                  <option value="">None</option>
                  <option value="Visual">Visual</option>
                  <option value="Hearing">Hearing</option>
                  <option value="Cognitive">Cognitive</option>
                  <option value="Physical">Physical</option>
                  <option value="Others">Others</option>
                </select>
              </div>
              <div class="form-group"><label>Village / Estate</label><input type="text" name="village"
                  class="form-control" placeholder="e.g. Majengo"></div>
            </div>
            <div class="grid-2">
              <div class="form-group"><label>Next of Kin Name *</label><input type="text" name="next_of_kin"
                  class="form-control" required></div>
              <div class="form-group"><label>Relationship *</label><input type="text" name="NOK_relationship"
                  class="form-control" required></div>
            </div>
            <div class="form-group"><label>Next of Kin Phone *</label><input type="tel" name="NOK_phone"
                class="form-control" required></div>
            <div class="form-group">
              <button type="submit" class="btn btn-primary">Register Patient</button>
              <div id="reg-loader" class="loader"></div>
            </div>
          </form>
        </div>
      </div>

      <!-- Triage View -->
      <div id="triage" class="view">
        <h2>Triage Module</h2>
        <!-- Step 1: Patient Search & Queue -->
        <div class="card" id="triage-search-section">
          <h3>1. Find Patient</h3>
          <div class="form-group">
            <div style="display: flex; gap: 10px;">
              <input type="text" id="patient-search-input" class="form-control"
                placeholder="Search by Name, ID, or Phone...">
              <button onclick="runPatientSearch()" class="btn btn-primary" style="width: auto;">Search</button>
            </div>
          </div>
          <div id="search-results" class="table-responsive"
            style="display:none; margin-top: 1rem; max-height: 350px; overflow-y: auto;">
            <h4>Search Results</h4>
            <table id="search-results-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Phone</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- New: Patients Queue -->
          <div id="triage-queue-section" style="margin-top: 2rem;">
            <h4>Recent Patients (Waiting for Triage)</h4>
            <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
              <table id="triage-queue-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Gender</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="4">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <button onclick="loadTriageQueue()" class="btn btn-primary" style="width:auto; margin-top:1rem;">Refresh
              List</button>
          </div>
        </div>
        <!-- Step 2: Triage Form (Hidden until patient selected) -->
        <div class="card" id="triage-form-section" style="display:none;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <h3>2. Vitals & Assessment</h3>
            <button onclick="resetTriage()" class="btn" style="background:#eee; width:auto; font-size:0.8rem;">Change
              Patient</button>
          </div>
          <div class="alert"
            style="background: #eef5fa; padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem;">
            <strong>Patient:</strong> <span id="triage-patient-name"></span> (<span id="triage-patient-id"></span>)
          </div>
          <form id="triage-form" onsubmit="handleTriageSubmit(event)">
            <input type="hidden" name="patient_id" id="triage-patient-id-input">
            <div class="grid-2">
              <div class="form-group"><label>Chief Complaint *</label><input type="text" name="chief_complain"
                  class="form-control" required></div>
              <div class="form-group"><label>Duration</label><input type="text" name="complain_duration"
                  class="form-control" placeholder="e.g. 3 days"></div>
              <div class="form-group"><label>Allergies</label><input type="text" name="allergies" class="form-control"
                  placeholder="e.g. Penicillin"></div>
              <div class="form-group"><label>Chronic Diseases</label><input type="text" name="chronic_diseases"
                  class="form-control" placeholder="e.g. Hypertension"></div>
            </div>
            <h4>Vitals</h4>
            <div class="grid-2">
              <div class="form-group"><label>BP Systolic (mmHg) *</label><input type="number" name="bp_systolic"
                  class="form-control" required></div>
              <div class="form-group"><label>BP Diastolic (mmHg) *</label><input type="number" name="bp_diastolic"
                  class="form-control" required></div>
            </div>
            <div class="grid-2">
              <div class="form-group"><label>Heart Rate (bpm) *</label><input type="number" name="heart_rate_bpm"
                  class="form-control" required></div>
              <div class="form-group"><label>Resp. Rate (bpm) *</label><input type="number" name="resp_rate_breaths"
                  class="form-control" required></div>
            </div>
            <div class="grid-2">
              <div class="form-group"><label>Temperature (¬∞C) *</label><input type="number" step="0.1" name="temp_c"
                  class="form-control" required></div>
              <div class="form-group"><label>O2 Saturation (%)</label><input type="number" name="oxygen_saturation"
                  class="form-control"></div>
            </div>
            <div class="grid-2">
              <div class="form-group"><label>Weight (kg) *</label><input type="number" step="0.1" id="weight"
                  name="weight" class="form-control" oninput="calculateBMI()" required></div>
              <div class="form-group"><label>Height (cm) *</label><input type="number" step="0.1" id="height"
                  name="height" class="form-control" oninput="calculateBMI()" required></div>
            </div>
            <div class="grid-2">
              <div class="form-group"><label>BMI (kg/m¬≤)</label><input type="text" name="BMI" id="bmi-display"
                  class="form-control" readonly style="background: #f9f9f9;"></div>
              <div class="form-group"><label>Priority *</label>
                <select name="triage_priority" class="form-control" required>
                  <option value="">Select Priority...</option>
                  <option value="Red" style="color:red; font-weight:bold;">Red (Emergency)</option>
                  <option value="Yellow" style="color:orange; font-weight:bold;">Yellow (Urgent)</option>
                  <option value="Green" style="color:green; font-weight:bold;">Green (Non-Urgent)</option>
                </select>
              </div>
              <div class="form-group"><label>Service Point / Referral *</label>
                <select name="service_point" class="form-control" required>
                  <option value="General">General Consultation</option>
                  <option value="Family Planning">Family Planning (FP)</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <button type="submit" class="btn btn-primary">Save Triage Record</button>
              <div id="triage-loader" class="loader"></div>
            </div>
          </form>
        </div>
      </div>

      <!-- Diagnosis View -->
      <div id="diagnosis" class="view">
        <h2>Doctor's Dashboard</h2>

        <div class="grid-2">
          <!-- Waiting List -->
          <div class="card">
            <h4>Waiting List (Triage Done)</h4>
            <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
              <table id="waiting-list-table">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Patient</th>
                    <th>Priority</th>
                    <th>Complaint</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <button onclick="loadWaitingList()" class="btn btn-primary"
              style="width:auto; margin-top:1rem;">Refresh</button>
          </div>

          <!-- Consultation Form (Hidden initially) -->
          <div class="card" id="consultation-form-section" style="display:none;">
            <h3>Consultation</h3>
            <div class="alert"
              style="background: #eef5fa; padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem;">
              <strong>Patient:</strong> <span id="consult-patient-name"></span><br>
              <strong>Chief Complaint:</strong> <span id="consult-complaint"></span>
            </div>
            <form id="treatment-form" onsubmit="handleTreatmentSubmit(event)">
              <input type="hidden" name="encounter_id" id="consult-encounter-id">
              <input type="hidden" name="patient_id" id="consult-patient-id">
              <div class="form-group"><label>History of Present Illness</label><textarea name="history_present_illness"
                  class="form-control" rows="3" required></textarea></div>
              <div class="form-group"><label>Physical Exam Findings</label><textarea name="physical_exam_findings"
                  class="form-control" rows="3"></textarea></div>

              <!--ICD CODES============================================================================================================================== -->

              <div class="form-group">
                <label>Search Diagnosis (ICD-11)</label>
                <div class="autocomplete-wrapper">
                  <input type="text" id="diagnosis-search" class="form-control"
                    placeholder="Type to search diagnoses..." autocomplete="off">
                  <div id="diagnosis-results" class="autocomplete-results"></div>
                </div>
              </div>
              <div class="grid-2">
                <div class="form-group"><label>Primary Diagnosis Code (ICD-11)</label><input type="text"
                    name="diagnosis_primary_code" id="diagnosis-code" class="form-control" readonly
                    style="background:#f9f9f9;" required></div>
                <div class="form-group"><label>Primary Diagnosis Description</label><input type="text"
                    name="diagnosis_primary_desc" id="diagnosis-desc" class="form-control" readonly
                    style="background:#f9f9f9;" required></div>
              </div>

              <!--ICD CODES============================================================================================================================== -->



              <div class="form-group"><label>Lab Orders (Select Tests)</label>
                <select id="lab-select" class="form-control" multiple style="height: 100px;">
                  <option value="Malaria BS Test">Malaria BS Test</option>
                  <option value="Hepatitis B Surface Antigen (Hba Ag) Test">Hepatitis B Surface Antigen (Hba Ag) Test
                  </option>
                  <option value="VDRL Test">VDRL Test</option>
                  <option value="H. Pyroli Test">H. Pyroli Test</option>
                  <option value="SAT Test">SAT Test</option>
                  <option value="U/A Test">U/A Test</option>
                  <option value="ASOT Test">ASOT Test</option>
                  <option value="RF Test">RF Test</option>
                  <option value="BAT Test">BAT Test</option>
                  <option value="HVS Test">HVS Test</option>
                  <option value="Blood group Test">Blood group Test</option>
                  <option value="PDT Test">PDT Test</option>
                  <option value="HIV Test">HIV Test</option>
                  <option value="Stool Test">Stool Test</option>









                  <option value="Urinalysis Test">Urinalysis Test</option>
                  <option value="Full Haemogram Test">Full Haemogram Test</option>
                  <option value="Random Blood Sugar Test">Random Blood Sugar Test</option>
                  <option value="Stool Ova/Cysts Test">Stool Ova/Cysts Test</option>
                </select>
                <small>Hold Ctrl/Cmd to select multiple</small>
                <input type="hidden" name="labd_referral_ids" id="lab-ids">
                <input type="hidden" name="prescribed_medications" id="rx-json">
              </div>
              <div class="form-group"><label>Treatment Plan / Notes</label><textarea name="treatment_plan"
                  class="form-control" rows="3" required></textarea></div>

              <!-- Informational Note -->
              <div
                style="background: #fff3cd; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; border-left: 4px solid #ffc107;">
                <strong>‚ÑπÔ∏è Note:</strong> If lab tests are ordered, prescriptions will be added after reviewing lab
                results in the "Pending Lab Results" queue.
              </div>

              <div class="form-group"><button type="submit" class="btn btn-primary">Save Consultation</button></div>
            </form>
          </div>
        </div>

        <!-- Lab Results Review Modal -->
        <div id="lab-review-modal"
          style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; overflow-y: auto;">
          <div
            style="background: white; max-width: 900px; margin: 2rem auto; border-radius: 8px; padding: 2rem; max-height: 90vh; overflow-y: auto;">
            <h3>Review Lab Results</h3>

            <!-- Patient Info -->
            <div style="background: #eef5fa; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem;">
              <strong>Patient:</strong> <span id="review-patient-name"></span><br>
              <strong>Patient ID:</strong> <span id="review-patient-id"></span><br>
              <strong>Initial Diagnosis:</strong> <span id="review-diagnosis-code"></span> - <span
                id="review-diagnosis-desc"></span><br>
              <strong>Consultation Date:</strong> <span id="review-consultation-date"></span>
            </div>

            <!-- Lab Results Display -->
            <div id="lab-results-display" style="margin-bottom: 2rem;">
              <h4>üìã Laboratory Results</h4>
              <div id="lab-results-list"></div>
            </div>

            <!-- Finalization Form -->
            <form id="finalize-consultation-form" onsubmit="handleFinalizeConsultation(event)">
              <input type="hidden" id="finalize-treatment-id" name="treatment_id">
              <input type="hidden" id="finalize-encounter-id" name="encounter_id">

              <h4>‚úèÔ∏è Final Diagnosis & Treatment Plan</h4>

              <!-- Final Diagnosis Search (NEW) -->
              <div class="form-group">
                <label>Final Diagnosis Search (ICD-11)</label>
                <div class="autocomplete-wrapper">
                  <input type="text" id="final-diagnosis-search" class="form-control"
                    placeholder="Type to search confirmed diagnosis..." autocomplete="off">
                  <div id="final-diagnosis-results" class="autocomplete-results"></div>
                </div>
              </div>
              <div class="grid-2">
                <div class="form-group">
                  <label>Confirmed Diagnosis Code</label>
                  <input type="text" name="final_diagnosis_code" id="final-diagnosis-code" class="form-control" readonly
                    style="background:#f9f9f9;" required>
                </div>
                <div class="form-group">
                  <label>Confirmed Diagnosis Description</label>
                  <input type="text" name="final_diagnosis_desc" id="final-diagnosis-desc" class="form-control" readonly
                    style="background:#f9f9f9;" required>
                </div>
              </div>

              <div class="form-group">
                <label>Prescribed Medications (Rx) *</label>
                <textarea name="prescribed_medications" class="form-control" rows="3"
                  placeholder="e.g., Paracetamol 500mg - 2 tablets TID for 5 days&#10;Amoxicillin 250mg - 1 capsule TID for 7 days"
                  required></textarea>
              </div>

              <div class="form-group">
                <label>Treatment Plan / Notes</label>
                <textarea name="treatment_plan" class="form-control" rows="3"
                  placeholder="Additional treatment notes, recommendations, dietary advice..."></textarea>
              </div>

              <div class="grid-2">
                <div class="form-group">
                  <label>Disposition</label>
                  <select name="disposition" class="form-control">
                    <option value="">Select...</option>
                    <option value="Discharged">Discharged</option>
                    <option value="Admitted">Admitted</option>
                    <option value="Referred">Referred</option>
                    <option value="Follow-up">Follow-up Required</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Follow-up Date</label>
                  <input type="date" name="follow_up_date" class="form-control">
                </div>
              </div>

              <div class="form-group" style="margin-top: 1.5rem;">
                <button type="submit" class="btn btn-primary" id="finalize-btn">Save & Finalize Consultation</button>
                <button type="button" onclick="closeLabReviewModal()" class="btn"
                  style="background:#eee; margin-left: 0.5rem;">Cancel</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Pending Lab Results Queue -->
        <div class="card" style="margin-top: 2rem;">
          <h4>Waiting List (Pending Lab Results) üî¨</h4>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
            Patients with completed lab results awaiting doctor review
          </p>
          <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
            <table id="pending-lab-results-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Patient</th>
                  <th>Diagnosis Code</th>
                  <th>Diagnosis</th>
                  <th>Lab Results</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="6">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
          <button onclick="loadPendingLabResults()" class="btn btn-primary" style="width:auto; margin-top:1rem;">Refresh
            Queue</button>
        </div>
      </div>

      <!-- Patient History View - SIMPLE VERSION -->
      <div id="patient-history" class="view">
        <h2>Patient Search</h2>

        <!-- Simple Search -->
        <div class="card">
          <h3>Search Patient</h3>
          <div style="margin-bottom: 1rem;">
            <input type="text" id="simple-search-input" class="form-control" placeholder="Enter name, phone, or ID..."
              style="margin-bottom: 0.5rem;">
            <button onclick="doSimpleSearch()" class="btn btn-primary" style="width:auto;">üîç Search</button>
          </div>

          <!-- Results -->
          <div id="simple-results" style="display:none;">
            <h4>Results</h4>
            <table>
              <thead>
                <tr>
                  <th>Patient ID</th>
                  <th>Name</th>
                  <th>Phone</th>
                  <th>Gender</th>
                  <th>National ID</th>
                  <th>SHA No</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="simple-results-tbody"></tbody>
            </table>
          </div>
        </div>

        <!-- Patient History Modal -->
        <div id="patient-history-modal" style="display:none;" class="card">
          <h3>Patient History - <span id="history-patient-name"></span></h3>
          <button onclick="closeHistoryModal()" class="btn" style="width:auto; float:right; margin-top:-2.5rem;">‚úñ
            Close</button>

          <!-- Patient Info Summary -->
          <div style="background:#f0f0f0; padding:0.5rem; margin-bottom:1rem; border-radius:4px;">
            <strong>ID:</strong> <span id="history-pid"></span> |
            <strong>Phone:</strong> <span id="history-phone"></span> |
            <strong>National ID:</strong> <span id="history-nid"></span>
          </div>

          <!-- History Tabs -->
          <div style="margin-bottom:1rem;">
            <button onclick="showHistTab('visits')" id="hist-tab-visits" class="btn"
              style="width:auto; margin-right:0.5rem; background:var(--primary); color:white;">Visits</button>
            <button onclick="showHistTab('consultations')" id="hist-tab-consultations" class="btn"
              style="width:auto; margin-right:0.5rem;">Consultations</button>
            <button onclick="showHistTab('labs')" id="hist-tab-labs" class="btn"
              style="width:auto; margin-right:0.5rem;">Lab Results</button>
            <button onclick="showHistTab('billing')" id="hist-tab-billing" class="btn"
              style="width:auto;">Billing</button>
          </div>

          <!-- Tab Content -->
          <div id="hist-content-visits" style="max-height:400px; overflow-y:auto;"></div>
          <div id="hist-content-consultations" style="display:none; max-height:400px; overflow-y:auto;"></div>
          <div id="hist-content-labs" style="display:none; max-height:400px; overflow-y:auto;"></div>
          <div id="hist-content-billing" style="display:none; max-height:400px; overflow-y:auto;"></div>
        </div>
      </div>

      <!-- Lab View -->
      <div id="lab" class="view">
        <h2>üî¨ Laboratory</h2>
        <!-- Orders Section -->
        <div id="lab-orders-section">
          <div class="card">
            <h3>Pending Lab Orders</h3>
            <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
              <table id="lab-orders-table">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Patient</th>
                    <th>Test</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <button onclick="loadLabOrders()" class="btn btn-primary"
              style="width:auto; margin-top:1rem;">Refresh</button>
          </div>
          <!-- Result Entry Form (Hidden) -->
          <div class="card" id="lab-result-form-section" style="display:none;">
            <h3>Enter Results</h3>
            <div class="alert"
              style="background: #eef5fa; padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem;">
              <strong>Test:</strong> <span id="res-test-name"></span><br><strong>Patient:</strong> <span
                id="res-patient-name"></span>
            </div>
            <form id="result-form" onsubmit="handleResultSubmit(event)">
              <input type="hidden" name="lab_order_id" id="res-order-id">
              <div class="grid-2">
                <div class="form-group"><label>Result Value *</label><input type="text" name="result_value"
                    class="form-control" required></div>
                <div class="form-group"><label>Units</label><input type="text" name="result_units" class="form-control">
                </div>
              </div>
              <div class="grid-2">
                <div class="form-group"><label>Reference Range</label><input type="text" name="reference_range"
                    class="form-control"></div>
                <div class="form-group"><label>Flag</label>
                  <select name="abnormal_flag" class="form-control">
                    <option value="Normal">Normal</option>
                    <option value="High" style="color:red;">High</option>
                    <option value="Low" style="color:blue;">Low</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label>Detailed Description</label>
                <textarea name="detailed_description" class="form-control" rows="4"
                  placeholder="Enter detailed test results, observations, recommendations..."></textarea>
              </div>
              <div class="form-group">
                <label>Upload Supporting File (PDF, Image, Document)</label>
                <input type="file" id="lab-result-file" class="form-control"
                  accept=".pdf,.png,.jpg,.jpeg,.gif,.docx,.doc,.xls,.xlsx" onchange="handleLabFileSelect(event)">
                <small style="color: #666; display: block; margin-top: 0.5rem;">
                  Max file size: 10MB. Supported: PDF, Images, Word, Excel
                </small>
                <div id="file-preview"
                  style="display: none; margin-top: 0.5rem; padding: 0.5rem; background: #f0f7ff; border-radius: 4px;">
                  <strong>Selected:</strong> <span id="file-name"></span>
                  (<span id="file-size"></span>)
                </div>
              </div>
              <div class="form-group">
                <button type="submit" class="btn btn-primary" id="save-result-btn">Save Result</button>
                <button type="button" onclick="cancelResult()" class="btn"
                  style="background:#eee; margin-top:0.5rem;">Cancel</button>
              </div>
            </form>
          </div>
        </div>







      </div>


      <!-- Finance View -->
      <div id="finance" class="view">
        <h2>Finance & Billing</h2>

        <!-- Tab Navigation -->
        <div style="margin-bottom: 1rem;">
          <button onclick="showFinanceTab('billing')" class="btn" id="tab-billing"
            style="width:auto; margin-right:0.5rem; background:var(--primary); color:white;">Pending Bills</button>
          <button onclick="showFinanceTab('debtors')" class="btn" id="tab-debtors"
            style="width:auto; background:#eee;">Debtors</button>
        </div>
        <!-- Billing Tab -->
        <div id="finance-billing-section">
          <div class="grid-2">
            <!-- Pending Bills -->
            <div class="card">
              <h3>Pending Bills</h3>
              <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                <table id="finance-pending-table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Patient</th>
                      <th>Services</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <button onclick="loadPendingBills()" class="btn btn-primary"
                style="width:auto; margin-top:1rem;">Refresh</button>
            </div>

            <!-- Payment Form -->
            <div class="card" id="payment-form-section" style="display:none;">
              <h3>Process Payment</h3>
              <div class="alert"
                style="background: #eef5fa; padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem;">
                <strong>Patient:</strong> <span id="pay-patient-name"></span>
              </div>
              <form id="payment-form" onsubmit="handlePaymentSubmit(event)">
                <input type="hidden" name="encounter_id" id="pay-encounter-id">
                <input type="hidden" name="patient_id" id="pay-patient-id">
                <input type="hidden" name="patient_name" id="pay-patient-name-hidden">
                <input type="hidden" name="phone_number" id="pay-phone-number">

                <!-- Itemized Charges Section -->
                <h4 style="margin-top: 1.5rem; color: #2370b8;">Charges Breakdown</h4>

                <!-- Consultation Charges -->
                <div class="card"
                  style="background: #f0f7ff; padding: 1rem; margin-bottom: 1rem; border-left: 4px solid #2370b8;">
                  <h5 style="margin-top: 0;">üíº Consultation</h5>
                  <div id="consultation-items">
                    <div class="charge-item" style="display: flex; gap: 10px; margin-bottom: 0.5rem;">
                      <input type="text" placeholder="Description (e.g., General Consultation)"
                        class="form-control consultation-desc" style="flex: 2;">
                      <input type="number" placeholder="Amount (KES)" class="form-control consultation-amount"
                        style="flex: 1;" oninput="calculateTotal()">
                      <button type="button" onclick="removeChargeItem(this)" class="btn"
                        style="background: #ff4444; color: white; padding: 0.5rem; width: auto;">‚úï</button>
                    </div>
                  </div>
                  <button type="button" onclick="addConsultationItem()" class="btn"
                    style="background: #eee; width: auto; margin-top: 0.5rem;">+ Add Consultation Item</button>
                  <div style="text-align: right; margin-top: 0.5rem; font-weight: bold;">
                    Subtotal: KES <span id="consultation-subtotal">0</span>
                  </div>
                </div>

                <!-- Lab Tests Charges -->
                <div class="card"
                  style="background: #fff7ed; padding: 1rem; margin-bottom: 1rem; border-left: 4px solid #f97316;">
                  <h5 style="margin-top: 0;">üî¨ Lab Tests</h5>
                  <div id="lab-items">
                    <div class="charge-item" style="display: flex; gap: 10px; margin-bottom: 0.5rem;">
                      <input type="text" placeholder="Test Name (e.g., Malaria BS)" class="form-control lab-desc"
                        style="flex: 2;">
                      <input type="number" placeholder="Amount (KES)" class="form-control lab-amount" style="flex: 1;"
                        oninput="calculateTotal()">
                      <button type="button" onclick="removeChargeItem(this)" class="btn"
                        style="background: #ff4444; color: white; padding: 0.5rem; width: auto;">‚úï</button>
                    </div>
                  </div>
                  <button type="button" onclick="addLabItem()" class="btn"
                    style="background: #eee; width: auto; margin-top: 0.5rem;">+ Add Lab Test</button>
                  <div style="text-align: right; margin-top: 0.5rem; font-weight: bold;">
                    Subtotal: KES <span id="lab-subtotal">0</span>
                  </div>
                </div>

                <!-- Drugs Charges -->
                <div class="card"
                  style="background: #f0fff4; padding: 1rem; margin-bottom: 1rem; border-left: 4px solid #22c55e;">
                  <h5 style="margin-top: 0;">üíä Drugs</h5>
                  <div id="drug-items">
                    <div class="charge-item" style="display: flex; gap: 10px; margin-bottom: 0.5rem;">
                      <input type="text" placeholder="Drug Name (e.g., Paracetamol 500mg)"
                        class="form-control drug-desc" style="flex: 2;">
                      <input type="number" placeholder="Amount (KES)" class="form-control drug-amount" style="flex: 1;"
                        oninput="calculateTotal()">
                      <button type="button" onclick="removeChargeItem(this)" class="btn"
                        style="background: #ff4444; color: white; padding: 0.5rem; width: auto;">‚úï</button>
                    </div>
                  </div>
                  <button type="button" onclick="addDrugItem()" class="btn"
                    style="background: #eee; width: auto; margin-top: 0.5rem;">+ Add Drug</button>
                  <div style="text-align: right; margin-top: 0.5rem; font-weight: bold;">
                    Subtotal: KES <span id="drug-subtotal">0</span>
                  </div>
                </div>

                <!-- Total Charges -->
                <div style="background: #2370b8; color: white; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                  <h4 style="margin: 0; text-align: right;">Total Charges: KES <span id="total-charges">0</span></h4>
                </div>
                <input type="hidden" name="total_charge_amount" id="total-charge-hidden">
                <input type="hidden" name="charge_details" id="charge-details-hidden" value="Mixed">
                <input type="hidden" name="charges_breakdown" id="charges-breakdown">

                <!-- Payment Details -->
                <div class="grid-2">
                  <div class="form-group"><label>Total Amount Paid (KES)</label><input type="text"
                      id="amount-paid-display" class="form-control" readonly style="background:#f9f9f9;" value="0">
                    <input type="hidden" name="amount_paid_today" id="amount-paid-hidden">
                  </div>
                  <div class="form-group"><label>Outstanding Balance</label><input type="text" id="balance-display"
                      class="form-control" readonly style="background:#f9f9f9;"></div>
                </div>

                <!-- Split Payment Section -->
                <div class="card"
                  style="background: #f0f7ff; padding: 1rem; margin-bottom: 1rem; border-left: 4px solid #2370b8;">
                  <h5 style="margin-top: 0;">üí≥ Payment Methods</h5>
                  <div id="payment-methods-container">
                    <div class="payment-method-row" style="display: flex; gap: 10px; margin-bottom: 0.5rem;">
                      <select class="form-control payment-method-select" style="flex: 1;"
                        onchange="updatePaymentMethod(this)">
                        <option value="Cash">Cash</option>
                        <option value="M-Pesa">M-Pesa</option>
                        <option value="Insurance">Insurance</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                      </select>
                      <input type="number" placeholder="Amount" class="form-control payment-amount" style="flex: 1;"
                        oninput="calculateTotalPaid()">
                      <input type="text" placeholder="Ref/Code" class="form-control payment-ref" style="flex: 1;">
                      <button type="button" onclick="removePaymentMethod(this)" class="btn"
                        style="background: #ff4444; color: white; padding: 0.5rem; width: auto;">‚úï</button>
                    </div>
                  </div>
                  <button type="button" onclick="addPaymentMethod()" class="btn"
                    style="background: #eee; width: auto; margin-top: 0.5rem;">+ Add Payment Method</button>
                </div>

                <div class="grid-2">
                  <!-- Hidden field for combined payment method string -->
                  <input type="hidden" name="payment_method" id="payment-method-combined">
                  <input type="hidden" name="transaction_reference" id="transaction-reference-combined">
                </div>
                <div class="form-group"><button type="submit" class="btn btn-primary">Process Payment</button></div>
              </form>
            </div>
          </div>
        </div>
        <!-- Debtors Tab -->
        <div id="finance-debtors-section" style="display:none;">
          <div class="card">
            <h3>Outstanding Debts</h3>
            <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
              <table id="debtors-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Patient Name</th>
                    <th>Phone</th>
                    <th>Service Date</th>
                    <th>Service</th>
                    <th>Total</th>
                    <th>Paid</th>
                    <th>Balance</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <button onclick="loadDebtors()" class="btn btn-primary"
              style="width:auto; margin-top:1rem;">Refresh</button>
          </div>
          <!-- Partial Payment Form -->
          <div class="card" id="partial-payment-section" style="display:none; margin-top:1rem;">
            <h3>Record Partial Payment</h3>
            <div class="alert"
              style="background: #eef5fa; padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem;">
              <strong>Patient:</strong> <span id="debtor-patient-name"></span><br>
              <strong>Outstanding Balance:</strong> KES <span id="debtor-balance"></span>
            </div>
            <form id="partial-payment-form" onsubmit="handlePartialPayment(event)">
              <input type="hidden" name="debtor_id" id="debtor-id">
              <input type="hidden" name="encounter_id" id="debtor-encounter-id">
              <input type="hidden" name="patient_id" id="debtor-patient-id">
              <input type="hidden" name="current_balance" id="debtor-current-balance">
              <div class="grid-2">
                <div class="form-group"><label>Amount Paying (KES) *</label><input type="number" name="payment_amount"
                    id="partial-amount" class="form-control" required oninput="calcPartialBalance()"></div>
                <div class="form-group"><label>New Balance</label><input type="text" id="new-balance-display"
                    class="form-control" readonly style="background:#f9f9f9;"></div>
              </div>
              <div class="grid-2">
                <div class="form-group"><label>Payment Method</label>
                  <select name="payment_method" class="form-control">
                    <option value="Cash">Cash</option>
                    <option value="M-Pesa">M-Pesa</option>
                    <option value="Insurance">Insurance</option>
                  </select>
                </div>
                <div class="form-group"><label>Reference</label><input type="text" name="transaction_reference"
                    class="form-control"></div>
              </div>
              <div class="form-group">
                <button type="submit" class="btn btn-primary">Record Payment</button>
                <button type="button" onclick="cancelPartialPayment()" class="btn"
                  style="background:#eee; margin-left:0.5rem;">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>
























      <!-- Reports View -->



      <div id="reports" class="view">
        <h2>üìä Statistics & Reports</h2>

        <!-- Summary Cards -->
        <div
          style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:1rem; margin-bottom:2rem;">
          <div
            style="background:#f0f7ff; padding:1rem; border-radius:8px; text-align:center; border-left:4px solid #2370b8;">
            <div style="font-size:2rem; font-weight:bold; color:#2370b8;" id="total-patients">0</div>
            <div style="color:#666; font-size:0.85rem;">Total Patients</div>
          </div>
          <div
            style="background:#f0fff4; padding:1rem; border-radius:8px; text-align:center; border-left:4px solid #22c55e;">
            <div style="font-size:2rem; font-weight:bold; color:#22c55e;" id="total-visits">0</div>
            <div style="color:#666; font-size:0.85rem;">Total Visits</div>
          </div>
          <div
            style="background:#fff7ed; padding:1rem; border-radius:8px; text-align:center; border-left:4px solid #f97316;">
            <div style="font-size:2rem; font-weight:bold; color:#f97316;" id="total-labs">0</div>
            <div style="color:#666; font-size:0.85rem;">Lab Tests</div>
          </div>
          <div
            style="background:#fef3c7; padding:1rem; border-radius:8px; text-align:center; border-left:4px solid #eab308;">
            <div style="font-size:2rem; font-weight:bold; color:#eab308;" id="total-payments">0</div>
            <div style="color:#666; font-size:0.85rem;">Payments</div>
          </div>
        </div>

        <!-- Charts Grid -->
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:1.5rem;">
          <div class="card">
            <h3>Gender Distribution</h3><canvas id="genderChart"></canvas>
          </div>
          <div class="card">
            <h3>Marital Status</h3><canvas id="maritalChart"></canvas>
          </div>
          <div class="card">
            <h3>Blood Groups</h3><canvas id="bloodGroupChart"></canvas>
          </div>
          <div class="card">
            <h3>Triage Priority</h3><canvas id="triagePriorityChart"></canvas>
          </div>
          <div class="card">
            <h3>Oxygen Saturation</h3><canvas id="oxygenChart"></canvas>
          </div>
          <div class="card">
            <h3>Patient Disposition</h3><canvas id="dispositionChart"></canvas>
          </div>
          <div class="card">
            <h3>Payment Methods</h3><canvas id="paymentMethodChart"></canvas>
          </div>
          <div class="card">
            <h3>Top 10 Lab Tests</h3><canvas id="labTestsChart"></canvas>
          </div>
          <div class="card">
            <h3>Top 10 Medications</h3><canvas id="prescriptionsChart"></canvas>
          </div>
          <div class="card">
            <h3>Top 10 Counties</h3><canvas id="countiesChart"></canvas>
          </div>
        </div>






        <button onclick="loadStatistics()" class="btn btn-primary" style="margin-top:2rem; width:auto;">üîÑ Refresh
          Statistics</button>
      </div>





      <!--Testing -->

      <!-- Family Planning View -->
      <div id="family-planning" class="view">
        <h2>üë∂ Family Planning</h2>

        <!-- Tab Navigation -->
        <div style="margin-bottom: 1rem;">
          <button onclick="showFPTab('client-details')" class="btn" id="tab-fp-client"
            style="width:auto; margin-right:0.5rem; background:var(--primary); color:white;">Client Details & Visit
            Information</button>
          <button onclick="showFPTab('tracking')" class="btn" id="tab-fp-tracking"
            style="width:auto; background:#eee;">FP Tracking</button>
        </div>
        <!-- Client Details Tab -->
        <div id="fp-client-details-section">
          <div class="card">
            <h4>Waiting List (Pending FP Service)</h4>
            <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
              <table id="fp-waiting-list-table">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Patient</th>
                    <th>Priority</th>
                    <th>Triage Note</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="5">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <button onclick="loadFPWaitingList()" class="btn btn-primary" style="width:auto; margin-top:1rem;">Refresh
              Queue</button>
          </div>







          <!-- Statistics Cards -->
          <div class="card">
            <h3>Summary Statistics</h3>
            <div
              style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; margin-top:1rem;">
              <!-- Client Type -->
              <div style="background:#f0f7ff; padding:1rem; border-radius:8px; border-left:4px solid #2370b8;">
                <div style="font-size:0.85rem; color:#666; margin-bottom:0.5rem;">Client Type</div>
                <div style="font-size:1.2rem; font-weight:bold; color:#2370b8;">
                  New: <span id="stat-new">0</span> | Revisit: <span id="stat-revisit">0</span>
                </div>
              </div>

              <!-- First Ever User -->
              <div style="background:#f0fff4; padding:1rem; border-radius:8px; border-left:4px solid #22c55e;">
                <div style="font-size:0.85rem; color:#666; margin-bottom:0.5rem;">1st Ever User</div>
                <div style="font-size:1.2rem; font-weight:bold; color:#22c55e;">
                  Yes: <span id="stat-first-yes">0</span> | No: <span id="stat-first-no">0</span>
                </div>
              </div>

              <!-- Age Distribution -->
              <div style="background:#fff7ed; padding:1rem; border-radius:8px; border-left:4px solid #f97316;">
                <div style="font-size:0.85rem; color:#666; margin-bottom:0.5rem;">Age Distribution</div>
                <div style="font-size:0.9rem; font-weight:bold; color:#f97316;">
                  <20: <span id="stat-age-under20">0</span> | 20-29: <span id="stat-age-20-29">0</span><br>
                    30-39: <span id="stat-age-30-39">0</span> | 40+: <span id="stat-age-40plus">0</span>
                </div>
              </div>

              <!-- Sex -->
              <div style="background:#fef3c7; padding:1rem; border-radius:8px; border-left:4px solid #eab308;">
                <div style="font-size:0.85rem; color:#666; margin-bottom:0.5rem;">Sex</div>
                <div style="font-size:1.2rem; font-weight:bold; color:#eab308;">
                  M: <span id="stat-sex-m">0</span> | F: <span id="stat-sex-f">0</span> | I: <span
                    id="stat-sex-i">0</span>
                </div>
              </div>

              <!-- Disability -->
              <div style="background:#f3e8ff; padding:1rem; border-radius:8px; border-left:4px solid #a855f7;">
                <div style="font-size:0.85rem; color:#666; margin-bottom:0.5rem;">Disability Status</div>
                <div style="font-size:0.9rem; font-weight:bold; color:#a855f7;">
                  None: <span id="stat-dis-none">0</span> | Visual: <span id="stat-dis-visual">0</span><br>
                  Hearing: <span id="stat-dis-hearing">0</span> | Cognitive: <span id="stat-dis-cognitive">0</span> |
                  Others: <span id="stat-dis-others">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- FP Tracking Tab -->
        <div id="fp-tracking-section" style="display:none;">
          <div class="card">
            <h3>FP Tracking Records</h3>
            <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
              <table id="fp-tracking-table">
                <thead>
                  <tr>
                    <th>Client No.</th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>FP Type</th>
                    <th>Dispense Date</th>
                    <th>Return Date</th>
                    <th>Days to Return</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="8">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <button onclick="loadFPTracking(false)" class="btn btn-primary"
              style="width:auto; margin-top:1rem;">Refresh</button>
            <button onclick="loadFPTracking(true)" class="btn" id="load-more-fp"
              style="width:auto; margin-top:1rem; margin-left:0.5rem; display:none;">Load More</button>
          </div>

          <!-- Dispense Form (Hidden) -->
          <div class="card" id="fp-dispense-section" style="display:none; margin-top:1rem;">
            <h3>Record FP Service</h3>
            <form id="fp-dispense-form" onsubmit="handleDispenseSubmit(event)">
              <input type="hidden" name="client_number" id="dispense-client-number">
              <input type="hidden" name="encounter_id" id="dispense-encounter-id">

              <div class="alert" style="background: #eef5fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <strong>Client:</strong> <span id="dispense-client-name"></span><br>
                <strong>Phone:</strong> <span id="dispense-phone"></span>
              </div>

              <div class="grid-2">
                <div class="form-group"><label>Client Type *</label>
                  <select name="client_type" class="form-control" required>
                    <option value="">Select</option>
                    <option value="1">1 - New to facility</option>
                    <option value="2">2 - Revisit</option>
                  </select>
                </div>
                <div class="form-group"><label>1st Ever User *</label>
                  <select name="first_ever_user" class="form-control" required>
                    <option value="">Select</option>
                    <option value="Y">Y - First-time ever user</option>
                    <option value="N">N - Previous user</option>
                  </select>
                </div>
              </div>

              <div class="grid-2">
                <div class="form-group"><label>FP Type *</label>
                  <select name="fp_type" class="form-control" required>
                    <option value="">Select Method...</option>
                    <optgroup label="Oral Contraceptives">
                      <option value="COC">Combined Oral Contraceptives (COC)</option>
                      <option value="POP">Progestin Only Pills (POP)</option>
                    </optgroup>
                    <optgroup label="Injectables">
                      <option value="DMPA-IM">DMPA-IM (Depo)</option>
                      <option value="DMPA-SC">DMPA-SC</option>
                    </optgroup>
                    <optgroup label="Implants">
                      <option value="Implanon">Implants (1-rod)</option>
                      <option value="Jadelle">Implants (2-rod)</option>
                    </optgroup>
                    <optgroup label="IUCD">
                      <option value="Copper T">IUCD (Copper T)</option>
                      <option value="Hormonal IUCD">IUCD (Hormonal)</option>
                    </optgroup>
                    <optgroup label="Barrier">
                      <option value="Male Condoms">Male Condoms</option>
                      <option value="Female Condoms">Female Condoms</option>
                    </optgroup>
                    <optgroup label="Permanent">
                      <option value="Tubal Ligation">Tubal Ligation</option>
                      <option value="Vasectomy">Vasectomy</option>
                    </optgroup>
                    <optgroup label="Natural/Other">
                      <option value="Cycle Beads">Cycle Beads</option>
                      <option value="Emergency Pills">Emergency Pills</option>
                    </optgroup>
                  </select>
                </div>
                <div class="form-group"><label>Dispense Date *</label><input type="date" name="dispense_date"
                    class="form-control" required></div>
              </div>

              <div class="grid-2">
                <div class="form-group"><label>Dosage</label><input type="text" name="dosage" class="form-control"
                    placeholder="e.g., 1 tablet daily"></div>
                <div class="form-group"><label>Duration (days) *</label><input type="number" name="duration_days"
                    class="form-control" min="1" required></div>
              </div>

              <div class="form-group"><label>Notes</label><textarea name="notes" class="form-control"
                  rows="2"></textarea></div>

              <div class="form-group">
                <button type="submit" class="btn btn-primary">Save Dispense</button>
                <button type="button" onclick="cancelDispense()" class="btn"
                  style="background:#eee; margin-left:0.5rem;">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>


      <!-- Lab Inventory View -->
      <div id="lab-inventory" class="view">
        <h2>üì¶ Lab Inventory Management</h2>

        <!-- Tab Navigation -->
        <div class="card" style="padding: 0.5rem 1.5rem;">
          <div style="display: flex; gap: 1rem; border-bottom: 2px solid var(--border-color);">
            <button onclick="switchInventoryTab('purchase')" id="tab-purchase" class="inventory-tab active"
              style="background: none; border: none; padding: 1rem 1.5rem; cursor: pointer; font-weight: 600; border-bottom: 3px solid var(--primary); color: var(--primary);">
              üì• Purchase (In)
            </button>
            <button onclick="switchInventoryTab('usage')" id="tab-usage" class="inventory-tab"
              style="background: none; border: none; padding: 1rem 1.5rem; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; color: var(--text-light);">
              üì§ Usage (Out)
            </button>
            <button onclick="switchInventoryTab('test-mapping')" id="tab-test-mapping" class="inventory-tab"
              style="background: none; border: none; padding: 1rem 1.5rem; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; color: var(--text-light);">
              üîó Test Configuration
            </button>
          </div>
        </div>

        <!-- Purchase (In) Tab Content -->
        <div id="purchase-tab-content" class="inventory-tab-content">

          <!-- Expiry Statistics Dashboard -->
          <div class="card">
            <h3>üìä Expiry Status Dashboard</h3>
            <div
              style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
              <div
                style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); padding: 1.5rem; border-radius: 12px; text-align: center; color: white;">
                <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">GREEN (>60 days)</div>
                <div style="font-size: 2.5rem; font-weight: bold;" id="expiry-green">0%</div>
              </div>
              <div
                style="background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%); padding: 1.5rem; border-radius: 12px; text-align: center; color: white;">
                <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">YELLOW (30-60 days)</div>
                <div style="font-size: 2.5rem; font-weight: bold;" id="expiry-yellow">0%</div>
              </div>
              <div
                style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); padding: 1.5rem; border-radius: 12px; text-align: center; color: white;">
                <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">ORANGE (<30 days)</div>
                    <div style="font-size: 2.5rem; font-weight: bold;" id="expiry-orange">0%</div>
                </div>
                <div
                  style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); padding: 1.5rem; border-radius: 12px; text-align: center; color: white;">
                  <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">EXPIRED</div>
                  <div style="font-size: 2.5rem; font-weight: bold;" id="expiry-expired">0%</div>
                </div>
              </div>
            </div>

            <!-- Add New Item Section -->
            <div class="card">
              <h3>‚ûï Add New Inventory Item</h3>
              <form id="add-item-form" onsubmit="handleAddItem(event)">
                <div class="grid-2">
                  <div class="form-group">
                    <label>Item Name *</label>
                    <input type="text" name="item_name" class="form-control" required placeholder="e.g., Blood Slides">
                  </div>
                  <div class="form-group">
                    <label>Unit of Measure *</label>
                    <input type="text" name="unit_of_measure" class="form-control" required
                      placeholder="e.g., pieces, ml, boxes">
                  </div>
                </div>
                <div class="form-group">
                  <label>Reorder Level (Minimum Stock) *</label>
                  <input type="number" name="reorder_level" class="form-control" required min="1"
                    placeholder="e.g., 100">
                </div>
                <button type="submit" class="btn btn-primary">Add Item</button>
              </form>
            </div>

            <!-- Record Purchase Section -->
            <div class="card">
              <h3>üì¶ Record Purchase</h3>
              <form id="record-purchase-form" onsubmit="handleRecordPurchase(event)">
                <div class="form-group">
                  <label>Select Item *</label>
                  <select name="item_id" id="purchase-item-select" class="form-control" required
                    onchange="updatePurchaseItemName()">
                    <option value="">-- Select Item --</option>
                  </select>
                  <input type="hidden" name="item_name" id="purchase-item-name">
                </div>

                <div class="grid-2">
                  <div class="form-group">
                    <label>Quantity *</label>
                    <input type="number" name="quantity" class="form-control" required min="1">
                  </div>
                  <div class="form-group">
                    <label>Unit Cost (KES) *</label>
                    <input type="number" name="unit_cost" class="form-control" required min="0" step="0.01">
                  </div>
                </div>

                <div class="form-group">
                  <label>Supplier</label>
                  <input type="text" name="supplier" class="form-control" placeholder="e.g., MedSupply Co.">
                </div>

                <div class="grid-2">
                  <div class="form-group">
                    <label>Manufacture Date *</label>
                    <input type="date" name="manufacture_date" class="form-control" required>
                  </div>
                  <div class="form-group">
                    <label>Expiry Date *</label>
                    <input type="date" name="expiry_date" class="form-control" required>
                  </div>
                </div>

                <div class="form-group">
                  <label>Batch Number</label>
                  <input type="text" name="batch_number" class="form-control" placeholder="e.g., BATCH-001">
                </div>

                <button type="submit" class="btn btn-primary">Record Purchase</button>
              </form>
            </div>

            <!-- Purchase History Table -->
            <div class="card">
              <h3>üìã Purchase History</h3>
              <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button onclick="filterPurchases('all')" class="btn"
                  style="width: auto; background: var(--primary); color: white;">All</button>
                <button onclick="filterPurchases('green')" class="btn"
                  style="width: auto; background: #22c55e; color: white;">Green</button>
                <button onclick="filterPurchases('yellow')" class="btn"
                  style="width: auto; background: #eab308; color: white;">Yellow</button>
                <button onclick="filterPurchases('orange')" class="btn"
                  style="width: auto; background: #f97316; color: white;">Orange</button>
                <button onclick="filterPurchases('expired')" class="btn"
                  style="width: auto; background: #ef4444; color: white;">Expired</button>
              </div>
              <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                <table id="purchase-history-table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Item</th>
                      <th>Quantity</th>
                      <th>Unit Cost</th>
                      <th>Total</th>
                      <th>Supplier</th>
                      <th>Mfg Date</th>
                      <th>Exp Date</th>
                      <th>Days to Expiry</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="10">Loading...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <button onclick="loadPurchaseHistory()" class="btn btn-primary"
                style="width: auto; margin-top: 1rem;">Refresh</button>
            </div>
          </div>

          <!-- Usage (Out) Tab Content -->
          <div id="usage-tab-content" class="inventory-tab-content" style="display: none;">

            <!-- Stock Level Statistics Dashboard -->
            <div class="card">
              <h3>üìä Stock Level Dashboard</h3>
              <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                <div
                  style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); padding: 1.5rem; border-radius: 12px; text-align: center; color: white;">
                  <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">GREEN (>40%)</div>
                  <div style="font-size: 2.5rem; font-weight: bold;" id="stock-green">0%</div>
                </div>
                <div
                  style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); padding: 1.5rem; border-radius: 12px; text-align: center; color: white;">
                  <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">ORANGE (30-40%)</div>
                  <div style="font-size: 2.5rem; font-weight: bold;" id="stock-orange">0%</div>
                </div>
                <div
                  style="background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%); padding: 1.5rem; border-radius: 12px; text-align: center; color: white;">
                  <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">YELLOW (10-30%)</div>
                  <div style="font-size: 2.5rem; font-weight: bold;" id="stock-yellow">0%</div>
                </div>
                <div
                  style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); padding: 1.5rem; border-radius: 12px; text-align: center; color: white;">
                  <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">RED (<10%)< /div>
                      <div style="font-size: 2.5rem; font-weight: bold;" id="stock-red">0%</div>
                  </div>
                </div>
              </div>

              <!-- Current Stock Levels Table -->
              <div class="card">
                <h3>üì¶ Current Stock Levels</h3>
                <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                  <button onclick="filterStock('all')" class="btn"
                    style="width: auto; background: var(--primary); color: white;">All</button>
                  <button onclick="filterStock('green')" class="btn"
                    style="width: auto; background: #22c55e; color: white;">Green</button>
                  <button onclick="filterStock('orange')" class="btn"
                    style="width: auto; background: #f97316; color: white;">Orange</button>
                  <button onclick="filterStock('yellow')" class="btn"
                    style="width: auto; background: #eab308; color: white;">Yellow</button>
                  <button onclick="filterStock('red')" class="btn"
                    style="width: auto; background: #ef4444; color: white;">Red</button>
                </div>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                  <table id="stock-levels-table">
                    <thead>
                      <tr>
                        <th>Item Name</th>
                        <th>Current Stock</th>
                        <th>Unit</th>
                        <th>Reorder Level</th>
                        <th>Stock %</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="6">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <button onclick="loadStockLevels()" class="btn btn-primary"
                  style="width: auto; margin-top: 1rem;">Refresh</button>
              </div>

              <!-- Usage History Table -->
              <div class="card">
                <h3>üìã Usage History</h3>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                  <table id="usage-history-table">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Item</th>
                        <th>Quantity Used</th>
                        <th>Test Name</th>
                        <th>Patient ID</th>
                        <th>Lab Order ID</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="6">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <button onclick="loadUsageHistory()" class="btn btn-primary"
                  style="width: auto; margin-top: 1rem;">Refresh</button>
              </div>
            </div>
          </div>

          <!-- Test Configuration Tab Content -->
          <div id="test-mapping-tab-content" class="inventory-tab-content" style="display: none;">
            <div class="card">
              <h3>üîó Configure Test-Item Mappings</h3>
              <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                Define which inventory items are consumed when each lab test is performed. This enables automatic
                inventory deduction.
              </p>

              <form id="test-mapping-form" onsubmit="handleAddTestMapping(event)">
                <div class="form-group">
                  <label>Test Name *</label>
                  <input type="text" name="test_name" id="mapping-test-name" class="form-control" required
                    placeholder="e.g., Blood Smear">
                </div>

                <div class="form-group">
                  <label>Select Item *</label>
                  <select name="item_id" id="mapping-item-select" class="form-control" required
                    onchange="updateMappingItemName()">
                    <option value="">-- Select Item --</option>
                  </select>
                  <input type="hidden" name="item_name" id="mapping-item-name">
                </div>

                <div class="form-group">
                  <label>Quantity Required *</label>
                  <input type="number" name="quantity_required" class="form-control" required min="1"
                    placeholder="e.g., 2">
                </div>

                <button type="submit" class="btn btn-primary">Add Mapping</button>
              </form>
            </div>

            <!-- Test Mappings Table -->
            <div class="card">
              <h3>üìã Current Test Mappings</h3>
              <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                <table id="test-mappings-table">
                  <thead>
                    <tr>
                      <th>Test Name</th>
                      <th>Item Name</th>
                      <th>Quantity Required</th>
                      <th>Created Date</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="5">Loading...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <button onclick="loadTestMappings()" class="btn btn-primary"
                style="width: auto; margin-top: 1rem;">Refresh</button>
            </div>
          </div>
        </div>


        <!--Testing -->

























        <!-- Receipt Modal -->
        <div id="receipt-modal"
          style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
          <div id="receipt-content"
            style="background:white; width:148mm; min-height:210mm; padding:20mm; box-shadow:0 4px 6px rgba(0,0,0,0.1); position:relative;">
            <button onclick="closeReceipt()"
              style="position:absolute; top:10px; right:10px; background:#dc3545; color:white; border:none; padding:5px 10px; cursor:pointer; border-radius:3px;">‚úï</button>
            <div id="receipt-body"></div>
            <div style="text-align:center; margin-top:20px;">
              <button onclick="printReceipt()" class="btn btn-primary" style="padding:10px 30px;">üñ®Ô∏è Print
                Receipt</button>
            </div>
          </div>
        </div>

    </main>
  </div>





  <script>
    // --- Navigation & Routing ---

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');

      sidebar.classList.toggle('open');

      // Show/hide overlay on mobile
      if (window.innerWidth <= 768) {
        if (sidebar.classList.contains('open')) {
          overlay.style.display = 'block';
        } else {
          overlay.style.display = 'none';
        }
      }
    }
    // Close sidebar when clicking a menu item on mobile
    document.addEventListener('DOMContentLoaded', function () {
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        item.addEventListener('click', function () {
          if (window.innerWidth <= 768) {
            setTimeout(() => {
              toggleSidebar();
            }, 100);
          }
        });
      });
    });





























    function navigate(viewId) {
      // Hide all views
      document.querySelectorAll('.view').forEach(el => {
        el.style.display = 'none';
      });

      // Show selected view
      const targetView = document.getElementById(viewId);
      if (targetView) {
        targetView.style.display = 'block';
      }

      // Update sidebar active state
      const links = document.querySelectorAll('.sidebar a.nav-item');
      links.forEach(link => link.classList.remove('active'));

      const activeLink = document.querySelector(`a[onclick*="navigate('${viewId}')"]`);
      if (activeLink) {
        activeLink.classList.add('active');
      }

      // Load data if needed
      if (viewId === 'dashboard') {
        loadDashboardMetrics(); // Load statistics and live queues
      } else if (viewId === 'registration') {
        // Registration page loads recent patients automatically
      } else if (viewId === 'triage') {
        loadTriageQueue();
      } else if (viewId === 'diagnosis') {
        // These functions are now handled by 'treatment' view
        // loadWaitingList();
        // loadPendingLabResults(); // Load pending lab results queue
        // loadICD11Codes(); // Add this line
      } else if (viewId === 'treatment') { // Added 'treatment' view
        loadPendingLabResults();
        loadWaitingList();
        loadPendingLabResults(); // Load pending lab results queue
        loadICD11Codes(); // Add this line
      } else if (viewId === 'lab') {
        loadLabOrders();
      } else if (viewId === 'lab-inventory') {
        switchInventoryTab('purchase');
      } else if (viewId === 'finance') {
        loadPendingBills();

        //Testing
      } else if (viewId === 'family-planning') {    // <-- ADD THIS
        showFPTab('client-details');                // <-- ADD THIS


      } else if (viewId === 'calendar') {
        loadCalendarEvents();
      } else if (viewId === 'reports') {
        loadStatistics();
      }







    }
  </script>

  <!-- Login Overlay (Hidden by default) -->
  <div id="login-overlay"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; justify-content:center; align-items:center; flex-direction:column;">
    <div
      style="background:white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1); max-width: 400px; width: 90%; padding: 40px; text-align: center;">
      <h2 style="color:red; margin-top:0; font-size: 24px;">‚õî Access Restricted</h2>
      <p style="color:#666; margin-bottom: 20px;">You must be logged in to access this system.</p>

      <div id="login-form-container">
        <!-- Login Form Injected Here -->
        <h4 style="margin-bottom:10px;">üîê Staff Login</h4>
        <p style="font-size:13px; color:#999; margin-bottom:15px;">Enter registered email address.</p>

        <div style="display:flex; flex-direction:column; gap:10px;">
          <!-- Step 1: Email -->
          <div id="login-step-1">
            <input type="email" id="manual-login-email" placeholder="Enter your email" class="form-control"
              style="width:100%; margin-bottom:10px;">
            <button onclick="initiateLogin()" class="btn btn-primary" style="width:100%;">Send Verification
              Code</button>
          </div>

          <!-- Step 2: Code -->
          <div id="login-step-2" style="display:none;">
            <p style="font-size:13px; color:#2370b8; margin-bottom:10px;">Code sent! Check your email.</p>
            <input type="text" id="manual-login-code" placeholder="Enter 6-digit code" class="form-control"
              style="width:100%; margin-bottom:10px; font-weight:bold; letter-spacing:2px; text-align:center;">
            <button onclick="submitVerification()" class="btn btn-primary" style="width:100%;">Verify & Login</button>
            <button onclick="resetLogin()" class="btn"
              style="width:100%; background:none; color:#666; margin-top:5px; font-size:12px;">Back</button>
          </div>
        </div>
        <div id="login-feedback" style="margin-top:10px; font-weight:bold; min-height: 20px;"></div>
      </div>
    </div>
  </div>

  <script>
    // --- Navigation & Routing ---
    // (Existing navigation code...)

    // Load user access and filter menu
    window.onload = function () {
      const cachedToken = localStorage.getItem('authToken') || localStorage.getItem('userEmail');

      google.script.run
        .withSuccessHandler(function (access) {
          console.log('User access:', access);

          window.userAccess = access;
          const moduleCount = (access.modules || []).length;

          // LOGIN LOGIC: Toggle Screens
          const appContainer = document.querySelector('.app-container');
          const loginOverlay = document.getElementById('login-overlay');

          if (moduleCount > 0) {
            // AUTHORIZED
            console.log('User authorized. Showing App.');
            if (appContainer) appContainer.style.display = 'flex';
            if (loginOverlay) loginOverlay.style.display = 'none';

            // User Info Display
            const userDisplay = document.getElementById('user-display');
            if (userDisplay) {
              userDisplay.innerHTML = `<span>${access.role} (${moduleCount} modules) | ${access.email}</span>`;
            }

            // Filter UI
            filterMenuByRole(access.modules);
            filterDashboardButtons(access.modules);

            navigate('dashboard');
          } else {
            // UNAUTHORIZED
            console.warn('User unauthorized. Showing Login Overlay.');
            if (appContainer) appContainer.style.display = 'none'; // Hide App
            if (loginOverlay) loginOverlay.style.display = 'flex'; // Show Login
          }
        })
        .withFailureHandler(function (error) {
          console.error('Error loading user access:', error);
          // Default to locked out on error
          const appContainer = document.querySelector('.app-container');
          const loginOverlay = document.getElementById('login-overlay');
          if (appContainer) appContainer.style.display = 'none';
          if (loginOverlay) {
            loginOverlay.style.display = 'flex';
            document.getElementById('login-feedback').textContent = "Connection Error: " + error.message;
            document.getElementById('login-feedback').style.color = 'red';
          }
        })
        .getUserAccess(cachedToken);
    };


    window.handleManualLogin = function () {
      const emailField = document.getElementById('manual-login-email');
      const email = emailField ? emailField.value : '';
      const feedback = document.getElementById('login-feedback');

      if (!email) {
        if (feedback) feedback.textContent = "Please enter an email address.";
        if (feedback) feedback.style.color = "red";
        return;
      }

      if (feedback) feedback.textContent = "Verifying...";
      if (feedback) feedback.style.color = "blue";

      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success) {
            localStorage.setItem('authToken', result.token);
            localStorage.setItem('userEmail', email);
            if (feedback) feedback.textContent = "Success! Reloading...";
            if (feedback) feedback.style.color = "green";
            setTimeout(() => window.location.reload(), 1000);
          } else {
            if (feedback) feedback.textContent = "Error: " + result.message;
            if (feedback) feedback.style.color = "red";
          }
        })
        .withFailureHandler(function (e) {
          if (feedback) feedback.textContent = "System Error: " + e.message;
          if (feedback) feedback.style.color = "red";
        })
        .authenticateUser(email);
    };








    // RBAC for SIDEBAR

    function filterMenuByRole(allowedModules) {
      console.log('Filtering menu for modules:', allowedModules);
      const menuItems = document.querySelectorAll('.sidebar a.nav-item');

      menuItems.forEach(item => {
        const onclick = item.getAttribute('onclick');
        if (!onclick) return;

        // Extract module name from onclick="navigate('modulename')"
        const match = onclick.match(/navigate\('([^']+)'\)/);
        if (!match) return;

        const moduleName = match[1];

        // Hide if not in allowed modules
        if (!allowedModules || !allowedModules.includes(moduleName)) {
          console.log('Hiding module:', moduleName);
          item.style.display = 'none';
        } else {
          console.log('Showing module:', moduleName);
          item.style.display = 'flex'; // Matches CSS .nav-item { display: flex }
        }
      });
    }


    // RBAC for DASHBOARD

    function filterDashboardButtons(allowedModules) {
      console.log('Filtering dashboard buttons for modules:', allowedModules);
      // Get all dashboard quick-access buttons
      const dashboardButtons = document.querySelectorAll('#dashboard button[onclick*="navigate"]');

      dashboardButtons.forEach(button => {
        const onclick = button.getAttribute('onclick');
        if (!onclick) return;

        // Extract module name from onclick="navigate('modulename')"
        const match = onclick.match(/navigate\('([^']+)'\)/);
        if (!match) return;

        const moduleName = match[1];

        // Hide if not in allowed modules
        if (!allowedModules || !allowedModules.includes(moduleName)) {
          button.style.display = 'none';
        } else {
          button.style.display = 'inline-block';
        }
      });
    }











    function logout() {
      // Show custom confirmation modal instead of browser confirm
      document.getElementById('logout-confirm-modal').style.display = 'flex';
    }
    function cancelLogout() {
      // Hide the confirmation modal
      document.getElementById('logout-confirm-modal').style.display = 'none';
    }
    function confirmLogout() {
      // Hide confirmation modal
      document.getElementById('logout-confirm-modal').style.display = 'none';

      // Hide the main app
      const appContainer = document.querySelector('.app-container');
      if (appContainer) {
        appContainer.style.display = 'none';
      }

      // Show custom logout screen
      const logoutScreen = document.getElementById('logout-message');
      if (!logoutScreen) {
        console.error('Logout message div not found');
        showAlert('Logged out. Please refresh the page.', 'Logged Out', 'üö™');
        return;
      }

      logoutScreen.style.display = 'flex';
      logoutScreen.innerHTML = `
    <div style="background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 500px; width: 90%; padding: 50px 40px; text-align: center; animation: slideUp 0.5s ease-out;">
      <img src="https://lh3.googleusercontent.com/d/12Ef6QK7k4iXtyzOtzaFA1BwEcHb6cDgc" 
           alt="Makele Digital Clinic Logo" 
           style="width: 120px; height: auto; margin: 0 auto 30px; border-radius: 8px; box-shadow: 0 8px 20px rgba(35, 112, 184, 0.3);">
      
      <h2 style="color: #2370b8; font-size: 28px; font-weight: 700; margin-bottom: 10px;">Makele Digital Clinic</h2>
      <div style="color: #28a745; font-size: 16px; font-weight: 600; margin-bottom: 30px;">‚úì You have been logged out successfully</div>
      
      <div style="background: #f0f7ff; padding: 20px; border-radius: 12px; margin: 20px 0;">
        <p style="color: #666; font-size: 14px; margin: 0;">Your session has ended. Click below to log in again.</p>
      </div>
      
      <button onclick="reloadApp()" 
              style="background: #2370b8; color: white; border: none; border-radius: 12px; padding: 16px 40px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 20px; width: 100%;">
        üîê Log In Again
      </button>
      
      <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0; color: #999; font-size: 12px;">
        ¬© 2025 Makele Digital Clinic. All rights reserved.
      </div>
    </div>
    
    <style>
      @keyframes slideUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
  `;
    }









    function reloadApp() {
      // Show the app container again
      const appContainer = document.querySelector('.app-container');
      if (appContainer) {
        appContainer.style.display = 'flex';
      }

      // Hide logout screen
      const logoutScreen = document.getElementById('logout-message');
      if (logoutScreen) {
        logoutScreen.style.display = 'none';
      }

      // Navigate to dashboard
      navigate('dashboard');
    }

    // Custom Alert and Confirm Functions
    function showAlert(message, title, icon) {
      const modal = document.getElementById('custom-alert-modal');
      const titleEl = document.getElementById('alert-title');
      const messageEl = document.getElementById('alert-message');
      const iconEl = document.getElementById('alert-icon');

      titleEl.textContent = title || 'Notice';
      messageEl.textContent = message;
      iconEl.textContent = icon || '‚ÑπÔ∏è';

      modal.style.display = 'flex';
    }

    function closeAlert() {
      document.getElementById('custom-alert-modal').style.display = 'none';
    }

    let confirmCallback = null;

    function showConfirm(message, title, icon) {
      return new Promise(function (resolve) {
        const modal = document.getElementById('custom-confirm-modal');
        const titleEl = document.getElementById('confirm-title');
        const messageEl = document.getElementById('confirm-message');
        const iconEl = document.getElementById('confirm-icon');

        titleEl.textContent = title || 'Confirm Action';
        messageEl.textContent = message;
        iconEl.textContent = icon || '‚ùì';

        confirmCallback = resolve;
        modal.style.display = 'flex';
      });
    }

    function closeConfirm(result) {
      document.getElementById('custom-confirm-modal').style.display = 'none';
      if (confirmCallback) {
        confirmCallback(result);
        confirmCallback = null;
      }
    }









    // County/Sub-County Cascading Dropdown
    function updateSubCounties() {
      const countySelect = document.getElementById('county-select');
      const subcountySelect = document.getElementById('subcounty-select');
      const selectedCounty = countySelect.value;

      // Clear existing options
      subcountySelect.innerHTML = '';
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Select Sub-County...';
      subcountySelect.appendChild(defaultOption);

      // Define sub-counties for each county
      const subCounties = {
        'Machakos': [
          'Machakos Town',
          'Mavoko',
          'Masinga',
          'Yatta',
          'Kangundo',
          'Kathiani',
          'Matungulu',
          'Mwala'
        ],
        'Kitui': [
          'Kitui Central',
          'Kitui East',
          'Kitui Rural',
          'Kitui South',
          'Kitui West',
          'Mwingi Central',
          'Mwingi North',
          'Mwingi West'
        ],
        'Makueni': [
          'Kaiti',
          'Kilome',
          'Kibwezi East',
          'Kibwezi West',
          'Nzaui',
          'Kathonzweni',
          'Mbooni'
        ]
      };

      // Populate sub-counties if county is selected
      if (selectedCounty && subCounties[selectedCounty]) {
        subCounties[selectedCounty].forEach(function (subcounty) {
          const option = document.createElement('option');
          option.value = subcounty;
          option.textContent = subcounty;
          subcountySelect.appendChild(option);
        });
      }
    }

    // --- Registration Logic ---
    function handleRegistration(e) {
      e.preventDefault();
      const form = e.target;
      const btn = form.querySelector('button[type="submit"]');
      const loader = document.getElementById('reg-loader');

      if (btn) btn.style.display = 'none';
      if (loader) loader.style.display = 'block';

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      console.log('Registering patient:', data);

      google.script.run
        .withFailureHandler(function (error) {
          console.error('Registration error:', error);
          if (loader) loader.style.display = 'none';
          if (btn) btn.style.display = 'block';
          showAlert('Error: ' + error.message, 'Error', '‚ùå');
        })
        .withSuccessHandler(function (response) {
          if (loader) loader.style.display = 'none';
          if (btn) btn.style.display = 'block';

          if (response.success) {
            showAlert('Patient registered successfully!\nID: ' + response.patientId, 'Success', '‚úÖ');
            form.reset();
            loadRecentPatients();
          } else {
            showAlert('Error: ' + response.message, 'Error', '‚ùå');
          }
        })
        .registerPatient(data);
    }

    function loadRecentPatients() {
      const tbody = document.querySelector('#patients-table tbody');
      tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';


      google.script.run
        .withFailureHandler(function (error) {
          tbody.innerHTML = `<tr><td colspan="5" style="color:red;">Error: ${error.message}</td></tr>`;
        })
        .withSuccessHandler(function (patients) {
          tbody.innerHTML = '';
          if (patients.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">No recent registrations.</td></tr>';
            return;
          }
          patients.forEach(p => {
            const row = `<tr>
          <td>${p.patient_id}</td>
          <td>${p.first_name} ${p.last_name}</td>
          <td>${p.phone_number}</td>
          <td>${p.gender}</td>
          <td>${new Date(p.registration_date).toLocaleDateString()}</td>
        </tr>`;
            tbody.innerHTML += row;
          });
        }).getRecentPatients();
    }

    // --- Triage Logic ---
    function runPatientSearch() {
      const query = document.getElementById('patient-search-input').value;
      if (!query) return showAlert('Please enter a search term', 'Notice', '‚ÑπÔ∏è');

      const tbody = document.querySelector('#search-results-table tbody');
      tbody.innerHTML = '<tr><td colspan="4">Searching...</td></tr>';
      document.getElementById('search-results').style.display = 'block';

      google.script.run
        .withFailureHandler(function (err) {
          tbody.innerHTML = `<tr><td colspan="4" style="color:red;">Error: ${err.message}</td></tr>`;
        })
        .withSuccessHandler(function (results) {
          tbody.innerHTML = '';
          if (results.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4">No patients found.</td></tr>';
            return;
          }
          results.forEach(p => {
            const row = `<tr>
          <td>${p.patient_id}</td>
          <td>${p.first_name} ${p.last_name}</td>
          <td>${p.phone_number}</td>
          <td><button class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="selectPatientTriage('${p.patient_id}', '${p.first_name} ${p.last_name}')">Select</button></td>
        </tr>`;
            tbody.innerHTML += row;
          });
        }).searchPatient(query);
    }

    function loadTriageQueue() {
      const tbody = document.querySelector('#triage-queue-table tbody');
      tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';

      google.script.run
        .withFailureHandler(function (err) {
          tbody.innerHTML = `<tr><td colspan="4" style="color:red;">Error: ${err.message}</td></tr>`;
        })
        .withSuccessHandler(function (patients) {
          tbody.innerHTML = '';
          if (patients.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4">No recent patients found.</td></tr>';
            return;
          }
          patients.forEach(p => {
            const row = `<tr>
          <td>${p.patient_id}</td>
          <td>${p.first_name} ${p.last_name}</td>
          <td>${p.gender}</td>
          <td><button class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="selectPatientTriage('${p.patient_id}', '${p.first_name} ${p.last_name}')">Triage</button></td>
        </tr>`;
            tbody.innerHTML += row;
          });
        }).getPatientsForTriage();
    }

    function selectPatientTriage(id, name) {
      document.getElementById('triage-search-section').style.display = 'none';
      document.getElementById('triage-form-section').style.display = 'block';
      document.getElementById('triage-patient-name').innerText = name;
      document.getElementById('triage-patient-id').innerText = id;
      document.getElementById('triage-patient-id-input').value = id;
    }

    function resetTriage() {
      document.getElementById('triage-form-section').style.display = 'none';
      document.getElementById('triage-search-section').style.display = 'block';
      document.getElementById('triage-form').reset();
      document.getElementById('bmi-display').value = '';
    }

    function calculateBMI() {
      const w = parseFloat(document.getElementById('weight').value);
      const h = parseFloat(document.getElementById('height').value);
      if (w && h) {
        const bmi = (w / ((h / 100) * (h / 100))).toFixed(1);
        document.getElementById('bmi-display').value = bmi;
      }
    }

    function handleTriageSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const btn = form.querySelector('button[type="submit"]');
      const loader = document.getElementById('triage-loader');

      btn.style.display = 'none';
      loader.style.display = 'block';

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      google.script.run.withSuccessHandler(function (res) {
        loader.style.display = 'none';
        btn.style.display = 'block';
        if (res.success) {
          showAlert('Triage record saved successfully!', 'Success', '‚úÖ');
          resetTriage();
        }
      }).saveTriageRecord(data);
    }

    // --- Diagnosis Logic ---

    function loadWaitingList() {
      const tbody = document.querySelector('#waiting-list-table tbody');
      tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';

      google.script.run.withSuccessHandler(function (list) {
        tbody.innerHTML = '';
        if (list.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5">No patients waiting.</td></tr>';
          return;
        }
        list.forEach(item => {
          const time = new Date(item.triage_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const row = `<tr>
          <td>${time}</td>
          <td>${item.patient_name}</td>
          <td style="color:${item.priority === 'Red' ? 'red' : 'black'}">${item.priority}</td>
          <td>${item.chief_complain || 'N/A'}</td>
          <td><button class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="startConsultation('${item.encounter_id}', '${item.patient_id}', '${item.patient_name}', '${item.chief_complain}')">Consult</button></td>
        </tr>`;
          tbody.innerHTML += row;
        });
      }).getPendingTriage();
    }







    // Load Pending Lab Results Queue
    function loadPendingLabResults() {
      const tbody = document.querySelector('#pending-lab-results-table tbody');
      tbody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';

      google.script.run
        .withSuccessHandler(function (queue) {
          tbody.innerHTML = '';

          if (queue.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999;">No patients with pending lab results</td></tr>';
            return;
          }

          queue.forEach(function (item) {
            const date = new Date(item.consultation_date).toLocaleDateString();
            const labStatus = item.all_resulted
              ? '<span style="color: green;">‚úÖ ' + item.resulted_count + '/' + item.lab_count + ' Complete</span>'
              : '<span style="color: orange;">‚è≥ ' + item.resulted_count + '/' + item.lab_count + ' Partial</span>';

            const row = document.createElement('tr');
            row.innerHTML =
              '<td>' + date + '</td>' +
              '<td>' + item.patient_name + '</td>' +
              '<td><strong>' + item.diagnosis_code + '</strong></td>' +
              '<td>' + item.diagnosis_desc + '</td>' +
              '<td>' + labStatus + '</td>' +
              '<td>' +
              '<button onclick="openLabReviewModal(\'' + item.treatment_id + '\', \'' + item.encounter_id + '\')" ' +
              'class="btn btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">' +
              'üëÅÔ∏è Review Results' +
              '</button>' +
              '</td>';
            tbody.appendChild(row);
          });
        })
        .withFailureHandler(function (error) {
          tbody.innerHTML = '<tr><td colspan="6" style="color:red;">Error loading queue: ' + error.message + '</td></tr>';
        })
        .getPendingLabResultsQueue();
    }

    // Open Lab Review Modal
    function openLabReviewModal(treatmentId, encounterId) {
      console.log('Opening lab review modal for treatment:', treatmentId, 'encounter:', encounterId);
      const modal = document.getElementById('lab-review-modal');
      if (!modal) {
        console.error('lab-review-modal not found!');
        showAlert('Error: Lab review modal not found. Please refresh the page.', 'Error', '‚ùå');
        return;
      }

      // Show modal immediately with loading state
      modal.style.display = 'block';

      // Get the results list element
      const resultsList = document.getElementById('lab-results-list');
      if (!resultsList) {
        console.error('lab-results-list not found!');
        showAlert('Error: Lab results display area not found. Please refresh the page.', 'Error', '‚ùå');
        modal.style.display = 'none';
        return;
      }

      resultsList.innerHTML = '<p style="text-align:center; padding:20px;">Loading lab results...</p>';

      // Set hidden fields
      document.getElementById('finalize-treatment-id').value = treatmentId;
      document.getElementById('finalize-encounter-id').value = encounterId;

      // Reset patient info while loading
      document.getElementById('review-patient-name').textContent = 'Loading...';
      document.getElementById('final-diagnosis-code').value = '';
      document.getElementById('final-diagnosis-desc').value = '';

      // Load lab results
      google.script.run
        .withSuccessHandler(function (response) {
          console.log('=== LAB RESULTS RESPONSE ===');
          console.log('Response:', response);
          console.log('Response type:', typeof response);
          console.log('Response.success:', response ? response.success : 'response is null/undefined');
          console.log('Response.results:', response ? response.results : 'response is null/undefined');

          if (!response || !response.success) {
            const errorMsg = 'Error loading lab results: ' + (response ? response.message : 'No response from server');
            console.error(errorMsg);
            showAlert(errorMsg, 'Error', '‚ùå');
            resultsList.innerHTML = '<p style="color:red; text-align:center;">Error loading results.</p>';
            return;
          }

          console.log('Success! Total results:', response.results ? response.results.length : 0);

          // Display lab results
          resultsList.innerHTML = '';

          if (!response.results || response.results.length === 0) {
            resultsList.innerHTML = '<p style="color:#999; text-align:center; padding:20px;">No lab results found for this encounter.</p>';
          } else {
            response.results.forEach(function (lab, index) {
              console.log('Processing lab result ' + (index + 1) + ':', lab);
              const resultDiv = document.createElement('div');
              resultDiv.style.cssText = 'background: #f9f9f9; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; border-left: 4px solid #2370b8;';

              let flagColor = lab.abnormal_flag === 'High' ? 'red' : (lab.abnormal_flag === 'Low' ? 'blue' : 'green');

              let html = '<h5 style="margin-top: 0;">' + (index + 1) + '. ' + lab.test_name + '</h5>';
              html += '<p style="margin: 0.5rem 0;"><strong>Result:</strong> ' + lab.result_value + ' ' + lab.result_units + ' ';
              html += '<span style="color: ' + flagColor + '; font-weight: bold;">(' + lab.abnormal_flag + ')</span></p>';

              if (lab.reference_range) {
                html += '<p style="margin: 0.5rem 0;"><strong>Reference Range:</strong> ' + lab.reference_range + '</p>';
              }

              if (lab.detailed_description) {
                html += '<p style="margin: 0.5rem 0;"><strong>Description:</strong> ' + lab.detailed_description + '</p>';
              }

              if (lab.file_url) {
                html += '<p style="margin: 0.5rem 0;"><a href="' + lab.file_url + '" target="_blank" class="btn btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">üìÑ View File</a></p>';
              }

              resultDiv.innerHTML = html;
              resultsList.appendChild(resultDiv);
            });
          }
        })
        .withFailureHandler(function (error) {
          console.error('=== LAB RESULTS FAILURE ===');
          console.error('Error object:', error);
          console.error('Error message:', error.message);
          console.error('Error stack:', error.stack);
          showAlert('Error: ' + error.message, 'Error', '‚ùå');
          resultsList.innerHTML = '<p style="color:red; text-align:center;">Failed to load lab results.</p>';
        })
        .getLabResultsForConsultation(encounterId);

      console.log('Called getLabResultsForConsultation with encounterId:', encounterId);

      // Also load patient info from the queue
      google.script.run
        .withSuccessHandler(function (queue) {
          if (!queue || !Array.isArray(queue)) {
            console.warn('getPendingLabResultsQueue returned non-array:', queue);
            return;
          }
          const patient = queue.find(p => p.treatment_id == treatmentId); // Use loose equality for safety
          if (patient) {
            document.getElementById('review-patient-name').textContent = patient.patient_name;
            document.getElementById('review-patient-id').textContent = patient.patient_id;
            document.getElementById('review-diagnosis-code').textContent = patient.diagnosis_code;
            document.getElementById('review-diagnosis-desc').textContent = patient.diagnosis_desc;
            document.getElementById('review-consultation-date').textContent = new Date(patient.consultation_date).toLocaleString();

            // Pre-populate final diagnosis fields
            document.getElementById('final-diagnosis-code').value = patient.diagnosis_code || '';
            document.getElementById('final-diagnosis-desc').value = patient.diagnosis_desc || '';
          }
        })
        .getPendingLabResultsQueue();

      // Scroll modal to top
      modal.scrollTop = 0;
    }

    // Close Lab Review Modal
    function closeLabReviewModal() {
      document.getElementById('lab-review-modal').style.display = 'none';
      document.getElementById('finalize-consultation-form').reset();
    }

    // Handle Finalize Consultation
    function handleFinalizeConsultation(event) {
      event.preventDefault();

      const form = event.target;
      const btn = document.getElementById('finalize-btn');

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      btn.textContent = 'Saving...';
      btn.disabled = true;

      google.script.run
        .withSuccessHandler(function (response) {
          btn.textContent = 'Save & Finalize Consultation';
          btn.disabled = false;

          if (response.success) {
            showAlert('Consultation finalized successfully! Patient can now proceed to billing.', 'Success', '‚úÖ');
            closeLabReviewModal();
            loadPendingLabResults(); // Refresh the queue
            loadWaitingList(); // Refresh waiting list
          } else {
            showAlert('Error: ' + response.message, 'Error', '‚ùå');
          }
        })
        .withFailureHandler(function (error) {
          btn.textContent = 'Save & Finalize Consultation';
          btn.disabled = false;
          showAlert('Error: ' + error.message, 'Error', '‚ùå');
        })
        .finalizeConsultation(data);
    }

    // ICD 11 Codes

    // ========================================
    // ICD-11 AUTOCOMPLETE LOGIC
    // ========================================

    // Common ICD-11 Codes for Offline/Fast Access
    // Extracted from ICD11Codes.js (Full Seed List)
    const COMMON_ICD11_CODES = [
      // INFECTIOUS
      { code: '1C62.Z', description: 'Malaria, unspecified', category: 'Infectious', common_name: 'Malaria' },
      { code: '1C62.0', description: 'Plasmodium falciparum malaria', category: 'Infectious', common_name: 'Severe malaria' },
      { code: '1C62.1', description: 'Plasmodium vivax malaria', category: 'Infectious', common_name: 'Vivax malaria' },
      { code: '1C62.2', description: 'Plasmodium ovale malaria', category: 'Infectious', common_name: 'Ovale malaria' },
      { code: '1C62.3', description: 'Plasmodium malariae malaria', category: 'Infectious', common_name: 'Malariae malaria' },
      { code: '1C1Z', description: 'Tuberculosis, unspecified', category: 'Infectious', common_name: 'TB' },
      { code: '1C10', description: 'Pulmonary tuberculosis', category: 'Infectious', common_name: 'Lung TB' },
      { code: '1C11', description: 'Extrapulmonary tuberculosis', category: 'Infectious', common_name: 'TB outside lungs' },
      { code: '1A40.0', description: 'Typhoid fever', category: 'Infectious', common_name: 'Typhoid' },
      { code: '1A40.1', description: 'Paratyphoid fever A', category: 'Infectious', common_name: 'Paratyphoid' },
      { code: '1A00', description: 'Cholera', category: 'Infectious', common_name: 'Cholera' },
      { code: '1A01', description: 'Shigellosis', category: 'Infectious', common_name: 'Dysentery' },
      { code: '1A02', description: 'Salmonellosis', category: 'Infectious', common_name: 'Salmonella infection' },
      { code: '1A03', description: 'Amoebiasis', category: 'Infectious', common_name: 'Amoeba' },
      { code: '1A04', description: 'Giardiasis', category: 'Infectious', common_name: 'Giardia' },
      { code: '1C60', description: 'HIV disease', category: 'Infectious', common_name: 'HIV/AIDS' },
      { code: '1C62.Y', description: 'Other specified malaria', category: 'Infectious', common_name: 'Other malaria' },
      { code: '1E50', description: 'Acute upper respiratory infections', category: 'Infectious', common_name: 'URTI' },
      { code: '1E51', description: 'Acute pharyngitis', category: 'Infectious', common_name: 'Sore throat' },
      { code: '1E52', description: 'Acute tonsillitis', category: 'Infectious', common_name: 'Tonsillitis' },
      { code: '1E53', description: 'Acute laryngitis', category: 'Infectious', common_name: 'Laryngitis' },
      { code: '1E54', description: 'Acute sinusitis', category: 'Infectious', common_name: 'Sinusitis' },
      { code: '1F03.Z', description: 'Diarrhoea, unspecified', category: 'Infectious', common_name: 'Diarrhea' },
      { code: '1F00', description: 'Gastroenteritis', category: 'Infectious', common_name: 'Stomach flu' },
      { code: '1F01', description: 'Infectious gastroenteritis', category: 'Infectious', common_name: 'Infectious diarrhea' },
      { code: '9A00.0', description: 'Conjunctivitis, unspecified', category: 'Infectious', common_name: 'Pink eye' },
      { code: '9A01', description: 'Bacterial conjunctivitis', category: 'Infectious', common_name: 'Bacterial eye infection' },
      { code: '9A02', description: 'Viral conjunctivitis', category: 'Infectious', common_name: 'Viral eye infection' },
      { code: '1B90', description: 'Measles', category: 'Infectious', common_name: 'Measles' },
      { code: '1B91', description: 'Rubella', category: 'Infectious', common_name: 'German measles' },
      { code: '1B92', description: 'Chickenpox', category: 'Infectious', common_name: 'Chickenpox' },
      { code: '1B93', description: 'Mumps', category: 'Infectious', common_name: 'Mumps' },
      { code: '1B94', description: 'Whooping cough', category: 'Infectious', common_name: 'Pertussis' },
      { code: '1C30', description: 'Hepatitis A', category: 'Infectious', common_name: 'Hep A' },
      { code: '1C31', description: 'Hepatitis B', category: 'Infectious', common_name: 'Hep B' },
      { code: '1C32', description: 'Hepatitis C', category: 'Infectious', common_name: 'Hep C' },
      { code: '1D40', description: 'Scabies', category: 'Infectious', common_name: 'Scabies' },
      { code: '1D41', description: 'Pediculosis', category: 'Infectious', common_name: 'Lice' },
      { code: '1D42', description: 'Ringworm', category: 'Infectious', common_name: 'Fungal infection' },
      { code: '1D43', description: 'Candidiasis', category: 'Infectious', common_name: 'Yeast infection' },
      { code: '1E60', description: 'Pneumonia, organism unspecified', category: 'Infectious', common_name: 'Pneumonia' },
      { code: '1E61', description: 'Bacterial pneumonia', category: 'Infectious', common_name: 'Bacterial pneumonia' },
      { code: '1E62', description: 'Viral pneumonia', category: 'Infectious', common_name: 'Viral pneumonia' },
      { code: 'DA0E', description: 'Acute bronchitis', category: 'Infectious', common_name: 'Bronchitis' },
      { code: 'DA0F', description: 'Chronic bronchitis', category: 'Infectious', common_name: 'Chronic bronchitis' },
      { code: '1G00', description: 'Meningitis, unspecified', category: 'Infectious', common_name: 'Meningitis' },
      { code: '1G01', description: 'Bacterial meningitis', category: 'Infectious', common_name: 'Bacterial meningitis' },
      { code: '1G02', description: 'Viral meningitis', category: 'Infectious', common_name: 'Viral meningitis' },
      { code: '1F20', description: 'Helminthiasis', category: 'Infectious', common_name: 'Worm infection' },
      { code: '1F21', description: 'Ascariasis', category: 'Infectious', common_name: 'Roundworm' },
      // CARDIOVASCULAR
      { code: 'CA40.0', description: 'Essential hypertension', category: 'Cardiovascular', common_name: 'High blood pressure' },
      { code: 'CA40.1', description: 'Secondary hypertension', category: 'Cardiovascular', common_name: 'Secondary hypertension' },
      { code: 'CA40', description: 'Hypertensive diseases', category: 'Cardiovascular', common_name: 'Hypertension' },
      { code: 'BA00', description: 'Heart failure', category: 'Cardiovascular', common_name: 'Heart failure' },
      { code: 'BA01', description: 'Congestive heart failure', category: 'Cardiovascular', common_name: 'CHF' },
      { code: 'BA10', description: 'Ischaemic heart disease', category: 'Cardiovascular', common_name: 'Heart disease' },
      { code: 'BA11', description: 'Angina pectoris', category: 'Cardiovascular', common_name: 'Angina' },
      { code: 'BA20', description: 'Myocardial infarction', category: 'Cardiovascular', common_name: 'Heart attack' },
      { code: 'BA30', description: 'Cardiac arrhythmia', category: 'Cardiovascular', common_name: 'Irregular heartbeat' },
      { code: 'BA31', description: 'Atrial fibrillation', category: 'Cardiovascular', common_name: 'AFib' },
      { code: 'BA40', description: 'Valvular heart disease', category: 'Cardiovascular', common_name: 'Heart valve problem' },
      { code: 'BA50', description: 'Cardiomyopathy', category: 'Cardiovascular', common_name: 'Weak heart muscle' },
      { code: 'BB00', description: 'Stroke', category: 'Cardiovascular', common_name: 'Stroke' },
      { code: 'BB01', description: 'Ischaemic stroke', category: 'Cardiovascular', common_name: 'Ischemic stroke' },
      { code: 'BB02', description: 'Haemorrhagic stroke', category: 'Cardiovascular', common_name: 'Bleeding stroke' },
      { code: 'BB10', description: 'Transient ischaemic attack', category: 'Cardiovascular', common_name: 'Mini stroke' },
      { code: 'BC00', description: 'Peripheral vascular disease', category: 'Cardiovascular', common_name: 'PVD' },
      { code: 'BC01', description: 'Atherosclerosis', category: 'Cardiovascular', common_name: 'Hardened arteries' },
      { code: 'BC10', description: 'Deep vein thrombosis', category: 'Cardiovascular', common_name: 'DVT' },
      { code: 'BC11', description: 'Pulmonary embolism', category: 'Cardiovascular', common_name: 'Blood clot in lung' },
      { code: 'BC20', description: 'Varicose veins', category: 'Cardiovascular', common_name: 'Varicose veins' },
      { code: 'BD00', description: 'Rheumatic heart disease', category: 'Cardiovascular', common_name: 'Rheumatic heart' },
      { code: 'BD01', description: 'Rheumatic fever', category: 'Cardiovascular', common_name: 'Rheumatic fever' },
      { code: 'BE00', description: 'Pericarditis', category: 'Cardiovascular', common_name: 'Heart sac inflammation' },
      { code: 'BE01', description: 'Myocarditis', category: 'Cardiovascular', common_name: 'Heart muscle inflammation' },
      { code: 'BE02', description: 'Endocarditis', category: 'Cardiovascular', common_name: 'Heart lining inflammation' },
      { code: 'CA41', description: 'Hypertensive heart disease', category: 'Cardiovascular', common_name: 'Hypertensive heart' },
      { code: 'CA42', description: 'Hypertensive kidney disease', category: 'Cardiovascular', common_name: 'Hypertensive kidney' },
      { code: 'CA43', description: 'Hypertensive crisis', category: 'Cardiovascular', common_name: 'Severe high BP' },
      { code: 'CA44', description: 'Pre-eclampsia', category: 'Cardiovascular', common_name: 'Pregnancy high BP' },
      // ENDOCRINE
      { code: '5A11', description: 'Type 2 diabetes mellitus', category: 'Endocrine', common_name: 'Diabetes type 2' },
      { code: '5A10', description: 'Type 1 diabetes mellitus', category: 'Endocrine', common_name: 'Diabetes type 1' },
      { code: '5A1Z', description: 'Diabetes mellitus, unspecified', category: 'Endocrine', common_name: 'Diabetes' },
      { code: '5A12', description: 'Gestational diabetes', category: 'Endocrine', common_name: 'Pregnancy diabetes' },
      { code: '5A13', description: 'Diabetic ketoacidosis', category: 'Endocrine', common_name: 'DKA' },
      { code: '5A14', description: 'Hypoglycaemia', category: 'Endocrine', common_name: 'Low blood sugar' },
      { code: '5A20', description: 'Hypothyroidism', category: 'Endocrine', common_name: 'Underactive thyroid' },
      { code: '5A21', description: 'Hyperthyroidism', category: 'Endocrine', common_name: 'Overactive thyroid' },
      { code: '5A22', description: 'Goitre', category: 'Endocrine', common_name: 'Enlarged thyroid' },
      { code: '5A23', description: 'Thyroiditis', category: 'Endocrine', common_name: 'Thyroid inflammation' },
      { code: '5B80', description: 'Obesity', category: 'Endocrine', common_name: 'Obesity' },
      { code: '5B81', description: 'Morbid obesity', category: 'Endocrine', common_name: 'Severe obesity' },
      { code: '5B82', description: 'Overweight', category: 'Endocrine', common_name: 'Overweight' },
      { code: 'EK30', description: 'Malnutrition', category: 'Endocrine', common_name: 'Malnutrition' },
      { code: 'EK31', description: 'Severe malnutrition', category: 'Endocrine', common_name: 'Severe malnutrition' },
      { code: 'EK32', description: 'Kwashiorkor', category: 'Endocrine', common_name: 'Kwashiorkor' },
      { code: 'EK33', description: 'Marasmus', category: 'Endocrine', common_name: 'Marasmus' },
      { code: '5C90', description: 'Gout', category: 'Endocrine', common_name: 'Gout' },
      { code: '5C91', description: 'Hyperuricaemia', category: 'Endocrine', common_name: 'High uric acid' },
      { code: '5D00', description: 'Hyperlipidaemia', category: 'Endocrine', common_name: 'High cholesterol' },
      { code: '5D01', description: 'Hypercholesterolaemia', category: 'Endocrine', common_name: 'High cholesterol' },
      { code: '5D02', description: 'Hypertriglyceridaemia', category: 'Endocrine', common_name: 'High triglycerides' },
      { code: '5E00', description: 'Vitamin deficiency', category: 'Endocrine', common_name: 'Vitamin deficiency' },
      { code: '5E01', description: 'Vitamin D deficiency', category: 'Endocrine', common_name: 'Vitamin D deficiency' },
      { code: '5E02', description: 'Vitamin B12 deficiency', category: 'Endocrine', common_name: 'B12 deficiency' },
      // RESPIRATORY
      { code: 'CA43.Z', description: 'Pneumonia, organism unspecified', category: 'Respiratory', common_name: 'Pneumonia' },
      { code: 'CA40', description: 'Asthma', category: 'Respiratory', common_name: 'Asthma' },
      { code: 'CA41', description: 'Chronic obstructive pulmonary disease', category: 'Respiratory', common_name: 'COPD' },
      { code: 'CA42', description: 'Emphysema', category: 'Respiratory', common_name: 'Emphysema' },
      { code: 'CA44', description: 'Bronchiectasis', category: 'Respiratory', common_name: 'Bronchiectasis' },
      { code: 'CA45', description: 'Pulmonary tuberculosis', category: 'Respiratory', common_name: 'Lung TB' },
      { code: 'CA46', description: 'Pleural effusion', category: 'Respiratory', common_name: 'Fluid around lung' },
      { code: 'CA47', description: 'Pneumothorax', category: 'Respiratory', common_name: 'Collapsed lung' },
      { code: 'CA48', description: 'Pulmonary oedema', category: 'Respiratory', common_name: 'Fluid in lungs' },
      { code: 'CA49', description: 'Respiratory failure', category: 'Respiratory', common_name: 'Respiratory failure' },
      { code: 'CA50', description: 'Allergic rhinitis', category: 'Respiratory', common_name: 'Hay fever' },
      { code: 'CA51', description: 'Chronic rhinitis', category: 'Respiratory', common_name: 'Chronic runny nose' },
      { code: 'CA52', description: 'Nasal polyps', category: 'Respiratory', common_name: 'Nasal polyps' },
      { code: 'CA53', description: 'Deviated nasal septum', category: 'Respiratory', common_name: 'Deviated septum' },
      { code: 'CA54', description: 'Pharyngitis', category: 'Respiratory', common_name: 'Throat infection' },
      { code: 'CA55', description: 'Tonsillitis', category: 'Respiratory', common_name: 'Tonsil infection' },
      { code: 'CA56', description: 'Laryngitis', category: 'Respiratory', common_name: 'Voice box infection' },
      { code: 'CA57', description: 'Influenza', category: 'Respiratory', common_name: 'Flu' },
      { code: 'CA58', description: 'Common cold', category: 'Respiratory', common_name: 'Cold' },
      { code: 'CA59', description: 'Cough', category: 'Respiratory', common_name: 'Cough' },
      // GASTROINTESTINAL
      { code: 'DA90', description: 'Gastritis', category: 'Gastrointestinal', common_name: 'Stomach inflammation' },
      { code: 'DA91', description: 'Peptic ulcer', category: 'Gastrointestinal', common_name: 'Stomach ulcer' },
      { code: 'DA92', description: 'Gastric ulcer', category: 'Gastrointestinal', common_name: 'Stomach ulcer' },
      { code: 'DA93', description: 'Duodenal ulcer', category: 'Gastrointestinal', common_name: 'Duodenal ulcer' },
      { code: 'DA94', description: 'Gastroesophageal reflux disease', category: 'Gastrointestinal', common_name: 'GERD' },
      { code: 'DA95', description: 'Dyspepsia', category: 'Gastrointestinal', common_name: 'Indigestion' },
      { code: 'DA96', description: 'Appendicitis', category: 'Gastrointestinal', common_name: 'Appendicitis' },
      { code: 'DA97', description: 'Intestinal obstruction', category: 'Gastrointestinal', common_name: 'Bowel obstruction' },
      { code: 'DA98', description: 'Hernia', category: 'Gastrointestinal', common_name: 'Hernia' },
      { code: 'DA99', description: 'Inguinal hernia', category: 'Gastrointestinal', common_name: 'Groin hernia' },
      { code: 'DB00', description: 'Umbilical hernia', category: 'Gastrointestinal', common_name: 'Belly button hernia' },
      { code: 'DB01', description: 'Haemorrhoids', category: 'Gastrointestinal', common_name: 'Piles' },
      { code: 'DB02', description: 'Anal fissure', category: 'Gastrointestinal', common_name: 'Anal tear' },
      { code: 'DB03', description: 'Constipation', category: 'Gastrointestinal', common_name: 'Constipation' },
      { code: 'DB04', description: 'Diarrhoea', category: 'Gastrointestinal', common_name: 'Diarrhea' },
      { code: 'DB05', description: 'Irritable bowel syndrome', category: 'Gastrointestinal', common_name: 'IBS' },
      { code: 'DB06', description: 'Inflammatory bowel disease', category: 'Gastrointestinal', common_name: 'IBD' },
      { code: 'DB07', description: 'Crohn disease', category: 'Gastrointestinal', common_name: 'Crohns' },
      { code: 'DB08', description: 'Ulcerative colitis', category: 'Gastrointestinal', common_name: 'Ulcerative colitis' },
      { code: 'DB09', description: 'Hepatitis', category: 'Gastrointestinal', common_name: 'Liver inflammation' },
      { code: 'DB10', description: 'Cirrhosis', category: 'Gastrointestinal', common_name: 'Liver cirrhosis' },
      { code: 'DB11', description: 'Fatty liver', category: 'Gastrointestinal', common_name: 'Fatty liver' },
      { code: 'DB12', description: 'Cholecystitis', category: 'Gastrointestinal', common_name: 'Gallbladder inflammation' },
      { code: 'DB13', description: 'Cholelithiasis', category: 'Gastrointestinal', common_name: 'Gallstones' },
      { code: 'DB14', description: 'Pancreatitis', category: 'Gastrointestinal', common_name: 'Pancreas inflammation' },
      // GENITOURINARY
      { code: 'GC08', description: 'Urinary tract infection, site not specified', category: 'Genitourinary', common_name: 'UTI' },
      { code: 'GC09', description: 'Cystitis', category: 'Genitourinary', common_name: 'Bladder infection' },
      { code: 'GC10', description: 'Pyelonephritis', category: 'Genitourinary', common_name: 'Kidney infection' },
      { code: 'GC11', description: 'Urethritis', category: 'Genitourinary', common_name: 'Urethra infection' },
      { code: 'GC12', description: 'Kidney stones', category: 'Genitourinary', common_name: 'Kidney stones' },
      { code: 'GC13', description: 'Chronic kidney disease', category: 'Genitourinary', common_name: 'CKD' },
      { code: 'GC14', description: 'Acute kidney injury', category: 'Genitourinary', common_name: 'Acute kidney failure' },
      { code: 'GC15', description: 'Glomerulonephritis', category: 'Genitourinary', common_name: 'Kidney inflammation' },
      { code: 'GC16', description: 'Nephrotic syndrome', category: 'Genitourinary', common_name: 'Nephrotic syndrome' },
      { code: 'GC17', description: 'Benign prostatic hyperplasia', category: 'Genitourinary', common_name: 'Enlarged prostate' },
      { code: 'GC18', description: 'Prostatitis', category: 'Genitourinary', common_name: 'Prostate infection' },
      { code: 'GC19', description: 'Erectile dysfunction', category: 'Genitourinary', common_name: 'ED' },
      { code: 'GC20', description: 'Pelvic inflammatory disease', category: 'Genitourinary', common_name: 'PID' },
      { code: 'GC21', description: 'Vaginitis', category: 'Genitourinary', common_name: 'Vaginal infection' },
      { code: 'GC22', description: 'Cervicitis', category: 'Genitourinary', common_name: 'Cervix infection' },
      { code: 'GC23', description: 'Endometriosis', category: 'Genitourinary', common_name: 'Endometriosis' },
      { code: 'GC24', description: 'Uterine fibroids', category: 'Genitourinary', common_name: 'Fibroids' },
      { code: 'GC25', description: 'Ovarian cyst', category: 'Genitourinary', common_name: 'Ovarian cyst' },
      { code: 'GC26', description: 'Menstrual disorders', category: 'Genitourinary', common_name: 'Period problems' },
      { code: 'GC27', description: 'Sexually transmitted infection', category: 'Genitourinary', common_name: 'STI' },
      // MATERNAL
      { code: '9B71.0Z', description: 'Normal pregnancy', category: 'Maternal', common_name: 'Normal pregnancy' },
      { code: '9B71.1', description: 'High-risk pregnancy', category: 'Maternal', common_name: 'High-risk pregnancy' },
      { code: '9B72', description: 'Hyperemesis gravidarum', category: 'Maternal', common_name: 'Severe morning sickness' },
      { code: '9B73', description: 'Gestational hypertension', category: 'Maternal', common_name: 'Pregnancy high BP' },
      { code: '9B74', description: 'Pre-eclampsia', category: 'Maternal', common_name: 'Pre-eclampsia' },
      { code: '9B75', description: 'Eclampsia', category: 'Maternal', common_name: 'Eclampsia' },
      { code: '9B76', description: 'Gestational diabetes', category: 'Maternal', common_name: 'Pregnancy diabetes' },
      { code: '9B77', description: 'Threatened abortion', category: 'Maternal', common_name: 'Threatened miscarriage' },
      { code: '9B78', description: 'Miscarriage', category: 'Maternal', common_name: 'Miscarriage' },
      { code: '9B79', description: 'Ectopic pregnancy', category: 'Maternal', common_name: 'Ectopic pregnancy' },
      { code: '9B80', description: 'Placenta praevia', category: 'Maternal', common_name: 'Low-lying placenta' },
      { code: '9B81', description: 'Placental abruption', category: 'Maternal', common_name: 'Placenta separation' },
      { code: '9B82', description: 'Premature labour', category: 'Maternal', common_name: 'Preterm labor' },
      { code: '9B83', description: 'Postpartum haemorrhage', category: 'Maternal', common_name: 'Bleeding after delivery' },
      { code: '9B84', description: 'Puerperal sepsis', category: 'Maternal', common_name: 'Postpartum infection' },
      // HAEMATOLOGY
      { code: 'EK0Z', description: 'Anaemia, unspecified', category: 'Haematology', common_name: 'Anemia' },
      { code: 'EK00', description: 'Iron deficiency anaemia', category: 'Haematology', common_name: 'Iron deficiency anemia' },
      { code: 'EK01', description: 'Vitamin B12 deficiency anaemia', category: 'Haematology', common_name: 'B12 anemia' },
      { code: 'EK02', description: 'Folate deficiency anaemia', category: 'Haematology', common_name: 'Folate anemia' },
      { code: 'EK03', description: 'Sickle cell anaemia', category: 'Haematology', common_name: 'Sickle cell' },
      { code: 'EK04', description: 'Thalassaemia', category: 'Haematology', common_name: 'Thalassemia' },
      { code: 'EK05', description: 'Aplastic anaemia', category: 'Haematology', common_name: 'Aplastic anemia' },
      { code: 'EK06', description: 'Haemolytic anaemia', category: 'Haematology', common_name: 'Hemolytic anemia' },
      { code: 'EK07', description: 'Leukaemia', category: 'Haematology', common_name: 'Leukemia' },
      { code: 'EK08', description: 'Lymphoma', category: 'Haematology', common_name: 'Lymphoma' },
      { code: 'EK09', description: 'Multiple myeloma', category: 'Haematology', common_name: 'Multiple myeloma' },
      { code: 'EK10', description: 'Thrombocytopenia', category: 'Haematology', common_name: 'Low platelets' },
      { code: 'EK11', description: 'Coagulation disorder', category: 'Haematology', common_name: 'Bleeding disorder' },
      { code: 'EK12', description: 'Haemophilia', category: 'Haematology', common_name: 'Hemophilia' },
      { code: 'EK13', description: 'Von Willebrand disease', category: 'Haematology', common_name: 'Von Willebrand' },
      // MUSCULOSKELETAL
      { code: 'FA70', description: 'Arthritis, unspecified', category: 'Musculoskeletal', common_name: 'Arthritis' },
      { code: 'FA71', description: 'Osteoarthritis', category: 'Musculoskeletal', common_name: 'Osteoarthritis' },
      { code: 'FA72', description: 'Rheumatoid arthritis', category: 'Musculoskeletal', common_name: 'Rheumatoid arthritis' },
      { code: 'FA73', description: 'Gout', category: 'Musculoskeletal', common_name: 'Gout' },
      { code: 'FA74', description: 'Back pain', category: 'Musculoskeletal', common_name: 'Back pain' },
      { code: 'FA75', description: 'Low back pain', category: 'Musculoskeletal', common_name: 'Lower back pain' },
      { code: 'FA76', description: 'Neck pain', category: 'Musculoskeletal', common_name: 'Neck pain' },
      { code: 'FA77', description: 'Joint pain', category: 'Musculoskeletal', common_name: 'Joint pain' },
      { code: 'FA78', description: 'Muscle pain', category: 'Musculoskeletal', common_name: 'Muscle pain' },
      { code: 'FA79', description: 'Fracture', category: 'Musculoskeletal', common_name: 'Broken bone' },
      { code: 'FA80', description: 'Sprain', category: 'Musculoskeletal', common_name: 'Sprain' },
      { code: 'FA81', description: 'Strain', category: 'Musculoskeletal', common_name: 'Muscle strain' },
      { code: 'FA82', description: 'Dislocation', category: 'Musculoskeletal', common_name: 'Dislocation' },
      { code: 'FA83', description: 'Tendinitis', category: 'Musculoskeletal', common_name: 'Tendon inflammation' },
      { code: 'FA84', description: 'Bursitis', category: 'Musculoskeletal', common_name: 'Bursa inflammation' },
      { code: 'FA85', description: 'Carpal tunnel syndrome', category: 'Musculoskeletal', common_name: 'Carpal tunnel' },
      { code: 'FA86', description: 'Osteoporosis', category: 'Musculoskeletal', common_name: 'Weak bones' },
      { code: 'FA87', description: 'Scoliosis', category: 'Musculoskeletal', common_name: 'Curved spine' },
      { code: 'FA88', description: 'Herniated disc', category: 'Musculoskeletal', common_name: 'Slipped disc' },
      { code: 'FA89', description: 'Sciatica', category: 'Musculoskeletal', common_name: 'Sciatica' },
      // NEUROLOGICAL
      { code: '8A00', description: 'Epilepsy', category: 'Neurological', common_name: 'Epilepsy' },
      { code: '8A01', description: 'Seizure disorder', category: 'Neurological', common_name: 'Seizures' },
      { code: '8A02', description: 'Migraine', category: 'Neurological', common_name: 'Migraine' },
      { code: '8A03', description: 'Tension headache', category: 'Neurological', common_name: 'Tension headache' },
      { code: '8A04', description: 'Cluster headache', category: 'Neurological', common_name: 'Cluster headache' },
      { code: 'EE90', description: 'Headache', category: 'Neurological', common_name: 'Headache' },
      { code: '8A05', description: 'Stroke', category: 'Neurological', common_name: 'Stroke' },
      { code: '8A06', description: 'Transient ischaemic attack', category: 'Neurological', common_name: 'TIA' },
      { code: '8A07', description: 'Parkinson disease', category: 'Neurological', common_name: 'Parkinsons' },
      { code: '8A08', description: 'Dementia', category: 'Neurological', common_name: 'Dementia' },
      { code: '8A09', description: 'Alzheimer disease', category: 'Neurological', common_name: 'Alzheimers' },
      { code: '8A10', description: 'Multiple sclerosis', category: 'Neurological', common_name: 'MS' },
      { code: '8A11', description: 'Peripheral neuropathy', category: 'Neurological', common_name: 'Nerve damage' },
      { code: '8A12', description: 'Bell palsy', category: 'Neurological', common_name: 'Facial paralysis' },
      { code: '8A13', description: 'Meningitis', category: 'Neurological', common_name: 'Brain infection' },
      // DERMATOLOGY
      { code: 'EA00', description: 'Eczema', category: 'Dermatology', common_name: 'Eczema' },
      { code: 'EA01', description: 'Atopic dermatitis', category: 'Dermatology', common_name: 'Atopic dermatitis' },
      { code: 'EA02', description: 'Contact dermatitis', category: 'Dermatology', common_name: 'Contact dermatitis' },
      { code: 'EA03', description: 'Psoriasis', category: 'Dermatology', common_name: 'Psoriasis' },
      { code: 'EA04', description: 'Acne', category: 'Dermatology', common_name: 'Acne' },
      { code: 'EA05', description: 'Rosacea', category: 'Dermatology', common_name: 'Rosacea' },
      { code: 'EA06', description: 'Urticaria', category: 'Dermatology', common_name: 'Hives' },
      { code: 'EA07', description: 'Fungal skin infection', category: 'Dermatology', common_name: 'Fungal infection' },
      { code: 'EA08', description: 'Bacterial skin infection', category: 'Dermatology', common_name: 'Bacterial infection' },
      { code: 'EA09', description: 'Cellulitis', category: 'Dermatology', common_name: 'Cellulitis' },
      { code: 'EA10', description: 'Abscess', category: 'Dermatology', common_name: 'Abscess' },
      { code: 'EA11', description: 'Impetigo', category: 'Dermatology', common_name: 'Impetigo' },
      { code: 'EA12', description: 'Warts', category: 'Dermatology', common_name: 'Warts' },
      { code: 'EA13', description: 'Skin ulcer', category: 'Dermatology', common_name: 'Skin ulcer' },
      { code: 'EA14', description: 'Burns', category: 'Dermatology', common_name: 'Burns' },
      // MENTAL HEALTH
      { code: '6A70', description: 'Depression', category: 'Mental Health', common_name: 'Depression' },
      { code: '6A71', description: 'Anxiety disorder', category: 'Mental Health', common_name: 'Anxiety' },
      { code: '6A72', description: 'Panic disorder', category: 'Mental Health', common_name: 'Panic attacks' },
      { code: '6A73', description: 'Post-traumatic stress disorder', category: 'Mental Health', common_name: 'PTSD' },
      { code: '6A74', description: 'Obsessive-compulsive disorder', category: 'Mental Health', common_name: 'OCD' },
      { code: '6A75', description: 'Bipolar disorder', category: 'Mental Health', common_name: 'Bipolar' },
      { code: '6A76', description: 'Schizophrenia', category: 'Mental Health', common_name: 'Schizophrenia' },
      { code: '6A77', description: 'Psychosis', category: 'Mental Health', common_name: 'Psychosis' },
      { code: '6A78', description: 'Substance abuse', category: 'Mental Health', common_name: 'Drug abuse' },
      { code: '6A79', description: 'Alcohol dependence', category: 'Mental Health', common_name: 'Alcoholism' },
      // GENERAL SYMPTOMS
      { code: 'FA01', description: 'Abdominal pain', category: 'Symptoms', common_name: 'Stomach pain' },
      { code: 'FA02', description: 'Chest pain', category: 'Symptoms', common_name: 'Chest pain' },
      { code: 'FA03', description: 'Fever', category: 'Symptoms', common_name: 'Fever' },
      { code: 'FA04', description: 'Fatigue', category: 'Symptoms', common_name: 'Tiredness' },
      { code: 'FA05', description: 'Dizziness', category: 'Symptoms', common_name: 'Dizziness' },
      { code: 'FA06', description: 'Nausea', category: 'Symptoms', common_name: 'Nausea' },
      { code: 'FA07', description: 'Vomiting', category: 'Symptoms', common_name: 'Vomiting' },
      { code: 'FA08', description: 'Weight loss', category: 'Symptoms', common_name: 'Weight loss' },
      { code: 'FA09', description: 'Weight gain', category: 'Symptoms', common_name: 'Weight gain' },
      { code: 'FA10', description: 'Weakness', category: 'Symptoms', common_name: 'Weakness' }
    ];

    // Load ICD-11 codes when diagnosis module opens
    function loadICD11Codes() {
      // Step 1: Load Common Codes IMMEDIATELY (Frontend Cache)
      if (!window.icd11Codes || window.icd11Codes.length === 0) {
        console.log('Loading common ICD-11 codes from frontend cache...');
        window.icd11Codes = [...COMMON_ICD11_CODES];
      }

      // Step 2: Try to fetch full list from backend (Background Update)
      // Check a flag to avoid repeated backend calls if already loaded full list
      if (window.fullIcdCodesLoaded) {
        return;
      }

      console.log('Fetching full ICD-11 codes from backend...');
      google.script.run
        .withFailureHandler(function (error) {
          console.error('Error loading full ICD-11 codes (Using offline backup):', error);
        })
        .withSuccessHandler(function (codes) {
          console.log('Full ICD-11 codes loaded from backend:', codes.length);
          if (codes && codes.length > 0) {
            window.icd11Codes = codes;
            window.fullIcdCodesLoaded = true;
          }
        })
        .getICD11Codes();
    }

    // EVENT DELEGATION FOR ICD-11 SEARCH
    // This runs once and handles all future events, ignoring view switches
    document.addEventListener('input', function (e) {
      if (e.target && (e.target.id === 'diagnosis-search' || e.target.id === 'final-diagnosis-search')) {
        const query = e.target.value.trim();
        const context = e.target.id === 'final-diagnosis-search' ? 'final' : 'initial';
        console.log('Diagnosis search input:', query, context);

        if (query.length >= 2) {
          searchDiagnosis(query, context);
        } else {
          const resultsId = context === 'final' ? 'final-diagnosis-results' : 'diagnosis-results';
          const el = document.getElementById(resultsId);
          if (el) el.style.display = 'none';
        }
      }
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', function (e) {
      if (!e.target.closest('.autocomplete-wrapper')) {
        const resultsElems = document.querySelectorAll('.autocomplete-results');
        resultsElems.forEach(el => el.style.display = 'none');
      }
    });
    // Search diagnosis codes
    function searchDiagnosis(query, context = 'initial') {
      if (!window.icd11Codes || window.icd11Codes.length === 0) {
        return;
      }

      query = query.toLowerCase();

      // Search in code, description, and common_name
      var matches = window.icd11Codes.filter(function (item) {
        return item.code.toLowerCase().includes(query) ||
          item.description.toLowerCase().includes(query) ||
          item.common_name.toLowerCase().includes(query);
      });

      // Limit to top 10 results
      matches = matches.slice(0, 10);

      displayDiagnosisResults(matches, context);
    }
    // Display autocomplete results
    function displayDiagnosisResults(matches, context = 'initial') {
      const resultsId = context === 'final' ? 'final-diagnosis-results' : 'diagnosis-results';
      const resultsDiv = document.getElementById(resultsId);

      if (matches.length === 0) {
        resultsDiv.innerHTML = '<div class="autocomplete-no-results">No matching diagnoses found</div>';
        resultsDiv.style.display = 'block';
        return;
      }

      var html = '';
      matches.forEach(function (item) {
        // Escaping single quotes for the onclick string
        const escapedDesc = item.description.replace(/'/g, "\\'");
        html += '<div class="autocomplete-item" onclick="selectDiagnosis(\'' +
          item.code + '\', \'' + escapedDesc + '\', \'' + context + '\')">' +
          '<div class="autocomplete-code">' + item.code + '</div>' +
          '<div class="autocomplete-desc">' + item.description + '</div>' +
          '<div class="autocomplete-category">' + item.category + ' ‚Ä¢ ' + item.common_name + '</div>' +
          '</div>';
      });

      resultsDiv.innerHTML = html;
      resultsDiv.style.display = 'block';
    }
    // Select a diagnosis from autocomplete
    function selectDiagnosis(code, description, context = 'initial') {
      const codeId = context === 'final' ? 'final-diagnosis-code' : 'diagnosis-code';
      const descId = context === 'final' ? 'final-diagnosis-desc' : 'diagnosis-desc';
      const searchId = context === 'final' ? 'final-diagnosis-search' : 'diagnosis-search';
      const resultsId = context === 'final' ? 'final-diagnosis-results' : 'diagnosis-results';

      document.getElementById(codeId).value = code;
      document.getElementById(descId).value = description;
      document.getElementById(searchId).value = '';
      document.getElementById(resultsId).style.display = 'none';

      console.log('Selected ' + context + ' diagnosis:', code, description);
    }

    // ========================================
    // ICD-11 AUTOCOMPLETE LOGIC
    // ========================================














    function startConsultation(eid, pid, name, complaint) {
      document.getElementById('consultation-form-section').style.display = 'block';
      document.getElementById('consult-patient-name').innerText = name;
      document.getElementById('consult-complaint').innerText = complaint;
      document.getElementById('consult-encounter-id').value = eid;
      document.getElementById('consult-patient-id').value = pid;
      // Scroll to form
      document.getElementById('consultation-form-section').scrollIntoView({ behavior: 'smooth' });
    }

    function loadRecentTreatments() {
      const tbody = document.querySelector('#treatments-table tbody');
      tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';

      google.script.run
        .withFailureHandler(function (error) {
          tbody.innerHTML = `<tr><td colspan="4" style="color:red;">Error: ${error.message}</td></tr>`;
        })
        .withSuccessHandler(function (list) {
          tbody.innerHTML = '';
          if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4">No recent treatments.</td></tr>';
            return;
          }

          list.forEach(item => {
            const date = new Date(item.visit_date_time).toLocaleDateString();
            const row = `
              <tr>
                <td>${date}</td>
                <td>${item.patient_id}</td>
                <td>${item.diagnosis_primary_desc}</td>
                <td>${item.treatment_plan}</td>
              </tr>
            `;
            tbody.innerHTML += row;
          });
        }).getRecentTreatments();
    }

    function addRxRow() {
      const container = document.getElementById('rx-container');
      const div = document.createElement('div');
      div.className = 'rx-row';
      div.style = 'display:flex; gap:10px; margin-bottom:5px;';
      div.innerHTML = `<input type="text" placeholder="Drug Name" class="form-control rx-name"><input type="text" placeholder="Dosage/Freq" class="form-control rx-dosage">`;
      container.appendChild(div);
    }

    function handleTreatmentSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const btn = form.querySelector('button[type="submit"]');
      // Gather Rx Data
      const rxRows = document.querySelectorAll('.rx-row');
      const rxData = [];
      rxRows.forEach(row => {
        const name = row.querySelector('.rx-name').value;
        const dose = row.querySelector('.rx-dosage').value;
        if (name) rxData.push({ name, dose });
      });
      document.getElementById('rx-json').value = JSON.stringify(rxData);
      // Gather Lab IDs
      const labSelect = document.getElementById('lab-select');
      const selectedLabs = Array.from(labSelect.selectedOptions).map(opt => opt.value);
      document.getElementById('lab-ids').value = selectedLabs.join(',');
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      console.log('Submitting treatment with encounter_id:', data.encounter_id);  // ADD THIS LINE
      btn.innerText = 'Saving...';
      google.script.run.withSuccessHandler(function (res) {
        btn.innerText = 'Save Consultation';
        if (res.success) {
          showAlert('Consultation saved successfully!', 'Success', '‚úÖ');
          form.reset();
          document.getElementById('consultation-form-section').style.display = 'none';
          loadWaitingList();           // Refresh "Waiting List (Triage Done)"
          loadPendingLabResults();     // Refresh "Waiting List (Pending Lab Results)"
          loadRecentTreatments();
        }
      }).saveTreatmentRecord(data);
    }

    // --- Lab & Inventory Logic ---
    function showLabTab(tab) {
      document.getElementById('lab-orders-section').style.display = tab === 'orders' ? 'block' : 'none';
      document.getElementById('lab-inventory-section').style.display = tab === 'inventory' ? 'block' : 'none';

      document.getElementById('tab-orders').style.background = tab === 'orders' ? 'var(--primary)' : '#eee';
      document.getElementById('tab-orders').style.color = tab === 'orders' ? 'white' : 'black';

      document.getElementById('tab-inventory').style.background = tab === 'inventory' ? 'var(--primary)' : '#eee';
      document.getElementById('tab-inventory').style.color = tab === 'inventory' ? 'white' : 'black';

      if (tab === 'inventory') loadInventory();
    }


    //--LAB orders function replaced--

    function loadLabOrders() {
      const tbody = document.querySelector('#lab-orders-table tbody');
      tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
      google.script.run
        .withFailureHandler(function (err) {
          tbody.innerHTML = `<tr><td colspan="5" style="color:red;">Error: ${err.message}</td></tr>`;
          console.error('Lab Orders Error:', err);
        })
        .withSuccessHandler(function (list) {
          console.log('Lab Orders received:', list);
          console.log('Number of orders:', list.length);
          tbody.innerHTML = '';
          if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">No pending orders.</td></tr>';
            return;
          }
          list.forEach(item => {
            const time = new Date(item.order_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const row = `<tr>
          <td>${time}</td>
          <td>${item.patient_name}</td>
          <td>${item.test_name}</td>
          <td>${item.status}</td>
          <td><button class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="enterResult('${item.lab_order_id}', '${item.test_name}', '${item.patient_name}')">Result</button></td>
        </tr>`;
            tbody.innerHTML += row;
          });
        }).getPendingLabOrders();
    }







    function enterResult(id, test, patient) {
      document.getElementById('lab-result-form-section').style.display = 'block';
      document.getElementById('res-order-id').value = id;
      document.getElementById('res-test-name').innerText = test;
      document.getElementById('res-patient-name').innerText = patient;
    }

    function cancelResult() {
      document.getElementById('lab-result-form-section').style.display = 'none';
      document.getElementById('result-form').reset();
    }

    let labResultFileData = null;

    function handleLabFileSelect(event) {
      const file = event.target.files[0];
      const filePreview = document.getElementById('file-preview');
      const fileName = document.getElementById('file-name');
      const fileSize = document.getElementById('file-size');

      if (!file) {
        filePreview.style.display = 'none';
        labResultFileData = null;
        return;
      }

      // Validate file size (10MB max)
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        showAlert('File size exceeds 10MB limit. Please choose a smaller file.', 'Error', '‚ùå');
        event.target.value = '';
        filePreview.style.display = 'none';
        labResultFileData = null;
        return;
      }

      // Show file preview
      fileName.textContent = file.name;
      fileSize.textContent = (file.size / 1024).toFixed(2) + ' KB';
      filePreview.style.display = 'block';

      // Read file as base64
      const reader = new FileReader();
      reader.onload = function (e) {
        labResultFileData = {
          name: file.name,
          mimeType: file.type,
          data: e.target.result.split(',')[1] // Remove data:...;base64, prefix
        };
      };
      reader.readAsDataURL(file);
    }

    function handleResultSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const btn = document.getElementById('save-result-btn');

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      btn.innerText = labResultFileData ? 'Uploading...' : 'Saving...';
      btn.disabled = true;

      // If file is selected, upload it first
      if (labResultFileData) {
        google.script.run
          .withSuccessHandler(function (fileUrl) {
            // File uploaded successfully, now save the result with file URL
            data.file_url = fileUrl;
            saveLabResultData(data, btn, form);
          })
          .withFailureHandler(function (error) {
            btn.innerText = 'Save Result';
            btn.disabled = false;
            showAlert('Error uploading file: ' + error.message, 'Error', '‚ùå');
          })
          .uploadLabResultFile(
            labResultFileData.data,
            labResultFileData.name,
            labResultFileData.mimeType,
            data.lab_order_id
          );
      } else {
        // No file, just save the result
        saveLabResultData(data, btn, form);
      }
    }

    function saveLabResultData(data, btn, form) {
      google.script.run
        .withSuccessHandler(function (res) {
          btn.innerText = 'Save Result';
          btn.disabled = false;
          if (res.success) {
            showAlert('Lab result saved successfully!', 'Success', '‚úÖ');
            cancelResult();
            loadLabOrders();
            labResultFileData = null;
          } else {
            showAlert('Error: ' + res.message, 'Error', '‚ùå');
          }
        })
        .withFailureHandler(function (error) {
          btn.innerText = 'Save Result';
          btn.disabled = false;
          showAlert('Error: ' + error.message, 'Error', '‚ùå');
        })
        .saveLabResult(data);
    }

    function loadInventory() {
      const tbody = document.querySelector('#inventory-table tbody');
      tbody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';

      google.script.run.withSuccessHandler(function (list) {
        tbody.innerHTML = '';
        if (list.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3">No inventory items.</td></tr>';
          return;
        }
        list.forEach(item => {
          const lowStock = item.stock < 10;
          const row = `<tr style="${lowStock ? 'background-color: #ffebee;' : ''}">
          <td>${item.item_id}</td>
          <td>${item.item_name}</td>
          <td style="${lowStock ? 'color: red; font-weight: bold;' : ''}">${item.stock}</td>
        </tr>`;
          tbody.innerHTML += row;
        });
      }).getInventory();
    }

    function handleInventorySubmit(e) {
      e.preventDefault();
      const form = e.target;
      const btn = form.querySelector('button[type="submit"]');

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      btn.innerText = 'Saving...';

      google.script.run.withSuccessHandler(function (res) {
        btn.innerText = 'Save Transaction';
        if (res.success) {
          showAlert('Transaction saved successfully!', 'Success', '‚úÖ');
          form.reset();
          loadInventory();
        }
      }).addInventoryTransaction(data);
    }

    // Inventory Item Autocomplete
    let inventoryItemsCache = [];

    function searchInventoryItems(query) {
      const suggestionsDiv = document.getElementById('inv-item-suggestions');

      if (!query || query.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
      }

      // Load inventory items if not cached
      if (inventoryItemsCache.length === 0) {
        google.script.run
          .withSuccessHandler(function (items) {
            inventoryItemsCache = items;
            filterAndShowSuggestions(query);
          })
          .getInventory();
      } else {
        filterAndShowSuggestions(query);
      }
    }

    function filterAndShowSuggestions(query) {
      const suggestionsDiv = document.getElementById('inv-item-suggestions');
      const lowerQuery = query.toLowerCase();

      const matches = inventoryItemsCache.filter(function (item) {
        const nameMatch = item.item_name.toLowerCase().includes(lowerQuery);
        const idMatch = item.item_id.toLowerCase().includes(lowerQuery);
        return nameMatch || idMatch;
      }).slice(0, 10);

      if (matches.length === 0) {
        suggestionsDiv.style.display = 'none';
        return;
      }

      suggestionsDiv.innerHTML = '';
      matches.forEach(function (item) {
        const div = document.createElement('div');
        div.className = 'autocomplete-item';

        const strong = document.createElement('strong');
        strong.textContent = item.item_name;

        const br = document.createElement('br');

        const small = document.createElement('small');
        small.textContent = 'ID: ' + item.item_id + ' | Stock: ' + item.stock;

        div.appendChild(strong);
        div.appendChild(br);
        div.appendChild(small);

        div.onclick = function () {
          selectInventoryItem(item);
        };
        suggestionsDiv.appendChild(div);
      });

      suggestionsDiv.style.display = 'block';
    }

    function selectInventoryItem(item) {
      document.getElementById('inv-item-name').value = item.item_name;
      document.getElementById('inv-item-id').value = item.item_id;
      document.getElementById('inv-item-suggestions').style.display = 'none';
    }

    // Close suggestions when clicking outside
    document.addEventListener('click', function (e) {
      const suggestionsDiv = document.getElementById('inv-item-suggestions');
      const inputField = document.getElementById('inv-item-name');
      if (suggestionsDiv && inputField && e.target !== inputField) {
        suggestionsDiv.style.display = 'none';
      }
    });







    // --- Finance Logic ---

    function loadPendingBills() {
      const tbody = document.querySelector('#finance-pending-table tbody');
      tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';

      google.script.run
        .withFailureHandler(function (error) {
          console.error('Error loading pending bills:', error);
          tbody.innerHTML = '<tr><td colspan="4" style="color:red;">Error loading bills</td></tr>';
        })
        .withSuccessHandler(function (list) {
          console.log('=== PENDING BILLS RECEIVED ===');
          console.log('Total items:', list.length);
          console.log('Full list:', list);

          tbody.innerHTML = '';

          if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4">No pending bills.</td></tr>';
            return;
          }

          list.forEach((item, index) => {
            console.log('--- Processing item', index, '---');
            console.log('Encounter ID:', item.encounter_id);
            console.log('Patient:', item.patient_name);
            console.log('Services array:', item.services);
            console.log('Services type:', typeof item.services);
            console.log('Services is array?', Array.isArray(item.services));
            console.log('Services length:', item.services ? item.services.length : 'null/undefined');

            const date = new Date(item.billing_date_time).toLocaleDateString();

            // Build services summary for display
            let servicesHtml = '';

            if (item.services && Array.isArray(item.services) && item.services.length > 0) {
              console.log('Building services HTML...');
              servicesHtml = item.services.map(svc => {
                console.log('Service category:', svc.category, 'Items:', svc.items);
                return `<strong>${svc.category}:</strong> ${svc.items.join(', ')}`;
              }).join('<br>');
              console.log('Services HTML:', servicesHtml);
            } else {
              console.log('No services found - using fallback');
              servicesHtml = 'No services found';
            }

            // Store the data
            window['billData_' + index] = {
              encounterId: item.encounter_id,
              patientId: item.patient_id,
              patientName: item.patient_name,
              services: item.services || []
            };

            const row = `<tr>
          <td>${date}</td>
          <td>${item.patient_name}</td>
          <td style="font-size:12px;">${servicesHtml}</td>
          <td><button class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="openPaymentFormById(${index})">Billing</button></td>
        </tr>`;

            console.log('Row HTML:', row);
            tbody.innerHTML += row;
          });

          console.log('=== TABLE RENDERING COMPLETE ===');
        })
        .getPendingBills();
    }




















    function openPaymentFormById(index) {
      const billData = window['billData_' + index];
      if (!billData) {
        showAlert('Error: Bill data not found', 'Error', '‚ùå');
        return;
      }

      console.log('Opening payment form with data:', billData);

      document.getElementById('payment-form-section').style.display = 'block';
      document.getElementById('pay-patient-name').innerText = billData.patientName;
      document.getElementById('pay-encounter-id').value = billData.encounterId;
      document.getElementById('pay-encounter-id').setAttribute('data-bill-index', index);
      document.getElementById('pay-patient-name-hidden').value = billData.patientName;
      document.getElementById('pay-patient-id').value = billData.patientId;

      // Get phone number from patient records
      google.script.run
        .withSuccessHandler(function (phone) {
          document.getElementById('pay-phone-number').value = phone || 'N/A';
        })
        .getPatientPhone(billData.patientId);

      // Clear dynamic charge items
      document.getElementById('consultation-items').innerHTML = '';
      document.getElementById('lab-items').innerHTML = '';
      document.getElementById('drug-items').innerHTML = '';

      // Auto-populate services if present
      if (billData.services && billData.services.length > 0) {
        billData.services.forEach(svc => {
          if (svc.category === 'Consultation') {
            svc.items.forEach(item => addConsultationItem(item));
          } else if (svc.category === 'Lab Tests') {
            svc.items.forEach(item => addLabItem(item));
          } else if (svc.category === 'Drugs') {
            svc.items.forEach(item => addDrugItem(item));
          }
        });
      } else {
        // Add default empty rows if no services
        addConsultationItem();
        addLabItem();
        addDrugItem();
      }

      // Calculate initial totals
      calculateTotal();

      // Clear balance display
      document.getElementById('balance-display').value = '';
      // Show services summary
      if (billData.services && billData.services.length > 0) {
        let servicesHtml = '<div style="background:#f0f7ff; padding:15px; border-radius:5px; margin-bottom:15px; border-left:4px solid #2370b8;">';
        servicesHtml += '<strong style="color:#2370b8; font-size:16px;">üìã Services Provided:</strong>';
        servicesHtml += '<ul style="margin:10px 0; padding-left:20px;">';

        billData.services.forEach(svc => {
          servicesHtml += `<li style="margin:8px 0;"><strong>${svc.category}:</strong>`;
          servicesHtml += '<ul style="margin:5px 0; padding-left:20px;">';
          svc.items.forEach(item => {
            servicesHtml += `<li>${item}</li>`;
          });
          servicesHtml += '</ul></li>';
        });

        servicesHtml += '</ul><p style="margin-top:10px; color:#666; font-size:13px;">';
        servicesHtml += '<em>üí° Please enter the charges for each item above.</em></p></div>';

        // Insert services summary
        const formSection = document.getElementById('payment-form-section');
        let summaryDiv = document.getElementById('services-summary-display');
        if (!summaryDiv) {
          summaryDiv = document.createElement('div');
          summaryDiv.id = 'services-summary-display';
          formSection.insertBefore(summaryDiv, formSection.querySelector('form'));
        }
        summaryDiv.innerHTML = servicesHtml;
      }

      // Scroll to form
      document.getElementById('payment-form-section').scrollIntoView({ behavior: 'smooth' });
    }




    function handlePaymentSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const btn = form.querySelector('button[type="submit"]');

      // Get values from hidden fields
      const encounterId = document.getElementById('pay-encounter-id').value;
      const patientId = document.getElementById('pay-patient-id').value;
      const patientName = document.getElementById('pay-patient-name').innerText;

      if (!encounterId || !patientId) {
        showAlert('Error: Missing patient information. Please try again.', 'Error', '‚ùå');
        return;
      }

      // Process Split Payments
      let paymentMethods = [];
      let totalPaid = 0;
      let transactionRefs = [];

      document.querySelectorAll('.payment-method-row').forEach(row => {
        const method = row.querySelector('.payment-method-select').value;
        const amount = parseFloat(row.querySelector('.payment-amount').value) || 0;
        const ref = row.querySelector('.payment-ref').value.trim();

        if (amount > 0) {
          let methodStr = `${method}: ${amount}`;
          paymentMethods.push(methodStr);
          totalPaid += amount;
          if (ref) transactionRefs.push(`${method} Ref: ${ref}`);
        }
      });

      const combinedMethod = paymentMethods.join(', ');
      const combinedRef = transactionRefs.join(', ');

      const formData = new FormData(form);

      // Calculate total charge from itemized breakdown if not set
      // (The calculateTotal function sets the hidden field, so we should trust it, 
      // but ensure it's up to date)
      calculateTotal();

      const data = {
        encounter_id: encounterId,
        patient_id: patientId,
        patient_name: patientName,
        charge_details: document.getElementById('charge-details-hidden').value,
        total_charge_amount: document.getElementById('total-charge-hidden').value,
        amount_paid_today: totalPaid, // Use calculated total
        payment_method: combinedMethod || 'Cash', // Default to Cash if empty but that shouldn't happen with valid amount
        transaction_reference: combinedRef,
        notes: formData.get('notes') || '',
        charges_breakdown: document.getElementById('charges-breakdown').value
      };

      console.log('Payment data to send:', data);

      if (totalPaid <= 0 && data.total_charge_amount > 0) {
        if (!confirm('Total paid is 0. Is this correct? (Will record as full debt)')) {
          return;
        }
      }

      btn.innerText = 'Processing...';
      btn.disabled = true;

      google.script.run
        .withFailureHandler(function (error) {
          console.error('Payment error:', error);
          btn.innerText = 'Process Payment';
          btn.disabled = false;
          showAlert('Error: ' + error.message, 'Error', '‚ùå');
        })
        .withSuccessHandler(function (response) {
          console.log('Payment response:', response);
          btn.innerText = 'Process Payment';
          btn.disabled = false;

          if (response.success) {
            showAlert('Payment processed successfully!', 'Success', 'üí∞');

            // Add services to receipt
            const billIndex = parseInt(document.getElementById('pay-encounter-id').getAttribute('data-bill-index'));
            const billData = window['billData_' + billIndex];
            if (response.receipt && billData && billData.services) {
              response.receipt.services = billData.services;
            }

            if (response.receipt) {
              showReceipt(response.receipt);
            }

            form.reset();
            document.getElementById('payment-form-section').style.display = 'none';
            // Clear dynamic rows
            document.getElementById('consultation-items').innerHTML = '';
            document.getElementById('lab-items').innerHTML = '';
            document.getElementById('drug-items').innerHTML = '';
            // Reset payment methods
            const payContainer = document.getElementById('payment-methods-container');
            if (payContainer) {
              payContainer.innerHTML = `
                    <div class="payment-method-row" style="display: flex; gap: 10px; margin-bottom: 0.5rem;">
                      <select class="form-control payment-method-select" style="flex: 1;" onchange="updatePaymentMethod(this)">
                        <option value="Cash">Cash</option>
                        <option value="M-Pesa">M-Pesa</option>
                        <option value="Insurance">Insurance</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                      </select>
                      <input type="number" placeholder="Amount" class="form-control payment-amount" style="flex: 1;" oninput="calculateTotalPaid()">
                      <input type="text" placeholder="Ref/Code" class="form-control payment-ref" style="flex: 1;">
                      <button type="button" onclick="removePaymentMethod(this)" class="btn" style="background: #ff4444; color: white; padding: 0.5rem; width: auto;">‚úï</button>
                    </div>`;
            }
            // Add default items back
            addConsultationItem();
            addLabItem();
            addDrugItem();

            calculateTotal();
            calculateTotalPaid();

            const summaryDiv = document.getElementById('services-summary-display');
            if (summaryDiv) summaryDiv.innerHTML = '';
            loadPendingBills();
          } else {
            showAlert('Error: ' + response.message, 'Error', '‚ùå');
          }
        })
        .processPayment(data);
    }
    function calcBalance() {
      const total = parseFloat(document.getElementById('total-charge-hidden').value) || 0;
      // Updated to use the hidden field or display field for amount paid
      const paid = parseFloat(document.getElementById('amount-paid-display').value) || 0;
      const balance = total - paid;
      document.getElementById('balance-display').value = 'KES ' + balance.toFixed(2);
    }

    // Itemized Billing Functions
    function addConsultationItem(description = '') {
      const container = document.getElementById('consultation-items');
      const newItem = document.createElement('div');
      newItem.className = 'charge-item';
      newItem.style.cssText = 'display: flex; gap: 10px; margin-bottom: 0.5rem;';
      newItem.innerHTML = `
        <input type="text" placeholder="Description (e.g., General Consultation)" class="form-control consultation-desc" style="flex: 2;" value="${description}">
        <input type="number" placeholder="Amount (KES)" class="form-control consultation-amount" style="flex: 1;" oninput="calculateTotal()">
        <button type="button" onclick="removeChargeItem(this)" class="btn" style="background: #ff4444; color: white; padding: 0.5rem; width: auto;">‚úï</button>
      `;
      container.appendChild(newItem);
    }

    function addLabItem(description = '') {
      const container = document.getElementById('lab-items');
      const newItem = document.createElement('div');
      newItem.className = 'charge-item';
      newItem.style.cssText = 'display: flex; gap: 10px; margin-bottom: 0.5rem;';
      newItem.innerHTML = `
        <input type="text" placeholder="Test Name (e.g., Malaria BS)" class="form-control lab-desc" style="flex: 2;" value="${description}">
        <input type="number" placeholder="Amount (KES)" class="form-control lab-amount" style="flex: 1;" oninput="calculateTotal()">
        <button type="button" onclick="removeChargeItem(this)" class="btn" style="background: #ff4444; color: white; padding: 0.5rem; width: auto;">‚úï</button>
      `;
      container.appendChild(newItem);
    }

    function addDrugItem(description = '') {
      const container = document.getElementById('drug-items');
      const newItem = document.createElement('div');
      newItem.className = 'charge-item';
      newItem.style.cssText = 'display: flex; gap: 10px; margin-bottom: 0.5rem;';
      newItem.innerHTML = `
        <input type="text" placeholder="Drug Name (e.g., Paracetamol 500mg)" class="form-control drug-desc" style="flex: 2;" value="${description}">
        <input type="number" placeholder="Amount (KES)" class="form-control drug-amount" style="flex: 1;" oninput="calculateTotal()">
        <button type="button" onclick="removeChargeItem(this)" class="btn" style="background: #ff4444; color: white; padding: 0.5rem; width: auto;">‚úï</button>
      `;
      container.appendChild(newItem);
    }

    function removeChargeItem(button) {
      button.parentElement.remove();
      calculateTotal();
    }

    function calculateTotal() {
      // Calculate consultation subtotal
      let consultationTotal = 0;
      document.querySelectorAll('.consultation-amount').forEach(input => {
        consultationTotal += parseFloat(input.value) || 0;
      });
      document.getElementById('consultation-subtotal').textContent = consultationTotal.toFixed(2);

      // Calculate lab subtotal
      let labTotal = 0;
      document.querySelectorAll('.lab-amount').forEach(input => {
        labTotal += parseFloat(input.value) || 0;
      });
      document.getElementById('lab-subtotal').textContent = labTotal.toFixed(2);

      // Calculate drug subtotal
      let drugTotal = 0;
      document.querySelectorAll('.drug-amount').forEach(input => {
        drugTotal += parseFloat(input.value) || 0;
      });
      document.getElementById('drug-subtotal').textContent = drugTotal.toFixed(2);

      // Calculate grand total
      const grandTotal = consultationTotal + labTotal + drugTotal;
      document.getElementById('total-charges').textContent = grandTotal.toFixed(2);
      document.getElementById('total-charge-hidden').value = grandTotal;

      // Build charges breakdown JSON
      const breakdown = {
        consultation: [],
        lab_tests: [],
        drugs: []
      };

      document.querySelectorAll('.consultation-desc').forEach((input, index) => {
        const desc = input.value.trim();
        const amount = parseFloat(document.querySelectorAll('.consultation-amount')[index].value) || 0;
        if (desc) {
          breakdown.consultation.push({ description: desc, amount: amount });
        }
      });

      document.querySelectorAll('.lab-desc').forEach((input, index) => {
        const desc = input.value.trim();
        const amount = parseFloat(document.querySelectorAll('.lab-amount')[index].value) || 0;
        if (desc) {
          breakdown.lab_tests.push({ description: desc, amount: amount });
        }
      });

      document.querySelectorAll('.drug-desc').forEach((input, index) => {
        const desc = input.value.trim();
        const amount = parseFloat(document.querySelectorAll('.drug-amount')[index].value) || 0;
        if (desc) {
          breakdown.drugs.push({ description: desc, amount: amount });
        }
      });

      document.getElementById('charges-breakdown').value = JSON.stringify(breakdown);

      // Update balance
      calcBalance();
    }

    // Split Payment Functions
    function addPaymentMethod() {
      const container = document.getElementById('payment-methods-container');
      const row = document.createElement('div');
      row.className = 'payment-method-row';
      row.style.cssText = 'display: flex; gap: 10px; margin-bottom: 0.5rem;';
      row.innerHTML = `
                      <select class="form-control payment-method-select" style="flex: 1;" onchange="updatePaymentMethod(this)">
                        <option value="Cash">Cash</option>
                        <option value="M-Pesa">M-Pesa</option>
                        <option value="Insurance">Insurance</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                      </select>
                      <input type="number" placeholder="Amount" class="form-control payment-amount" style="flex: 1;" oninput="calculateTotalPaid()">
                      <input type="text" placeholder="Ref/Code" class="form-control payment-ref" style="flex: 1;">
                      <button type="button" onclick="removePaymentMethod(this)" class="btn" style="background: #ff4444; color: white; padding: 0.5rem; width: auto;">‚úï</button>
      `;
      container.appendChild(row);
    }

    function removePaymentMethod(btn) {
      if (document.querySelectorAll('.payment-method-row').length > 1) {
        btn.closest('.payment-method-row').remove();
        calculateTotalPaid();
      } else {
        // Clear values if it's the last one
        const row = btn.closest('.payment-method-row');
        row.querySelector('input[type="number"]').value = '';
        row.querySelector('.payment-ref').value = '';
        calculateTotalPaid();
      }
    }

    function calculateTotalPaid() {
      let total = 0;
      document.querySelectorAll('.payment-amount').forEach(input => {
        total += parseFloat(input.value) || 0;
      });
      document.getElementById('amount-paid-display').value = total.toFixed(2);
      document.getElementById('amount-paid-hidden').value = total;
      calcBalance();
    }

    function updatePaymentMethod(select) {
      // Placeholder for any specific logic on change
    }


    function showReceipt(receipt) {
      const receiptBody = document.getElementById('receipt-body');

      // Replace with your actual base64 logo string if you have one
      const logoSrc = '';

      // Build services breakdown HTML
      let servicesHtml = '';

      // Check for new itemized format first
      if (receipt.items && receipt.items.length > 0) {
        servicesHtml = '<div style="margin-bottom:20px;">';
        servicesHtml += '<h4 style="margin:10px 0; color:#1e5ba8; font-size:14px; border-bottom:1px solid #ddd; padding-bottom:5px;">Charges Details:</h4>';
        servicesHtml += '<table style="width:100%; font-size:12px; border-collapse: collapse;">';

        // Table Header
        servicesHtml += '<tr style="background:#f8f9fa; border-bottom:1px solid #ddd;">';
        servicesHtml += '<th style="text-align:left; padding:8px;">Item / Service</th>';
        servicesHtml += '<th style="text-align:right; padding:8px;">Amount</th>';
        servicesHtml += '</tr>';

        // Table Rows
        receipt.items.forEach(item => {
          const amt = parseFloat(item.amount) || 0;
          servicesHtml += '<tr style="border-bottom:1px solid #eee;">';
          servicesHtml += `<td style="padding:8px; color:#555;">${item.description} <i style="font-size:11px; color:#999;">(${item.category})</i></td>`;
          servicesHtml += `<td style="padding:8px; text-align:right;">KES ${amt.toFixed(2)}</td>`;
          servicesHtml += '</tr>';
        });

        servicesHtml += '</table></div>';

      } else if (receipt.services && receipt.services.length > 0) {
        // Fallback for old Format (grouped by category)
        servicesHtml = '<div style="margin-bottom:20px;">';
        servicesHtml += '<h4 style="margin:10px 0; color:#1e5ba8; font-size:14px; border-bottom:1px solid #ddd; padding-bottom:5px;">Services Provided:</h4>';
        servicesHtml += '<table style="width:100%; font-size:12px; margin-bottom:10px;">';

        receipt.services.forEach(svc => {
          servicesHtml += `<tr style="vertical-align:top;">`;
          servicesHtml += `<td style="padding:5px 10px 5px 0; font-weight:bold; width:120px;">${svc.category}:</td>`;
          servicesHtml += `<td style="padding:5px 0;">`;
          servicesHtml += '<ul style="margin:0; padding-left:20px;">';
          svc.items.forEach(item => {
            servicesHtml += `<li style="margin:3px 0;">${item}</li>`;
          });
          servicesHtml += '</ul></td></tr>';
        });

        servicesHtml += '</table></div>';
      }

      receiptBody.innerHTML = `
    <div style="text-align:center; border-bottom:2px solid #1e5ba8; padding-bottom:15px; margin-bottom:20px;">
      ${logoSrc ? `<img src="${logoSrc}" alt="Makele Digital Clinic Logo" style="width:100px; height:100px; margin-bottom:10px; border-radius:50%;">` : ''}
      
      <h2 style="margin:0; color:#1e5ba8; font-size:24px; font-weight:bold;">MAKELE DIGITAL CLINIC</h2>
      <p style="margin:5px 0; font-size:14px; color:#555; font-weight:600;">KITUI</p>
      <p style="margin:5px 0; font-size:12px;">üìû 0721301555 | 0701xxxxxx</p>
      <p style="margin:5px 0; font-size:12px;">üìß example@gmail.com</p>
      <p style="margin:5px 0; font-size:12px;">üåê www.makeleclinic.co.ke</p>
    </div>
    
    <div style="text-align:center; margin-bottom:20px; background:#f0f7ff; padding:10px; border-radius:5px;">
      <h3 style="margin:0; font-size:18px; color:#1e5ba8; font-weight:bold;">PAYMENT RECEIPT</h3>
      <p style="margin:5px 0; font-size:12px; color:#666;">Receipt No: <strong style="color:#1e5ba8;">${receipt.receiptId}</strong></p>
      <p style="margin:5px 0; font-size:12px; color:#666;">Date: ${receipt.date} | Time: ${receipt.time}</p>
    </div>
    
    <table style="width:100%; border-collapse:collapse; margin-bottom:20px; font-size:13px;">
      <tr style="border-bottom:1px solid #ddd;">
        <td style="padding:8px 0; font-weight:bold;">Patient Name:</td>
        <td style="padding:8px 0; text-align:right;">${receipt.patientName}</td>
      </tr>
      <tr style="border-bottom:1px solid #ddd;">
        <td style="padding:8px 0; font-weight:bold;">Patient ID:</td>
        <td style="padding:8px 0; text-align:right;">${receipt.patientId}</td>
      </tr>
      <tr style="border-bottom:1px solid #ddd;">
        <td style="padding:8px 0; font-weight:bold;">Encounter ID:</td>
        <td style="padding:8px 0; text-align:right;">${receipt.encounterId}</td>
      </tr>
    </table>
    
    ${servicesHtml}
    
    <table style="width:100%; border-collapse:collapse; margin-bottom:20px; font-size:13px;">
      <tr style="background:#f8f9fa; border-bottom:1px solid #ddd;">
        <td style="padding:10px; font-weight:bold;">Total Charge:</td>
        <td style="padding:10px; text-align:right; font-weight:bold;">KES ${receipt.totalCharge.toFixed(2)}</td>
      </tr>
      <tr style="border-bottom:1px solid #ddd;">
        <td style="padding:10px; font-weight:bold;">Amount Paid:</td>
        <td style="padding:10px; text-align:right; color:#28a745; font-weight:bold;">KES ${receipt.amountPaid.toFixed(2)}</td>
      </tr>
      <tr style="background:#fff3cd; border-bottom:2px solid #333;">
        <td style="padding:10px; font-weight:bold;">Outstanding Balance:</td>
        <td style="padding:10px; text-align:right; font-weight:bold; color:${receipt.balance > 0 ? '#dc3545' : '#28a745'};">KES ${receipt.balance.toFixed(2)}</td>
      </tr>
    </table>
    
    <table style="width:100%; border-collapse:collapse; margin-bottom:30px; font-size:13px;">
      <tr style="border-bottom:1px solid #ddd;">
        <td style="padding:8px 0; font-weight:bold;">Payment Method:</td>
        <td style="padding:8px 0; text-align:right;">${receipt.paymentMethod}</td>
      </tr>
      <tr style="border-bottom:1px solid #ddd;">
        <td style="padding:8px 0; font-weight:bold;">Reference:</td>
        <td style="padding:8px 0; text-align:right;">${receipt.reference}</td>
      </tr>
    </table>
    
    <div style="text-align:center; margin-top:40px; padding-top:20px; border-top:1px dashed #999; font-size:11px; color:#666;">
      <p style="margin:5px 0; font-weight:600;">Thank you for choosing Makele Digital Clinic</p>
      <p style="margin:5px 0;">Get well soon! üíô</p>
    </div>
  `;

      document.getElementById('receipt-modal').style.display = 'flex';
    }








    function closeReceipt() {
      document.getElementById('receipt-modal').style.display = 'none';
      // Refresh the pending bills list to remove the paid bill
      loadPendingBills();
    }



    function printReceipt() {
      const receiptContent = document.getElementById('receipt-content').cloneNode(true);
      const buttons = receiptContent.querySelectorAll('button');
      buttons.forEach(btn => btn.remove());

      const printWindow = window.open('', '', 'width=600,height=800');
      printWindow.document.write(`
    <html>
      <head>
        <title>Receipt - Makele Digital Clinic</title>
        <style>
          @page { size: A5; margin: 0; }
          body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
          @media print { body { width: 148mm; height: 210mm; } }
        </style>
      </head>
      <body>${receiptContent.innerHTML}</body>
    </html>
  `);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 250);
    }





    // --- Debtors Logic ---
    function showFinanceTab(tab) {
      document.getElementById('finance-billing-section').style.display = tab === 'billing' ? 'block' : 'none';
      document.getElementById('finance-debtors-section').style.display = tab === 'debtors' ? 'block' : 'none';
      document.getElementById('tab-billing').style.background = tab === 'billing' ? 'var(--primary)' : '#eee';
      document.getElementById('tab-billing').style.color = tab === 'billing' ? 'white' : 'black';
      document.getElementById('tab-debtors').style.background = tab === 'debtors' ? 'var(--primary)' : '#eee';
      document.getElementById('tab-debtors').style.color = tab === 'debtors' ? 'white' : 'black';
      if (tab === 'debtors') loadDebtors();
    }
    function loadDebtors() {
      const tbody = document.querySelector('#debtors-table tbody');
      tbody.innerHTML = '<tr><td colspan="9">Loading...</td></tr>';

      google.script.run
        .withFailureHandler(function (error) {
          console.error('Error loading debtors:', error);
          tbody.innerHTML = '<tr><td colspan="9" style="color:red;">Error loading debtors</td></tr>';
        })
        .withSuccessHandler(function (debtors) {
          console.log('Debtors received:', debtors);
          tbody.innerHTML = '';

          if (debtors.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9">No outstanding debtors. Great!</td></tr>';
            return;
          }

          debtors.forEach((debtor, index) => {
            const serviceDate = new Date(debtor.service_date).toLocaleDateString();
            const lastPaymentDate = new Date(debtor.last_payment_date).toLocaleDateString();
            const row = `<tr>
          <td>${lastPaymentDate}</td>
          <td>${debtor.patient_name}</td>
          <td>${debtor.phone_number}</td>
          <td>${serviceDate}</td>
          <td>${debtor.service_description}</td>
          <td>KES ${debtor.total_amount.toFixed(2)}</td>
          <td>KES ${debtor.amount_paid.toFixed(2)}</td>
          <td style="color:#dc3545; font-weight:bold;">KES ${debtor.outstanding_balance.toFixed(2)}</td>
          <td><button class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" 
              onclick="openPartialPayment('${debtor.debtor_id}', '${debtor.patient_id}', '${debtor.patient_name}', '${debtor.encounter_id}', ${debtor.outstanding_balance})">Pay</button></td>
        </tr>`;
            tbody.innerHTML += row;
          });
        })
        .getDebtors();
    }
    function openPartialPayment(debtorId, patientId, patientName, encounterId, balance) {
      document.getElementById('partial-payment-section').style.display = 'block';
      document.getElementById('debtor-patient-name').innerText = patientName;
      document.getElementById('debtor-balance').innerText = balance.toFixed(2);
      document.getElementById('debtor-id').value = debtorId;
      document.getElementById('debtor-patient-id').value = patientId;
      document.getElementById('debtor-encounter-id').value = encounterId;
      document.getElementById('debtor-current-balance').value = balance;

      // Clear form
      document.getElementById('partial-amount').value = '';
      document.getElementById('new-balance-display').value = '';

      // Scroll to form
      document.getElementById('partial-payment-section').scrollIntoView({ behavior: 'smooth' });
    }
    function cancelPartialPayment() {
      document.getElementById('partial-payment-section').style.display = 'none';
      document.getElementById('partial-payment-form').reset();
    }
    function calcPartialBalance() {
      const currentBalance = parseFloat(document.getElementById('debtor-current-balance').value) || 0;
      const payment = parseFloat(document.getElementById('partial-amount').value) || 0;
      const newBalance = currentBalance - payment;
      document.getElementById('new-balance-display').value = 'KES ' + newBalance.toFixed(2);
    }
    function handlePartialPayment(e) {
      e.preventDefault();
      const form = e.target;
      const btn = form.querySelector('button[type="submit"]');

      const formData = new FormData(form);
      const data = {
        debtor_id: formData.get('debtor_id'),
        encounter_id: formData.get('encounter_id'),
        patient_id: formData.get('patient_id'),
        current_balance: parseFloat(formData.get('current_balance')),
        payment_amount: parseFloat(formData.get('payment_amount')),
        payment_method: formData.get('payment_method'),
        transaction_reference: formData.get('transaction_reference') || ''
      };

      console.log('Partial payment data:', data);

      btn.innerText = 'Processing...';
      btn.disabled = true;

      google.script.run
        .withFailureHandler(function (error) {
          console.error('Partial payment error:', error);
          btn.innerText = 'Record Payment';
          btn.disabled = false;
          showAlert('Error: ' + error.message, 'Error', '‚ùå');
        })
        .withSuccessHandler(function (response) {
          console.log('Partial payment response:', response);
          btn.innerText = 'Record Payment';
          btn.disabled = false;

          if (response.success) {
            showAlert('Partial payment recorded successfully!', 'Success', 'üí∞');
            cancelPartialPayment();
            loadDebtors();
          } else {
            showAlert('Error: ' + response.message, 'Error', '‚ùå');
          }
        })
        .recordPartialPayment(data);
    }







    // Statistics Dashboard
    // Statistics Dashboard
    let chartInstances = {};
    function loadStatistics() {
      google.script.run
        .withFailureHandler(function (error) {
          console.error('Error loading statistics:', error);
          showAlert('Error loading statistics: ' + error.message, 'Error', '‚ùå');
        })
        .withSuccessHandler(function (result) {
          console.log('Statistics result:', result);
          if (result.success) {
            renderAllCharts(result.stats);
          } else {
            showAlert('Error loading statistics: ' + result.message, 'Error', '‚ùå');
          }
        })
        .getStatistics();
    }


    function renderAllCharts(stats) {
      // Initialize chartInstances if it doesn't exist
      if (typeof window.chartInstances === 'undefined') {
        window.chartInstances = {};
      }

      // Destroy existing charts
      Object.values(window.chartInstances).forEach(chart => {
        if (chart && typeof chart.destroy === 'function') {
          chart.destroy();
        }
      });
      window.chartInstances = {};

      // Mobile-optimized defaults
      Chart.defaults.responsive = true;
      Chart.defaults.maintainAspectRatio = true;
      Chart.defaults.plugins.legend.position = 'bottom';
      Chart.defaults.plugins.legend.labels.boxWidth = 12;
      Chart.defaults.plugins.legend.labels.font = { size: 10 };

      const colors = {
        blue: ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#dbeafe'],
        green: ['#22c55e', '#4ade80', '#86efac', '#bbf7d0', '#dcfce7'],
        orange: ['#f97316', '#fb923c', '#fdba74', '#fed7aa', '#ffedd5'],
        purple: ['#a855f7', '#c084fc', '#d8b4fe', '#e9d5ff', '#f3e8ff'],
        mixed: ['#3b82f6', '#22c55e', '#f97316', '#a855f7', '#eab308', '#ec4899', '#14b8a6', '#f43f5e']
      };

      // 1. Gender
      if (stats.gender && Object.keys(stats.gender).length > 0) {
        const ctx = document.getElementById('genderChart');
        if (ctx) {
          window.chartInstances.gender = new Chart(ctx, {
            type: 'pie',
            data: { labels: Object.keys(stats.gender), datasets: [{ data: Object.values(stats.gender), backgroundColor: colors.blue }] }
          });
        }
      }

      // 2. Marital Status
      if (stats.maritalStatus && Object.keys(stats.maritalStatus).length > 0) {
        const ctx = document.getElementById('maritalChart');
        if (ctx) {
          window.chartInstances.marital = new Chart(ctx, {
            type: 'pie',
            data: { labels: Object.keys(stats.maritalStatus), datasets: [{ data: Object.values(stats.maritalStatus), backgroundColor: colors.green }] }
          });
        }
      }

      // 3. Blood Groups
      if (stats.bloodGroups && Object.keys(stats.bloodGroups).length > 0) {
        const ctx = document.getElementById('bloodGroupChart');
        if (ctx) {
          window.chartInstances.bloodGroup = new Chart(ctx, {
            type: 'bar',
            data: { labels: Object.keys(stats.bloodGroups), datasets: [{ label: 'Count', data: Object.values(stats.bloodGroups), backgroundColor: '#f97316' }] },
            options: { scales: { y: { beginAtZero: true } } }
          });
        }
      }

      // 4. Triage Priority
      if (stats.triagePriority && Object.keys(stats.triagePriority).length > 0) {
        const ctx = document.getElementById('triagePriorityChart');
        if (ctx) {
          window.chartInstances.triage = new Chart(ctx, {
            type: 'pie',
            data: { labels: Object.keys(stats.triagePriority), datasets: [{ data: Object.values(stats.triagePriority), backgroundColor: colors.orange }] }
          });
        }
      }

      // 5. Oxygen Saturation
      if (stats.oxygenSaturation) {
        const ctx = document.getElementById('oxygenChart');
        if (ctx) {
          window.chartInstances.oxygen = new Chart(ctx, {
            type: 'bar',
            data: { labels: Object.keys(stats.oxygenSaturation), datasets: [{ label: 'Patients', data: Object.values(stats.oxygenSaturation), backgroundColor: ['#ef4444', '#f97316', '#22c55e'] }] },
            options: { scales: { y: { beginAtZero: true } } }
          });
        }
      }

      // 6. Disposition
      if (stats.disposition && Object.keys(stats.disposition).length > 0) {
        const ctx = document.getElementById('dispositionChart');
        if (ctx) {
          window.chartInstances.disposition = new Chart(ctx, {
            type: 'pie',
            data: { labels: Object.keys(stats.disposition), datasets: [{ data: Object.values(stats.disposition), backgroundColor: colors.purple }] }
          });
        }
      }

      // 7. Payment Methods
      if (stats.paymentMethods && Object.keys(stats.paymentMethods).length > 0) {
        const ctx = document.getElementById('paymentMethodChart');
        if (ctx) {
          window.chartInstances.payment = new Chart(ctx, {
            type: 'pie',
            data: { labels: Object.keys(stats.paymentMethods), datasets: [{ data: Object.values(stats.paymentMethods), backgroundColor: colors.mixed }] }
          });
        }
      }

      // 8. Top Lab Tests
      if (stats.labTests && Object.keys(stats.labTests).length > 0) {
        const topLabs = getTopN(stats.labTests, 10);
        const ctx = document.getElementById('labTestsChart');
        if (ctx) {
          window.chartInstances.labs = new Chart(ctx, {
            type: 'bar',
            data: { labels: Object.keys(topLabs), datasets: [{ label: 'Orders', data: Object.values(topLabs), backgroundColor: '#3b82f6' }] },
            options: { indexAxis: 'y', scales: { x: { beginAtZero: true } } }
          });
        }
      }

      // 9. Top Prescriptions
      if (stats.prescriptions && Object.keys(stats.prescriptions).length > 0) {
        const topMeds = getTopN(stats.prescriptions, 10);
        const ctx = document.getElementById('prescriptionsChart');
        if (ctx) {
          window.chartInstances.meds = new Chart(ctx, {
            type: 'bar',
            data: { labels: Object.keys(topMeds), datasets: [{ label: 'Prescriptions', data: Object.values(topMeds), backgroundColor: '#22c55e' }] },
            options: { indexAxis: 'y', scales: { x: { beginAtZero: true } } }
          });
        }
      }

      // 10. Top Counties
      if (stats.counties && Object.keys(stats.counties).length > 0) {
        const topCounties = getTopN(stats.counties, 10);
        const ctx = document.getElementById('countiesChart');
        if (ctx) {
          window.chartInstances.counties = new Chart(ctx, {
            type: 'bar',
            data: { labels: Object.keys(topCounties), datasets: [{ label: 'Patients', data: Object.values(topCounties), backgroundColor: '#a855f7' }] },
            options: { indexAxis: 'y', scales: { x: { beginAtZero: true } } }
          });
        }
      }

      // Update summary cards
      document.getElementById('total-patients').innerText = Object.values(stats.gender || {}).reduce((a, b) => a + b, 0);
      document.getElementById('total-visits').innerText = Object.values(stats.disposition || {}).reduce((a, b) => a + b, 0);
      document.getElementById('total-labs').innerText = Object.values(stats.labTests || {}).reduce((a, b) => a + b, 0);
      document.getElementById('total-payments').innerText = Object.values(stats.paymentMethods || {}).reduce((a, b) => a + b, 0);
    }






    function getTopN(obj, n) {
      return Object.entries(obj).sort((a, b) => b[1] - a[1]).slice(0, n).reduce((acc, [key, val]) => ({ ...acc, [key]: val }), {});
    }



    //Testing
    // ========================================
    // FAMILY PLANNING LOGIC
    // ========================================
    function showFPTab(tab) {
      document.getElementById('fp-client-details-section').style.display = tab === 'client-details' ? 'block' : 'none';
      document.getElementById('fp-tracking-section').style.display = tab === 'tracking' ? 'block' : 'none';
      document.getElementById('tab-fp-client').style.background = tab === 'client-details' ? 'var(--primary)' : '#eee';
      document.getElementById('tab-fp-client').style.color = tab === 'client-details' ? 'white' : 'black';
      document.getElementById('tab-fp-tracking').style.background = tab === 'tracking' ? 'var(--primary)' : '#eee';
      document.getElementById('tab-fp-tracking').style.color = tab === 'tracking' ? 'white' : 'black';
      if (tab === 'client-details') {
        loadFPStatistics();
        loadFPWaitingList();
      } else if (tab === 'tracking') {
        window.fpTrackingOffset = 0;
        loadFPTracking(false);
      }
    }
    function handleFPClientSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const btn = form.querySelector('button[type="submit"]');

      const formData = new FormData(form);
      const data = {};
      formData.forEach((value, key) => {
        data[key] = value;
      });

      console.log('Registering FP client:', data);

      btn.innerText = 'Registering...';
      btn.disabled = true;

      google.script.run
        .withFailureHandler(function (error) {
          console.error('Registration error:', error);
          btn.innerText = 'Register Client';
          btn.disabled = false;
          showAlert('Error: ' + error.message, 'Error', '‚ùå');
        })
        .withSuccessHandler(function (response) {
          btn.innerText = 'Register Client';
          btn.disabled = false;

          if (response.success) {
            showAlert('Client registered successfully!\nClient Number: ' + response.clientNumber, 'Success', '‚úÖ');

            // Create client object
            const clientData = {
              client_number: response.clientNumber,
              client_name: data.client_name,
              telephone: data.telephone,
              age: data.age,
              sex: data.sex,
              registration_date: new Date().toISOString()
            };

            // Save to localStorage
            const storedClients = localStorage.getItem('fpClients');
            const clients = storedClients ? JSON.parse(storedClients) : [];
            clients.unshift(clientData); // Add to beginning
            localStorage.setItem('fpClients', JSON.stringify(clients));

            // Add to table
            const tbody = document.querySelector('#fp-clients-table tbody');
            if (tbody.innerHTML.includes('No clients') || tbody.innerHTML.includes('Register a client')) {
              tbody.innerHTML = '';
            }

            const regDate = new Date().toLocaleDateString('en-GB');
            const row = '<tr>' +
              '<td>' + response.clientNumber + '</td>' +
              '<td>' + data.client_name + '</td>' +
              '<td>' + data.telephone + '</td>' +
              '<td>' + data.age + '</td>' +
              '<td>' + data.sex + '</td>' +
              '<td>' + regDate + '</td>' +
              '<td><button class="btn btn-primary" style="padding:0.25rem 0.5rem; font-size:0.8rem;" onclick="openDispenseForm(\'' + response.clientNumber + '\')">Record Service</button></td>' +
              '</tr>';

            tbody.insertAdjacentHTML('afterbegin', row);

            form.reset();
            loadFPStatistics();
          } else {
            showAlert('Error: ' + response.message, 'Error', '‚ùå');
          }
        })
        .registerFPClient(data);
    }


    function loadFPClientsList() {
      const tbody = document.querySelector('#fp-clients-table tbody');

      // Load clients from localStorage
      const storedClients = localStorage.getItem('fpClients');

      if (!storedClients) {
        tbody.innerHTML = '<tr><td colspan="7">No clients registered yet. Register a client above.</td></tr>';
        return;
      }

      const clients = JSON.parse(storedClients);

      if (clients.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7">No clients registered yet. Register a client above.</td></tr>';
        return;
      }

      tbody.innerHTML = '';

      clients.forEach(function (client) {
        const regDate = new Date(client.registration_date).toLocaleDateString('en-GB');

        tbody.innerHTML += '<tr>' +
          '<td>' + client.client_number + '</td>' +
          '<td>' + client.client_name + '</td>' +
          '<td>' + client.telephone + '</td>' +
          '<td>' + client.age + '</td>' +
          '<td>' + client.sex + '</td>' +
          '<td>' + regDate + '</td>' +
          '<td><button class="btn btn-primary" style="padding:0.25rem 0.5rem; font-size:0.8rem;" onclick="openDispenseForm(\'' + client.client_number + '\')">Record Service</button></td>' +
          '</tr>';
      });
    }



    function loadFPTracking(loadMore) {
      // Initialize if not exists
      if (typeof window.fpTrackingOffset === 'undefined') {
        window.fpTrackingOffset = 0;
      }

      const fpTrackingLimit = 10;

      if (!loadMore) {
        window.fpTrackingOffset = 0;
      }

      const tbody = document.querySelector('#fp-tracking-table tbody');
      if (!loadMore) {
        tbody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
      }

      google.script.run
        .withFailureHandler(function (error) {
          console.error('Error loading FP tracking:', error);
          tbody.innerHTML = '<tr><td colspan="7" style="color:red;">Error loading tracking records: ' + error.message + '</td></tr>';
        })
        .withSuccessHandler(function (result) {
          console.log('FP Tracking received:', result);
          console.log('Type:', typeof result);
          console.log('Is null?', result === null);
          console.log('Has records?', result && result.records);

          // Handle null or undefined result
          if (!result) {
            console.error('Result is null or undefined');
            tbody.innerHTML = '<tr><td colspan="7" style="color:red;">Error: No data received from server</td></tr>';
            document.getElementById('load-more-fp').style.display = 'none';
            return;
          }

          // Handle missing records property
          if (!result.records) {
            console.error('Result has no records property:', result);
            tbody.innerHTML = '<tr><td colspan="7" style="color:red;">Error: Invalid data format</td></tr>';
            document.getElementById('load-more-fp').style.display = 'none';
            return;
          }

          if (!loadMore) {
            tbody.innerHTML = '';
          }

          if (result.records.length === 0 && !loadMore) {
            tbody.innerHTML = '<tr><td colspan="7">No active tracking records. Record a service to see clients here.</td></tr>';
            document.getElementById('load-more-fp').style.display = 'none';
            return;
          }

          result.records.forEach(function (record) {
            const dispenseDate = new Date(record.dispense_date).toLocaleDateString('en-GB');
            const returnDate = new Date(record.return_date).toLocaleDateString('en-GB');
            const daysToReturn = record.days_to_return;

            // Determine row color
            let rowColor = '';
            if (daysToReturn > 5) {
              rowColor = '#d4edda'; // Green
            } else if (daysToReturn > 0 && daysToReturn <= 5) {
              rowColor = '#fff3cd'; // Yellow
            } else {
              rowColor = '#f8d7da'; // Red
            }

            // Format counter
            const counter = daysToReturn > 0 ? '+' + daysToReturn + ' days' : daysToReturn + ' days';

            const row = '<tr style="background-color: ' + rowColor + ';">' +
              '<td>' + record.client_number + '</td>' +
              '<td>' + record.client_name + '</td>' +
              '<td>' + record.phone_number + '</td>' +
              '<td>' + record.fp_type + '</td>' +
              '<td>' + dispenseDate + '</td>' +
              '<td>' + returnDate + '</td>' +
              '<td style="font-weight:bold;">' + counter + '</td>' +
              '<td>' +
              '<button class="btn btn-primary" style="padding: 2px 8px; font-size: 0.75rem; margin-right: 4px; min-height: 24px;" onclick="openDispenseFormWithData(\'' + record.client_number + '\', \'' + record.client_name + '\', \'' + record.phone_number + '\')">Dispense</button>' +
              '<button class="btn" style="padding: 2px 8px; font-size: 0.75rem; background:#dc3545; color:white; min-height: 24px;" onclick="archiveClient(\'' + record.tracking_id + '\')">Archive</button>' +
              '</td>' +
              '</tr>';
            tbody.innerHTML += row;
          });

          // Update offset and show/hide Load More button
          window.fpTrackingOffset += result.records.length;
          document.getElementById('load-more-fp').style.display = result.hasMore ? 'inline-block' : 'none';
        })
        .getFPTracking(fpTrackingLimit, window.fpTrackingOffset);
    }














    // test

    function openDispenseForm(clientNumber) {
      console.log('Opening dispense form for client:', clientNumber);

      // Switch to FP Tracking tab first
      showFPTab('tracking');

      setTimeout(function () {
        const dispenseSection = document.getElementById('fp-dispense-section');

        if (!dispenseSection) {
          showAlert('Error: Dispense section not found in the page', 'Error', '‚ùå');
          return;
        }

        dispenseSection.style.display = 'block';

        // Try to get client from localStorage first
        let client = null;
        const storedClients = localStorage.getItem('fpClients');

        if (storedClients) {
          const clients = JSON.parse(storedClients);
          client = clients.find(function (c) { return c.client_number === clientNumber; });
        }

        // If not in localStorage, get from FP Tracking records
        if (!client) {
          const storedTracking = localStorage.getItem('fpTracking');
          if (storedTracking) {
            const trackingRecords = JSON.parse(storedTracking);
            const trackingRecord = trackingRecords.find(function (r) { return r.client_number === clientNumber; });

            if (trackingRecord) {
              client = {
                client_number: trackingRecord.client_number,
                client_name: trackingRecord.client_name,
                telephone: trackingRecord.phone_number
              };
            }
          }
        }

        // If still not found, try to get from the tracking table rows
        if (!client) {
          const trackingRows = document.querySelectorAll('#fp-tracking-table tbody tr');
          trackingRows.forEach(function (row) {
            const cells = row.querySelectorAll('td');
            if (cells.length > 0) {
              const name = cells[0].innerText;
              const phone = cells[1].innerText;

              // Check if this row's buttons contain the clientNumber
              const buttons = row.querySelectorAll('button');
              buttons.forEach(function (btn) {
                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(clientNumber)) {
                  client = {
                    client_number: clientNumber,
                    client_name: name,
                    telephone: phone
                  };
                }
              });
            }
          });
        }

        if (!client) {
          showAlert('Error: Client not found. Client Number: ' + clientNumber, 'Error', '‚ùå');
          dispenseSection.style.display = 'none';
          return;
        }

        // Show the form with client data
        dispenseSection.innerHTML = '<h3>Record FP Service</h3>' +
          '<form id="fp-dispense-form" onsubmit="handleDispenseSubmit(event)">' +
          '<input type="hidden" name="client_number" value="' + client.client_number + '">' +
          '<div class="alert" style="background: #eef5fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">' +
          '<strong>Client:</strong> ' + client.client_name + '<br>' +
          '<strong>Phone:</strong> ' + client.telephone +
          '</div>' +
          '<div class="grid-2">' +
          '<div class="form-group"><label>Name *</label><input type="text" name="client_name" class="form-control" value="' + client.client_name + '" readonly style="background-color: #f0f0f0;"></div>' +
          '<div class="form-group"><label>Phone Number *</label><input type="text" name="phone_number" class="form-control" value="' + client.telephone + '" readonly style="background-color: #f0f0f0;"></div>' +
          '</div>' +
          '<div class="grid-2">' +
          '<div class="form-group"><label>FP Type *</label>' +
          '<select name="fp_type" class="form-control" required>' +
          '<option value="">Select Method...</option>' +
          '<optgroup label="Oral Contraceptives">' +
          '<option value="COC">Combined Oral Contraceptives (COC)</option>' +
          '<option value="POP">Progestin Only Pills (POP)</option>' +
          '</optgroup>' +
          '<optgroup label="Injectables">' +
          '<option value="DMPA-IM">DMPA-IM (Depo)</option>' +
          '<option value="DMPA-SC">DMPA-SC</option>' +
          '</optgroup>' +
          '<optgroup label="Implants">' +
          '<option value="Implanon">Implants (1-rod)</option>' +
          '<option value="Jadelle">Implants (2-rod)</option>' +
          '</optgroup>' +
          '<optgroup label="IUCD">' +
          '<option value="Copper T">IUCD (Copper T)</option>' +
          '<option value="Hormonal IUCD">IUCD (Hormonal)</option>' +
          '</optgroup>' +
          '<optgroup label="Barrier">' +
          '<option value="Male Condoms">Male Condoms</option>' +
          '<option value="Female Condoms">Female Condoms</option>' +
          '</optgroup>' +
          '<optgroup label="Permanent">' +
          '<option value="Tubal Ligation">Tubal Ligation</option>' +
          '<option value="Vasectomy">Vasectomy</option>' +
          '</optgroup>' +
          '<optgroup label="Natural/Other">' +
          '<option value="Cycle Beads">Cycle Beads</option>' +
          '<option value="Emergency Pills">Emergency Pills</option>' +
          '</optgroup>' +
          '</select>' +
          '</div>' +
          '<div class="form-group"><label>Dispense Date *</label><input type="date" name="dispense_date" class="form-control" required></div>' +
          '</div>' +
          '<div class="grid-2">' +
          '<div class="form-group"><label>Dosage</label><input type="text" name="dosage" class="form-control" placeholder="e.g., 1 tablet daily"></div>' +
          '<div class="form-group"><label>Duration (days) *</label><input type="number" name="duration_days" class="form-control" min="1" required></div>' +
          '</div>' +
          '<div class="form-group"><label>Notes</label><textarea name="notes" class="form-control" rows="2"></textarea></div>' +
          '<div class="form-group">' +
          '<button type="submit" class="btn btn-primary">Save Dispense</button>' +
          '<button type="button" onclick="cancelDispense()" class="btn" style="background:#eee; margin-left:0.5rem;">Cancel</button>' +
          '</div>' +
          '</form>';

        dispenseSection.scrollIntoView({ behavior: 'smooth' });
      }, 300);
    }


    function openDispenseFormWithData(clientNumber, clientName, phoneNumber) {
      console.log('Opening dispense form with data:', clientNumber, clientName, phoneNumber);

      // Switch to FP Tracking tab first
      showFPTab('tracking');

      setTimeout(function () {
        const dispenseSection = document.getElementById('fp-dispense-section');

        if (!dispenseSection) {
          showAlert('Error: Dispense section not found in the page', 'Error', '‚ùå');
          return;
        }

        dispenseSection.style.display = 'block';

        // Create client object directly from parameters
        const client = {
          client_number: clientNumber,
          client_name: clientName,
          telephone: phoneNumber
        };

        // Show the form with client data
        dispenseSection.innerHTML = '<h3>Record FP Service</h3>' +
          '<form id="fp-dispense-form" onsubmit="handleDispenseSubmit(event)">' +
          '<input type="hidden" name="client_number" value="' + client.client_number + '">' +
          '<div class="alert" style="background: #eef5fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">' +
          '<strong>Client:</strong> ' + client.client_name + '<br>' +
          '<strong>Phone:</strong> ' + client.telephone +
          '</div>' +
          '<div class="grid-2">' +
          '<div class="form-group"><label>Name *</label><input type="text" name="client_name" class="form-control" value="' + client.client_name + '" readonly style="background-color: #f0f0f0;"></div>' +
          '<div class="form-group"><label>Phone Number *</label><input type="text" name="phone_number" class="form-control" value="' + client.telephone + '" readonly style="background-color: #f0f0f0;"></div>' +
          '</div>' +
          '<div class="grid-2">' +
          '<div class="form-group"><label>FP Type *</label>' +
          '<select name="fp_type" class="form-control" required>' +
          '<option value="">Select Method...</option>' +
          '<optgroup label="Oral Contraceptives">' +
          '<option value="COC">Combined Oral Contraceptives (COC)</option>' +
          '<option value="POP">Progestin Only Pills (POP)</option>' +
          '</optgroup>' +
          '<optgroup label="Injectables">' +
          '<option value="DMPA-IM">DMPA-IM (Depo)</option>' +
          '<option value="DMPA-SC">DMPA-SC</option>' +
          '</optgroup>' +
          '<optgroup label="Implants">' +
          '<option value="Implanon">Implants (1-rod)</option>' +
          '<option value="Jadelle">Implants (2-rod)</option>' +
          '</optgroup>' +
          '<optgroup label="IUCD">' +
          '<option value="Copper T">IUCD (Copper T)</option>' +
          '<option value="Hormonal IUCD">IUCD (Hormonal)</option>' +
          '</optgroup>' +
          '<optgroup label="Barrier">' +
          '<option value="Male Condoms">Male Condoms</option>' +
          '<option value="Female Condoms">Female Condoms</option>' +
          '</optgroup>' +
          '<optgroup label="Permanent">' +
          '<option value="Tubal Ligation">Tubal Ligation</option>' +
          '<option value="Vasectomy">Vasectomy</option>' +
          '</optgroup>' +
          '<optgroup label="Natural/Other">' +
          '<option value="Cycle Beads">Cycle Beads</option>' +
          '<option value="Emergency Pills">Emergency Pills</option>' +
          '</optgroup>' +
          '</select>' +
          '</div>' +
          '<div class="form-group"><label>Dispense Date *</label><input type="date" name="dispense_date" class="form-control" required></div>' +
          '</div>' +
          '<div class="grid-2">' +
          '<div class="form-group"><label>Dosage</label><input type="text" name="dosage" class="form-control" placeholder="e.g., 1 tablet daily"></div>' +
          '<div class="form-group"><label>Duration (days) *</label><input type="number" name="duration_days" class="form-control" min="1" required></div>' +
          '</div>' +
          '<div class="form-group"><label>Notes</label><textarea name="notes" class="form-control" rows="2"></textarea></div>' +
          '<div class="form-group">' +
          '<button type="submit" class="btn btn-primary">Save Dispense</button>' +
          '<button type="button" onclick="cancelDispense()" class="btn" style="background:#eee; margin-left:0.5rem;">Cancel</button>' +
          '</div>' +
          '</form>';

        dispenseSection.scrollIntoView({ behavior: 'smooth' });
      }, 300);
    }










    function handleDispenseSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const btn = form.querySelector('button[type="submit"]');

      const formData = new FormData(form);

      // Get client info from the alert div
      const alertDiv = form.querySelector('.alert');
      const clientName = alertDiv.innerText.split('Client:')[1].split('Phone:')[0].trim();
      const phoneNumber = alertDiv.innerText.split('Phone:')[1].trim();
      const clientNumber = formData.get('client_number');

      const data = {
        client_number: clientNumber,
        encounter_id: formData.get('encounter_id'),
        client_name: clientName,
        phone_number: phoneNumber,
        client_type: formData.get('client_type'),
        first_ever_user: formData.get('first_ever_user'),
        fp_type: formData.get('fp_type'),
        dispense_date: formData.get('dispense_date'),
        dosage: formData.get('dosage'),
        duration_days: formData.get('duration_days'),
        notes: formData.get('notes')
      };

      console.log('Saving dispense:', data);

      btn.innerText = 'Saving...';
      btn.disabled = true;

      google.script.run
        .withFailureHandler(function (error) {
          console.error('Dispense error:', error);
          btn.innerText = 'Save Dispense';
          btn.disabled = false;
          showAlert('Error: ' + error.message, 'Error', '‚ùå');
        })
        .withSuccessHandler(function (response) {
          btn.innerText = 'Save Dispense';
          btn.disabled = false;

          if (response.success) {
            showAlert('FP service recorded successfully!', 'Success', '‚úÖ');

            // Refresh Queue
            loadFPWaitingList();
            cancelDispense();

            // Switch to FP Tracking tab to show the new record? 
            // Maybe stay on waiting list? Stay on waiting list is better workflow usually.
            // But let's show tracking tab as confirmation.
            // showFPTab('tracking'); 
            // Actually, stay on waiting list so they can process next patient.
            document.getElementById('fp-dispense-section').style.display = 'none';

          } else {
            showAlert('Error: ' + response.message, 'Error', '‚ùå');
          }
        })
        .saveFPDispense(data);
    }

    function loadFPWaitingList() {
      const tbody = document.querySelector('#fp-waiting-list-table tbody');
      tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';

      google.script.run
        .withFailureHandler(function (error) {
          tbody.innerHTML = '<tr><td colspan="5" style="color:red;">Error: ' + error.message + '</td></tr>';
        })
        .withSuccessHandler(function (list) {
          tbody.innerHTML = '';
          if (!list || list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">No patients waiting for Family Planning.</td></tr>';
            return;
          }

          list.forEach(function (item) {
            const time = new Date(item.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            // item has encounter_id, patient_id, patient_name, triage_note
            const row = '<tr>' +
              '<td>' + time + '</td>' +
              '<td>' + item.patient_name + '</td>' +
              '<td style="color:' + (item.triage_priority === 'Red' ? 'red' : 'black') + '">' + item.triage_priority + '</td>' +
              '<td>' + item.triage_note + '</td>' +
              '<td><button class="btn btn-primary" style="padding:0.25rem 0.5rem; font-size:0.8rem;" ' +
              'onclick="openDispenseFormFromQueue(\'' + item.patient_id + '\', \'' + item.patient_name + '\', \'' + item.encounter_id + '\', \'' + (item.phone_number || '') + '\')">Record Service</button></td>' +
              '</tr>';
            tbody.innerHTML += row;
          });
        })
        .getFPWaitingList();
    }

    function openDispenseFormFromQueue(clientId, clientName, encounterId, phoneNumber) {
      console.log('Opening FP Form for:', clientName, 'ID:', clientId, 'Phone:', phoneNumber);

      // 1. Reset Form FIRST to clear old inputs
      document.getElementById('fp-dispense-form').reset();

      // Switch to FP Tracking tab
      showFPTab('tracking');

      const dispenseSection = document.getElementById('fp-dispense-section');
      dispenseSection.style.display = 'block';

      // Scroll to it
      dispenseSection.scrollIntoView({ behavior: 'smooth' });

      // 2. Populate Hidden Inputs
      document.getElementById('dispense-client-number').value = clientId;
      document.getElementById('dispense-encounter-id').value = encounterId;

      // 3. Populate Display Fields (Explicitly)
      const nameEl = document.getElementById('dispense-client-name');
      const phoneEl = document.getElementById('dispense-phone');

      nameEl.innerText = ''; // Clear first
      nameEl.innerText = clientName;

      phoneEl.innerText = ''; // Clear first
      phoneEl.innerText = phoneNumber || 'N/A';
    }

























    function cancelDispense() {
      document.getElementById('fp-dispense-section').style.display = 'none';
      const form = document.getElementById('fp-dispense-form');
      if (form) form.reset();
    }
    async function archiveClient(trackingId) {
      const confirmed = await showConfirm(
        'Are you sure you want to archive this client from FP tracking?',
        'Archive Client',
        'üì¶'
      );

      if (!confirmed) {
        return;
      }

      google.script.run
        .withFailureHandler(function (error) {
          showAlert('Error: ' + error.message, 'Error', '‚ùå');
        })
        .withSuccessHandler(function (response) {
          if (response.success) {
            showAlert('‚úì Client archived successfully!', 'Success', '‚úÖ');
            window.fpTrackingOffset = 0;
            loadFPTracking(false);
          } else {
            showAlert('Error: ' + response.message, 'Error', '‚ùå');
          }
        })
        .archiveFPClient(trackingId);
    }
    function loadFPStatistics() {
      google.script.run
        .withFailureHandler(function (error) {
          console.error('Error loading statistics:', error);
        })
        .withSuccessHandler(function (stats) {
          if (!stats) return;

          // Client Type
          document.getElementById('stat-new').innerText = stats.clientType.new;
          document.getElementById('stat-revisit').innerText = stats.clientType.revisit;

          // First Ever User
          document.getElementById('stat-first-yes').innerText = stats.firstEverUser.yes;
          document.getElementById('stat-first-no').innerText = stats.firstEverUser.no;

          // Age Distribution
          document.getElementById('stat-age-under20').innerText = stats.ageDistribution.under20;
          document.getElementById('stat-age-20-29').innerText = stats.ageDistribution.age20_29;
          document.getElementById('stat-age-30-39').innerText = stats.ageDistribution.age30_39;
          document.getElementById('stat-age-40plus').innerText = stats.ageDistribution.age40plus;

          // Sex
          document.getElementById('stat-sex-m').innerText = stats.sex.male;
          document.getElementById('stat-sex-f').innerText = stats.sex.female;
          document.getElementById('stat-sex-i').innerText = stats.sex.intersex;

          // Disability
          document.getElementById('stat-dis-none').innerText = stats.disability.none;
          document.getElementById('stat-dis-visual').innerText = stats.disability.visual;
          document.getElementById('stat-dis-hearing').innerText = stats.disability.hearing;
          document.getElementById('stat-dis-cognitive').innerText = stats.disability.cognitive;
          document.getElementById('stat-dis-others').innerText = stats.disability.others;
        })
        .getFPStatistics();
    }

    // ===== PREMIUM DASHBOARD FUNCTIONS =====

    // Load Dashboard Metrics (Statistics + Live Queues)
    function loadDashboardMetrics() {
      // Load Today's Statistics
      google.script.run
        .withSuccessHandler(function (stats) {
          document.getElementById('stat-registered').textContent = stats.patients_registered;
          document.getElementById('stat-triaged').textContent = stats.patients_triaged;
          document.getElementById('stat-consulted').textContent = stats.consultations_completed;
          document.getElementById('stat-billed').textContent = stats.bills_paid;

          document.getElementById('collection-drugs').textContent = 'KES ' + stats.collections.drugs.toLocaleString();
          document.getElementById('collection-labs').textContent = 'KES ' + stats.collections.lab_tests.toLocaleString();
          document.getElementById('collection-consults').textContent = 'KES ' + stats.collections.consultations.toLocaleString();
          document.getElementById('collection-total').textContent = 'KES ' + stats.collections.total.toLocaleString();
        })
        .withFailureHandler(function (error) {
          console.error('Error loading statistics:', error);
        })
        .getTodayStatistics();

      // Load Live Queue Counts
      loadLiveQueues();

      // Restart datetime updates
      startDateTimeUpdates();
    }

    // Load Live Queue Counts
    function loadLiveQueues() {
      google.script.run
        .withSuccessHandler(function (queues) {
          updateQueueCard('queue-triage', queues.triage);
          updateQueueCard('queue-lab-results', queues.pending_lab_results);
          updateQueueCard('queue-billing', queues.pending_billing);
          updateQueueCard('queue-fp', queues.pending_fp_service);
          updateQueueCard('queue-consultation', queues.waiting_consultation);
          updateQueueCard('queue-lab-orders', queues.pending_lab_orders);
        })
        .withFailureHandler(function (error) {
          console.error('Error loading queue counts:', error);
        })
        .getLiveQueueCounts();
    }

    // Update Queue Card with Animation and Color Coding
    function updateQueueCard(cardId, count) {
      const card = document.getElementById(cardId);
      if (!card) return;

      const countEl = card.querySelector('.queue-count');
      const statusEl = card.querySelector('.queue-status');

      // Animate count change
      countEl.style.transform = 'scale(1.2)';
      setTimeout(() => {
        countEl.textContent = count;
        countEl.style.transform = 'scale(1)';
      }, 150);

      // Determine status and color based on thresholds
      let status, statusText;
      if (count <= 5) {
        status = 'normal';
        statusText = 'Normal';
      } else if (count <= 10) {
        status = 'concerning';
        statusText = 'Concerning';
      } else if (count <= 15) {
        status = 'high-risk';
        statusText = 'High-Risk';
      } else {
        status = 'critical';
        statusText = 'Critical';
      }

      card.setAttribute('data-status', status);
      card.setAttribute('data-count', count);
      statusEl.textContent = statusText;
    }


    // ==================== DATETIME DISPLAY CODE - START ====================
    // IMPORTANT: This variable MUST be declared BEFORE any functions that use it
    var datetimeInterval = null;
    // Update DateTime Display with Seconds
    function updateDateTime() {
      const now = new Date();
      const options = {
        year: 'numeric',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
      };
      const datetimeStr = now.toLocaleString('en-US', options);
      const datetimeEl = document.getElementById('live-datetime');
      if (datetimeEl) {
        datetimeEl.textContent = datetimeStr;
      }
    }
    // Start datetime updates when page loads
    window.addEventListener('DOMContentLoaded', function () {
      updateDateTime(); // Initial call
      // Clear any existing interval
      if (datetimeInterval) {
        clearInterval(datetimeInterval);
      }
      // Start new interval
      datetimeInterval = setInterval(updateDateTime, 1000);
    });
    // ==================== DATETIME DISPLAY CODE - END ====================





    // Initialize datetime updates
    function startDateTimeUpdates() {
      // Clear any existing interval
      if (datetimeInterval) {
        clearInterval(datetimeInterval);
      }
      // Start new interval
      updateDateTime(); // Initial call
      datetimeInterval = setInterval(updateDateTime, 1000);
      console.log('DateTime interval started'); // Debug
    }

    // Start immediately when script loads
    startDateTimeUpdates();

    // ========================================
    // SIMPLE PATIENT SEARCH
    // ========================================

    function doSimpleSearch() {
      console.log('=== doSimpleSearch called ===');

      const input = document.getElementById('simple-search-input');
      const query = input.value.trim();

      if (!query) {
        alert('Please enter a search term');
        return;
      }

      console.log('Searching for:', query);

      const tbody = document.getElementById('simple-results-tbody');
      tbody.innerHTML = '<tr><td colspan="4">Searching...</td></tr>';
      document.getElementById('simple-results').style.display = 'block';

      google.script.run
        .withSuccessHandler(function (patients) {
          console.log('Success! Received:', patients);
          console.log('Type:', typeof patients);
          console.log('Is array:', Array.isArray(patients));

          tbody.innerHTML = '';

          if (!patients || patients.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7">No patients found</td></tr>';
            return;
          }

          console.log('Rendering ' + patients.length + ' patients');

          for (var i = 0; i < patients.length; i++) {
            var p = patients[i];
            var row = tbody.insertRow();
            row.insertCell(0).textContent = p.id;
            row.insertCell(1).textContent = p.name;
            row.insertCell(2).textContent = p.phone;
            row.insertCell(3).textContent = p.gender;
            row.insertCell(4).textContent = p.national_id || 'N/A';
            row.insertCell(5).textContent = p.sha_no || 'N/A';

            // Add View History button
            var actionCell = row.insertCell(6);
            var btn = document.createElement('button');
            btn.textContent = 'View History';
            btn.className = 'btn btn-primary';
            btn.style.cssText = 'padding:0.4rem 0.8rem; font-size:0.85rem;';
            btn.onclick = (function (patientId) {
              return function () {
                viewSimpleHistory(patientId);
              };
            })(p.id);
            actionCell.appendChild(btn);
          }

          console.log('Done rendering');
        })
        .withFailureHandler(function (error) {
          console.error('Error:', error);
          tbody.innerHTML = '<tr><td colspan="4" style="color:red;">Error: ' + error.message + '</td></tr>';
        })
        .simpleSearchPatients(query);
    }

    function viewSimpleHistory(patientId) {
      console.log('Loading history for patient:', patientId);

      // Show modal with loading state
      document.getElementById('patient-history-modal').style.display = 'block';
      document.getElementById('history-patient-name').textContent = 'Loading...';
      document.getElementById('hist-content-visits').innerHTML = '<p>Loading...</p>';

      google.script.run
        .withSuccessHandler(function (response) {
          console.log('History response:', response);

          if (!response || !response.success) {
            alert('Error loading history: ' + (response ? response.message : 'Unknown error'));
            closeHistoryModal();
            return;
          }

          var history = response.history;
          var patient = history.patient;

          // Display patient info
          document.getElementById('history-patient-name').textContent =
            patient.first_name + ' ' + (patient.middle_name || '') + ' ' + patient.last_name;
          document.getElementById('history-pid').textContent = patient.patient_id;
          document.getElementById('history-phone').textContent = patient.phone_number;
          document.getElementById('history-nid').textContent = patient.national_id || 'N/A';

          // Display history data
          displayHistoryVisits(history.visits);
          displayHistoryConsultations(history.consultations);
          displayHistoryLabs(history.lab_results);
          displayHistoryBilling(history.billing);

          // Show visits tab by default
          showHistTab('visits');
        })
        .withFailureHandler(function (error) {
          console.error('Error loading history:', error);
          alert('Error: ' + error.message);
          closeHistoryModal();
        })
        .getPatientHistory(patientId);
    }

    function closeHistoryModal() {
      document.getElementById('patient-history-modal').style.display = 'none';
    }

    function showHistTab(tab) {
      // Hide all content
      document.getElementById('hist-content-visits').style.display = 'none';
      document.getElementById('hist-content-consultations').style.display = 'none';
      document.getElementById('hist-content-labs').style.display = 'none';
      document.getElementById('hist-content-billing').style.display = 'none';

      // Reset all buttons
      document.getElementById('hist-tab-visits').style.background = '#eee';
      document.getElementById('hist-tab-visits').style.color = 'black';
      document.getElementById('hist-tab-consultations').style.background = '#eee';
      document.getElementById('hist-tab-consultations').style.color = 'black';
      document.getElementById('hist-tab-labs').style.background = '#eee';
      document.getElementById('hist-tab-labs').style.color = 'black';
      document.getElementById('hist-tab-billing').style.background = '#eee';
      document.getElementById('hist-tab-billing').style.color = 'black';

      // Show selected tab
      document.getElementById('hist-content-' + tab).style.display = 'block';
      document.getElementById('hist-tab-' + tab).style.background = 'var(--primary)';
      document.getElementById('hist-tab-' + tab).style.color = 'white';
    }

    function displayHistoryVisits(visits) {
      var container = document.getElementById('hist-content-visits');
      container.innerHTML = '';

      if (!visits || visits.length === 0) {
        container.innerHTML = '<p style="color:#999; text-align:center;">No visit history</p>';
        return;
      }

      visits.forEach(function (visit) {
        var div = document.createElement('div');
        div.style.cssText = 'background:#f9f9f9; padding:1rem; margin-bottom:1rem; border-radius:4px; border-left:4px solid #2370b8;';
        div.innerHTML =
          '<h4 style="margin-top:0;">' + new Date(visit.triage_date).toLocaleDateString() + '</h4>' +
          '<p><strong>Complaint:</strong> ' + visit.chief_complaint + '</p>' +
          '<p><strong>Vitals:</strong> BP: ' + visit.blood_pressure + ', Temp: ' + visit.temperature + '¬∞C, Pulse: ' + visit.pulse_rate + '</p>' +
          '<p><strong>Priority:</strong> <span style="color:' + (visit.priority === 'Emergency' ? 'red' : 'green') + ';">' + visit.priority + '</span></p>';
        container.appendChild(div);
      });
    }

    function displayHistoryConsultations(consultations) {
      var container = document.getElementById('hist-content-consultations');
      container.innerHTML = '';

      if (!consultations || consultations.length === 0) {
        container.innerHTML = '<p style="color:#999; text-align:center;">No consultation history</p>';
        return;
      }

      consultations.forEach(function (consult) {
        var div = document.createElement('div');
        div.style.cssText = 'background:#f9f9f9; padding:1rem; margin-bottom:1rem; border-radius:4px; border-left:4px solid #22c55e;';
        div.innerHTML =
          '<h4 style="margin-top:0;">' + new Date(consult.consultation_date).toLocaleDateString() + '</h4>' +
          '<p><strong>Diagnosis:</strong> ' + consult.diagnosis_code + ' - ' + consult.diagnosis_desc + '</p>' +
          '<p><strong>Medications:</strong> ' + (consult.prescribed_medications || 'None') + '</p>' +
          '<p><strong>Treatment Plan:</strong> ' + (consult.treatment_plan || 'N/A') + '</p>';
        container.appendChild(div);
      });
    }

    function displayHistoryLabs(labResults) {
      var container = document.getElementById('hist-content-labs');
      container.innerHTML = '';

      if (!labResults || labResults.length === 0) {
        container.innerHTML = '<p style="color:#999; text-align:center;">No lab results</p>';
        return;
      }

      labResults.forEach(function (lab) {
        var div = document.createElement('div');
        div.style.cssText = 'background:#f9f9f9; padding:1rem; margin-bottom:1rem; border-radius:4px; border-left:4px solid #f97316;';
        div.innerHTML =
          '<h4 style="margin-top:0;">' + lab.test_name + ' - ' + new Date(lab.order_date).toLocaleDateString() + '</h4>' +
          '<p><strong>Status:</strong> ' + lab.status + '</p>' +
          '<p><strong>Result:</strong> ' + (lab.result_value || 'Pending') + ' ' + (lab.result_units || '') + '</p>';
        container.appendChild(div);
      });
    }

    function displayHistoryBilling(billing) {
      var container = document.getElementById('hist-content-billing');
      container.innerHTML = '';

      if (!billing || billing.length === 0) {
        container.innerHTML = '<p style="color:#999; text-align:center;">No billing history</p>';
        return;
      }

      billing.forEach(function (bill) {
        var div = document.createElement('div');
        div.style.cssText = 'background:#f9f9f9; padding:1rem; margin-bottom:1rem; border-radius:4px; border-left:4px solid #eab308;';
        div.innerHTML =
          '<h4 style="margin-top:0;">' + new Date(bill.billing_date).toLocaleDateString() + '</h4>' +
          '<p><strong>Total:</strong> KES ' + bill.total_charge + '</p>' +
          '<p><strong>Paid:</strong> KES ' + bill.amount_paid + '</p>' +
          '<p><strong>Method:</strong> ' + (bill.payment_method || 'N/A') + '</p>';
        container.appendChild(div);
      });
    }

    // ========================================
    // PATIENT HISTORY FUNCTIONS
    // ========================================

    function performPatientSearch() {
      console.log('=== performPatientSearch called ===');

      try {
        const searchType = document.getElementById('search-type').value;
        const searchQuery = document.getElementById('search-query').value.trim();

        console.log('Search type:', searchType);
        console.log('Search query:', searchQuery);

        if (!searchQuery) {
          showAlert('Please enter a search term', 'Warning', '‚ö†Ô∏è');
          return;
        }

        const tbody = document.querySelector('#search-results-table tbody');
        if (!tbody) {
          console.error('search-results-table tbody not found!');
          showAlert('Error: Search results table not found', 'Error', '‚ùå');
          return;
        }

        tbody.innerHTML = '<tr><td colspan="5">Searching...</td></tr>';
        document.getElementById('search-results-section').style.display = 'block';

        console.log('Calling searchPatients backend function...');

        google.script.run
          .withSuccessHandler(function (response) {
            console.log('Search success! Response:', response);
            tbody.innerHTML = '';

            if (!response || !response.success || !response.patients || response.patients.length === 0) {
              tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999;">No patients found</td></tr>';
              return;
            }

            console.log('Found ' + response.count + ' patients');
            console.log('About to render patients...');

            response.patients.forEach(function (patient, index) {
              console.log('Rendering patient ' + (index + 1) + ':', patient);
              const row = document.createElement('tr');
              const fullName = (patient.first_name + ' ' + (patient.middle_name || '') + ' ' + patient.last_name).trim();
              console.log('Full name:', fullName);
              row.innerHTML =
                '<td>' + patient.patient_id + '</td>' +
                '<td>' + fullName + '</td>' +
                '<td>' + patient.gender + '</td>' +
                '<td>' + patient.phone_number + '</td>' +
                '<td><button onclick="viewPatientHistory(\'' + patient.patient_id + '\')" class="btn btn-primary" style="padding:0.4rem 0.8rem; font-size:0.85rem;">View History</button></td>';
              console.log('Row HTML:', row.innerHTML);
              tbody.appendChild(row);
              console.log('Row appended to tbody');
            });

            console.log('Finished rendering. tbody.children.length:', tbody.children.length);
          })
          .withFailureHandler(function (error) {
            console.error('Search failed:', error);
            tbody.innerHTML = '<tr><td colspan="5" style="color:red;">Error: ' + error.message + '</td></tr>';
            showAlert('Search failed: ' + error.message, 'Error', '‚ùå');
          })
          .searchPatients(searchQuery, searchType);
      } catch (error) {
        console.error('Exception in performPatientSearch:', error);
        showAlert('Error: ' + error.message, 'Error', '‚ùå');
      }
    }

    function viewPatientHistory(patientId) {
      console.log('Loading history for patient:', patientId);

      // Show loading state
      document.getElementById('patient-demographics-section').style.display = 'block';
      document.getElementById('medical-history-section').style.display = 'block';

      google.script.run
        .withSuccessHandler(function (response) {
          if (!response || !response.success) {
            showAlert('Error loading patient history: ' + (response ? response.message : 'Unknown error'), 'Error', '‚ùå');
            return;
          }

          const history = response.history;
          const patient = history.patient;

          // Display patient demographics
          document.getElementById('hist-patient-id').textContent = patient.patient_id;
          document.getElementById('hist-national-id').textContent = patient.national_id || 'N/A';
          document.getElementById('hist-sha-no').textContent = patient.sha_no || 'N/A';
          document.getElementById('hist-name').textContent = (patient.first_name + ' ' + (patient.middle_name || '') + ' ' + patient.last_name).trim();
          document.getElementById('hist-gender').textContent = patient.gender;
          document.getElementById('hist-dob').textContent = patient.date_of_birth ? new Date(patient.date_of_birth).toLocaleDateString() : 'N/A';
          document.getElementById('hist-phone').textContent = patient.phone_number;
          document.getElementById('hist-email').textContent = patient.email || 'N/A';
          document.getElementById('hist-county').textContent = patient.county || 'N/A';
          document.getElementById('hist-blood-group').textContent = patient.blood_group || 'N/A';
          document.getElementById('hist-allergies').textContent = patient.known_allergies || 'None';

          // Display visits
          displayVisits(history.visits);

          // Display consultations
          displayConsultations(history.consultations);

          // Display lab results
          displayLabResults(history.lab_results);

          // Display billing
          displayBilling(history.billing);

          // Show visits tab by default
          showHistoryTab('visits');
        })
        .withFailureHandler(function (error) {
          showAlert('Error: ' + error.message, 'Error', '‚ùå');
        })
        .getPatientHistory(patientId);
    }

    function showHistoryTab(tab) {
      // Hide all tabs
      document.getElementById('history-visits').style.display = 'none';
      document.getElementById('history-consultations').style.display = 'none';
      document.getElementById('history-labs').style.display = 'none';
      document.getElementById('history-billing').style.display = 'none';

      // Reset button styles
      document.getElementById('tab-visits').style.background = '#eee';
      document.getElementById('tab-visits').style.color = 'black';
      document.getElementById('tab-consultations').style.background = '#eee';
      document.getElementById('tab-consultations').style.color = 'black';
      document.getElementById('tab-labs').style.background = '#eee';
      document.getElementById('tab-labs').style.color = 'black';
      document.getElementById('tab-billing').style.background = '#eee';
      document.getElementById('tab-billing').style.color = 'black';

      // Show selected tab
      if (tab === 'visits') {
        document.getElementById('history-visits').style.display = 'block';
        document.getElementById('tab-visits').style.background = 'var(--primary)';
        document.getElementById('tab-visits').style.color = 'white';
      } else if (tab === 'consultations') {
        document.getElementById('history-consultations').style.display = 'block';
        document.getElementById('tab-consultations').style.background = 'var(--primary)';
        document.getElementById('tab-consultations').style.color = 'white';
      } else if (tab === 'labs') {
        document.getElementById('history-labs').style.display = 'block';
        document.getElementById('tab-labs').style.background = 'var(--primary)';
        document.getElementById('tab-labs').style.color = 'white';
      } else if (tab === 'billing') {
        document.getElementById('history-billing').style.display = 'block';
        document.getElementById('tab-billing').style.background = 'var(--primary)';
        document.getElementById('tab-billing').style.color = 'white';
      }
    }

    function displayVisits(visits) {
      const container = document.getElementById('visits-list');
      container.innerHTML = '';

      if (!visits || visits.length === 0) {
        container.innerHTML = '<p style="color:#999; text-align:center;">No visit history found</p>';
        return;
      }

      visits.forEach(function (visit) {
        const div = document.createElement('div');
        div.style.cssText = 'background:#f9f9f9; padding:1rem; margin-bottom:1rem; border-radius:4px; border-left:4px solid #2370b8;';
        div.innerHTML =
          '<h4 style="margin-top:0;">' + new Date(visit.triage_date).toLocaleDateString() + '</h4>' +
          '<p><strong>Encounter ID:</strong> ' + visit.encounter_id + '</p>' +
          '<p><strong>Chief Complaint:</strong> ' + visit.chief_complaint + '</p>' +
          '<p><strong>Vitals:</strong> BP: ' + visit.blood_pressure + ', Temp: ' + visit.temperature + ', Pulse: ' + visit.pulse_rate + ', RR: ' + visit.respiratory_rate + '</p>' +
          '<p><strong>Weight:</strong> ' + visit.weight + ' kg, <strong>Height:</strong> ' + visit.height + ' cm</p>' +
          '<p><strong>Priority:</strong> <span style="color:' + (visit.priority === 'Emergency' ? 'red' : visit.priority === 'Urgent' ? 'orange' : 'green') + ';">' + visit.priority + '</span></p>';
        container.appendChild(div);
      });
    }

    function displayConsultations(consultations) {
      const container = document.getElementById('consultations-list');
      container.innerHTML = '';

      if (!consultations || consultations.length === 0) {
        container.innerHTML = '<p style="color:#999; text-align:center;">No consultation history found</p>';
        return;
      }

      consultations.forEach(function (consult) {
        const div = document.createElement('div');
        div.style.cssText = 'background:#f9f9f9; padding:1rem; margin-bottom:1rem; border-radius:4px; border-left:4px solid #22c55e;';
        div.innerHTML =
          '<h4 style="margin-top:0;">' + new Date(consult.consultation_date).toLocaleDateString() + '</h4>' +
          '<p><strong>Treatment ID:</strong> ' + consult.treatment_id + '</p>' +
          '<p><strong>Diagnosis:</strong> ' + consult.diagnosis_code + ' - ' + consult.diagnosis_desc + '</p>' +
          '<p><strong>Medications:</strong> ' + (consult.prescribed_medications || 'None') + '</p>' +
          '<p><strong>Treatment Plan:</strong> ' + (consult.treatment_plan || 'N/A') + '</p>' +
          '<p><strong>Disposition:</strong> ' + (consult.disposition || 'N/A') + '</p>';
        container.appendChild(div);
      });
    }

    function displayLabResults(labResults) {
      const container = document.getElementById('labs-list');
      container.innerHTML = '';

      if (!labResults || labResults.length === 0) {
        container.innerHTML = '<p style="color:#999; text-align:center;">No lab results found</p>';
        return;
      }

      labResults.forEach(function (lab) {
        const div = document.createElement('div');
        const flagColor = lab.abnormal_flag === 'High' ? 'red' : (lab.abnormal_flag === 'Low' ? 'blue' : 'green');
        div.style.cssText = 'background:#f9f9f9; padding:1rem; margin-bottom:1rem; border-radius:4px; border-left:4px solid #f97316;';
        div.innerHTML =
          '<h4 style="margin-top:0;">' + lab.test_name + ' - ' + new Date(lab.order_date).toLocaleDateString() + '</h4>' +
          '<p><strong>Status:</strong> ' + lab.status + '</p>' +
          '<p><strong>Result:</strong> ' + (lab.result_value || 'Pending') + ' ' + (lab.result_units || '') + ' <span style="color:' + flagColor + '; font-weight:bold;">(' + lab.abnormal_flag + ')</span></p>' +
          '<p><strong>Reference Range:</strong> ' + (lab.reference_range || 'N/A') + '</p>' +
          '<p><strong>Description:</strong> ' + (lab.detailed_description || 'N/A') + '</p>';
        container.appendChild(div);
      });
    }

    function displayBilling(billing) {
      const container = document.getElementById('billing-list');
      container.innerHTML = '';

      if (!billing || billing.length === 0) {
        container.innerHTML = '<p style="color:#999; text-align:center;">No billing history found</p>';
        return;
      }

      billing.forEach(function (bill) {
        const div = document.createElement('div');
        div.style.cssText = 'background:#f9f9f9; padding:1rem; margin-bottom:1rem; border-radius:4px; border-left:4px solid #eab308;';
        div.innerHTML =
          '<h4 style="margin-top:0;">' + new Date(bill.billing_date).toLocaleDateString() + '</h4>' +
          '<p><strong>Bill ID:</strong> ' + bill.bill_id + '</p>' +
          '<p><strong>Total Charge:</strong> KES ' + bill.total_charge + '</p>' +
          '<p><strong>Amount Paid:</strong> KES ' + bill.amount_paid + '</p>' +
          '<p><strong>Payment Method:</strong> ' + (bill.payment_method || 'N/A') + '</p>' +
          '<p><strong>Payment Date:</strong> ' + (bill.payment_date ? new Date(bill.payment_date).toLocaleDateString() : 'N/A') + '</p>';
        container.appendChild(div);
      });
    }

    //Testing



    // ==================== LAB INVENTORY FUNCTIONS ====================

    // Tab Switching
    function switchInventoryTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.inventory-tab-content').forEach(el => {
        el.style.display = 'none';
      });

      // Remove active class from all tabs
      document.querySelectorAll('.inventory-tab').forEach(tab => {
        tab.style.borderBottom = '3px solid transparent';
        tab.style.color = 'var(--text-light)';
        tab.classList.remove('active');
      });

      // Show selected tab content
      document.getElementById(tabName + '-tab-content').style.display = 'block';

      // Add active class to selected tab
      const activeTab = document.getElementById('tab-' + tabName);
      activeTab.style.borderBottom = '3px solid var(--primary)';
      activeTab.style.color = 'var(--primary)';
      activeTab.classList.add('active');

      // Load data for the selected tab
      if (tabName === 'purchase') {
        loadInventoryItems();
        loadPurchaseHistory();
        loadExpiryStatistics();
      } else if (tabName === 'usage') {
        loadStockLevels();
        loadUsageHistory();
        loadStockStatistics();
      } else if (tabName === 'test-mapping') {
        loadInventoryItems();
        loadTestMappings();
      }
    }

    // Load inventory items into dropdowns
    function loadInventoryItems() {
      console.log('=== loadInventoryItems called ===');
      google.script.run
        .withSuccessHandler(function (items) {
          console.log('Items received:', items);
          console.log('Items count:', items ? items.length : 0);

          // Add null safety
          if (!items) {
            console.warn('Backend returned null, using empty array');
            items = [];
          }

          const purchaseSelect = document.getElementById('purchase-item-select');
          const mappingSelect = document.getElementById('mapping-item-select');

          if (purchaseSelect) {
            purchaseSelect.innerHTML = '<option value="">-- Select Item --</option>';
            items.forEach(item => {
              purchaseSelect.innerHTML += `<option value="${item.item_id}" data-name="${item.item_name}">${item.item_name} (${item.unit_of_measure})</option>`;
            });
          }

          if (mappingSelect) {
            mappingSelect.innerHTML = '<option value="">-- Select Item --</option>';
            items.forEach(item => {
              mappingSelect.innerHTML += `<option value="${item.item_id}" data-name="${item.item_name}">${item.item_name} (${item.unit_of_measure})</option>`;
            });
          }
        })
        .withFailureHandler(function (error) {
          showAlert('Error', 'Failed to load inventory items: ' + error.message, 'error');
        })
        .getInventoryItems();
    }

    // Update hidden item name fields
    function updatePurchaseItemName() {
      const select = document.getElementById('purchase-item-select');
      const selectedOption = select.options[select.selectedIndex];
      document.getElementById('purchase-item-name').value = selectedOption.getAttribute('data-name') || '';
    }

    function updateMappingItemName() {
      const select = document.getElementById('mapping-item-select');
      const selectedOption = select.options[select.selectedIndex];
      document.getElementById('mapping-item-name').value = selectedOption.getAttribute('data-name') || '';
    }

    // Add New Item
    function handleAddItem(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      const data = Object.fromEntries(formData);

      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success) {
            showAlert('Success', result.message, 'success');
            form.reset();
            loadInventoryItems();
          } else {
            showAlert('Error', result.message, 'error');
          }
        })
        .withFailureHandler(function (error) {
          showAlert('Error', 'Failed to add item: ' + error.message, 'error');
        })
        .addInventoryItem(data);
    }

    // Record Purchase
    function handleRecordPurchase(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      const data = Object.fromEntries(formData);

      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success) {
            showAlert('Success', result.message, 'success');
            form.reset();
            loadPurchaseHistory();
            loadExpiryStatistics();
          } else {
            showAlert('Error', result.message, 'error');
          }
        })
        .withFailureHandler(function (error) {
          showAlert('Error', 'Failed to record purchase: ' + error.message, 'error');
        })
        .recordPurchase(data);
    }

    // Load Purchase History
    let allPurchases = [];
    function loadPurchaseHistory(filters) {
      google.script.run
        .withSuccessHandler(function (purchases) {
          allPurchases = purchases;
          renderPurchaseTable(purchases);
        })
        .withFailureHandler(function (error) {
          showAlert('Error', 'Failed to load purchase history: ' + error.message, 'error');
        })
        .getPurchaseHistory(filters || {});
    }

    function renderPurchaseTable(purchases) {
      const tbody = document.querySelector('#purchase-history-table tbody');
      tbody.innerHTML = '';

      if (!purchases || purchases.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;">No purchase records found</td></tr>';
        return;
      }

      purchases.forEach(p => {
        const statusColor = getExpiryColor(p.expiry_status);
        const row = `
          <tr style="background-color: ${statusColor};">
            <td>${formatDate(p.purchase_date)}</td>
            <td>${p.item_name}</td>
            <td>${p.quantity}</td>
            <td>KES ${p.unit_cost}</td>
            <td>KES ${p.total_cost}</td>
            <td>${p.supplier || 'N/A'}</td>
            <td>${formatDate(p.manufacture_date)}</td>
            <td>${formatDate(p.expiry_date)}</td>
            <td>${p.days_to_expiry}</td>
            <td><strong>${p.expiry_status.toUpperCase()}</strong></td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
    }

    function filterPurchases(status) {
      if (status === 'all') {
        renderPurchaseTable(allPurchases);
      } else {
        const filtered = allPurchases.filter(p => p.expiry_status === status);
        renderPurchaseTable(filtered);
      }
    }

    function getExpiryColor(status) {
      switch (status) {
        case 'green': return 'rgba(34, 197, 94, 0.1)';
        case 'yellow': return 'rgba(234, 179, 8, 0.15)';
        case 'orange': return 'rgba(249, 115, 22, 0.15)';
        case 'expired': return 'rgba(239, 68, 68, 0.15)';
        default: return 'transparent';
      }
    }

    // Load Expiry Statistics
    function loadExpiryStatistics() {
      google.script.run
        .withSuccessHandler(function (stats) {
          document.getElementById('expiry-green').textContent = stats.green + '%';
          document.getElementById('expiry-yellow').textContent = stats.yellow + '%';
          document.getElementById('expiry-orange').textContent = stats.orange + '%';
          document.getElementById('expiry-expired').textContent = stats.expired + '%';
        })
        .withFailureHandler(function (error) {
          console.error('Failed to load expiry statistics:', error);
        })
        .getExpiryStatistics();
    }

    // Load Stock Levels
    let allStockItems = [];
    function loadStockLevels() {
      google.script.run
        .withSuccessHandler(function (items) {
          allStockItems = items;
          renderStockTable(items);
        })
        .withFailureHandler(function (error) {
          showAlert('Error', 'Failed to load stock levels: ' + error.message, 'error');
        })
        .getInventoryItems();
    }

    function renderStockTable(items) {
      const tbody = document.querySelector('#stock-levels-table tbody');
      tbody.innerHTML = '';

      if (!items || items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No inventory items found</td></tr>';
        return;
      }

      items.forEach(item => {
        const statusColor = getStockColor(item.stock_status);
        const row = `
          <tr style="background-color: ${statusColor};">
            <td>${item.item_name}</td>
            <td>${item.current_stock}</td>
            <td>${item.unit_of_measure}</td>
            <td>${item.reorder_level}</td>
            <td>${item.stock_percentage.toFixed(1)}%</td>
            <td><strong>${item.stock_status.toUpperCase()}</strong></td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
    }

    function filterStock(status) {
      if (status === 'all') {
        renderStockTable(allStockItems);
      } else {
        const filtered = allStockItems.filter(item => item.stock_status === status);
        renderStockTable(filtered);
      }
    }

    function getStockColor(status) {
      switch (status) {
        case 'green': return 'rgba(34, 197, 94, 0.1)';
        case 'orange': return 'rgba(249, 115, 22, 0.15)';
        case 'yellow': return 'rgba(234, 179, 8, 0.15)';
        case 'red': return 'rgba(239, 68, 68, 0.15)';
        default: return 'transparent';
      }
    }

    // Load Stock Statistics
    function loadStockStatistics() {
      google.script.run
        .withSuccessHandler(function (stats) {
          document.getElementById('stock-green').textContent = stats.green + '%';
          document.getElementById('stock-orange').textContent = stats.orange + '%';
          document.getElementById('stock-yellow').textContent = stats.yellow + '%';
          document.getElementById('stock-red').textContent = stats.red + '%';
        })
        .withFailureHandler(function (error) {
          console.error('Failed to load stock statistics:', error);
        })
        .getStockStatistics();
    }

    // Load Usage History
    function loadUsageHistory() {
      google.script.run
        .withSuccessHandler(function (usage) {
          const tbody = document.querySelector('#usage-history-table tbody');
          tbody.innerHTML = '';

          if (!usage || usage.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No usage records found</td></tr>';
            return;
          }

          usage.forEach(u => {
            const row = `
              <tr>
                <td>${formatDate(u.usage_date)}</td>
                <td>${u.item_name}</td>
                <td>${u.quantity_used}</td>
                <td>${u.test_name}</td>
                <td>${u.patient_id}</td>
                <td>${u.lab_order_id}</td>
              </tr>
            `;
            tbody.innerHTML += row;
          });
        })
        .withFailureHandler(function (error) {
          showAlert('Error', 'Failed to load usage history: ' + error.message, 'error');
        })
        .getUsageHistory();
    }

    // Add Test Mapping
    function handleAddTestMapping(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      const data = Object.fromEntries(formData);

      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success) {
            showAlert('Success', result.message, 'success');
            form.reset();
            loadTestMappings();
          } else {
            showAlert('Error', result.message, 'error');
          }
        })
        .withFailureHandler(function (error) {
          showAlert('Error', 'Failed to add mapping: ' + error.message, 'error');
        })
        .saveTestItemMapping(data);
    }

    // Load Test Mappings
    function loadTestMappings() {
      google.script.run
        .withSuccessHandler(function (mappings) {
          const tbody = document.querySelector('#test-mappings-table tbody');
          tbody.innerHTML = '';

          if (!mappings || mappings.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No test mappings configured</td></tr>';
            return;
          }

          mappings.forEach(m => {
            const row = `
              <tr>
                <td>${m.test_name}</td>
                <td>${m.item_name}</td>
                <td>${m.quantity_required}</td>
                <td>${formatDate(m.created_date)}</td>
                <td>
                  <button onclick="deleteMapping('${m.mapping_id}')" class="btn" style="width: auto; background: #ef4444; color: white; padding: 0.4rem 0.8rem;">Delete</button>
                </td>
              </tr>
            `;
            tbody.innerHTML += row;
          });
        })
        .withFailureHandler(function (error) {
          showAlert('Error', 'Failed to load test mappings: ' + error.message, 'error');
        })
        .getAllTestMappings();
    }

    // Delete Test Mapping
    function deleteMapping(mappingId) {
      if (!confirm('Are you sure you want to delete this mapping?')) {
        return;
      }

      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success) {
            showAlert('Success', result.message, 'success');
            loadTestMappings();
          } else {
            showAlert('Error', result.message, 'error');
          }
        })
        .withFailureHandler(function (error) {
          showAlert('Error', 'Failed to delete mapping: ' + error.message, 'error');
        })
        .deleteTestItemMapping(mappingId);
    }

    // Delete Purchase Record
    function deletePurchaseRecord(transactionId) {
      if (!confirm('Are you sure you want to delete this purchase record? This action cannot be undone.')) {
        return;
      }

      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success) {
            showAlert('Success', result.message, 'success');
            loadPurchaseHistory();
            loadExpiryStatistics();
          } else {
            showAlert('Error', result.message, 'error');
          }
        })
        .withFailureHandler(function (error) {
          showAlert('Error', 'Failed to delete purchase record: ' + error.message, 'error');
        })
        .deletePurchaseRecord(transactionId);
    }

    // Helper function to format dates
    function formatDate(dateValue) {
      if (!dateValue) return 'N/A';
      const date = new Date(dateValue);
      return date.toLocaleDateString();
    }

    // Default navigation logic if missing
    if (typeof window.navigate !== 'function') {
      window.navigate = function (viewId) {
        document.querySelectorAll('.view').forEach(el => {
          el.style.display = 'none';
          el.classList.remove('active');
        });
        const target = document.getElementById(viewId);
        if (target) {
          target.style.display = 'block';
          target.classList.add('active');
          // Close sidebar on mobile if open
          const sidebar = document.querySelector('.sidebar');
          const overlay = document.getElementById('sidebar-overlay');
          if (sidebar && sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
            if (overlay) overlay.style.display = 'none';
          }
        }
      };
    }

    // Initialize Lab Inventory when navigating to it
    document.addEventListener('DOMContentLoaded', function () {
      const originalNavigate = window.navigate;
      window.navigate = function (viewId) {
        if (originalNavigate && typeof originalNavigate === 'function') {
          originalNavigate(viewId);
        } else {
          // Fallback
          document.querySelectorAll('.view').forEach(el => { el.style.display = 'none'; el.classList.remove('active'); });
          const t = document.getElementById(viewId);
          if (t) { t.style.display = 'block'; t.classList.add('active'); }
        }

        if (viewId === 'lab-inventory') {
          // Load default tab (Purchase)
          switchInventoryTab('purchase');
        }
      };
    });



    // Manual Login Handler
    // --- 2-Step Login Logic ---
    function initiateLogin() {
      const emailInput = document.getElementById('manual-login-email');
      const feedback = document.getElementById('login-feedback');
      const email = emailInput.value.trim();

      if (!email) {
        if (feedback) {
          feedback.textContent = 'Please enter an email address.';
          feedback.style.color = 'red';
        }
        return;
      }

      if (feedback) {
        feedback.textContent = 'Sending verification code...';
        feedback.style.color = '#2370b8';
      }

      // Call Backend to send code
      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success) {
            // Show Step 2
            document.getElementById('login-step-1').style.display = 'none';
            document.getElementById('login-step-2').style.display = 'block';
            if (feedback) feedback.textContent = '';
          } else {
            if (feedback) {
              feedback.textContent = result.message;
              feedback.style.color = 'red';
            }
          }
        })
        .withFailureHandler(function (err) {
          if (feedback) {
            feedback.textContent = 'Error: ' + err.message;
            feedback.style.color = 'red';
          }
        })
        .sendVerificationCode(email);
    }

    function submitVerification() {
      const email = document.getElementById('manual-login-email').value.trim();
      const code = document.getElementById('manual-login-code').value.trim();
      const feedback = document.getElementById('login-feedback');

      if (!code) {
        if (feedback) {
          feedback.textContent = 'Please enter the code.';
          feedback.style.color = 'red';
        }
        return;
      }

      if (feedback) {
        feedback.textContent = 'Verifying code...';
        feedback.style.color = '#2370b8';
      }

      google.script.run
        .withSuccessHandler(function (result) {
          console.log('Login result:', result);
          if (result.success) {
            // Store token efficiently
            localStorage.setItem('authToken', result.token);
            localStorage.setItem('userEmail', email);

            if (feedback) {
              feedback.textContent = '‚úì Verified! Reloading...';
              feedback.style.color = 'green';
            }

            // Reload page to apply permissions
            setTimeout(function () {
              window.top.location.reload();
            }, 1000);
          } else {
            if (feedback) {
              feedback.textContent = result.message;
              feedback.style.color = 'red';
            }
          }
        })
        .withFailureHandler(function (error) {
          if (feedback) {
            feedback.textContent = 'Error: ' + error.message;
            feedback.style.color = 'red';
          }
        })
        .verifyLoginCode(email, code);
    }

    function resetLogin() {
      document.getElementById('login-step-1').style.display = 'block';
      document.getElementById('login-step-2').style.display = 'none';
      document.getElementById('login-feedback').textContent = '';
    }

    // INITIALIZATION
    window.addEventListener('load', function () {
      console.log('App loaded. Initializing modules...');
      loadICD11Codes(); // Load diagnosis codes immediately

      // Attempt to restore session or show login
      const user = localStorage.getItem('userEmail');
      if (user) {
        document.getElementById('user-display').textContent = user;
        showView('dashboard');
      } else {
        // showView('login') - handled by default visibility
      }
    });

  </script>

</body>

</html>